# AIå¹¿å‘Šä»£æŠ•ç³»ç»Ÿ - é¡¹ç›®è§„åˆ™è®°å¿†

> ç‰ˆæœ¬: v2.1
> æ›´æ–°æ—¥æœŸ: 2025-11-11
> ç”¨é€”: AIåŠ©æ‰‹çš„é¡¹ç›®å¼€å‘è§„èŒƒå‚è€ƒ

## ğŸ“‹ é¡¹ç›®åŸºæœ¬ä¿¡æ¯

- **é¡¹ç›®åç§°**: AIå¹¿å‘Šä»£æŠ•ç³»ç»Ÿ
- **æŠ€æœ¯æ ˆ**: FastAPI + Next.js 15 + PostgreSQL + Redis + Supabase
- **æ¶æ„æ¨¡å¼**: å¾®æœåŠ¡æ¶æ„ + å‰åç«¯åˆ†ç¦»
- **è®¤è¯æ–¹å¼**: JWT + Refresh Token
- **æƒé™æ§åˆ¶**: RLS (Row Level Security) + RBAC
- **éƒ¨ç½²æ–¹å¼**: Docker + Docker Compose

## ğŸ­ ç”¨æˆ·è§’è‰²å®šä¹‰

ç³»ç»Ÿæœ‰5ä¸ªæ ¸å¿ƒè§’è‰²ï¼Œæƒé™ä¸¥æ ¼åŒºåˆ†ï¼š

1. **ç®¡ç†å‘˜ (admin)**
   - å…¨éƒ¨æƒé™
   - ç”¨æˆ·ç®¡ç†ã€ç³»ç»Ÿé…ç½®ã€å…¨å±€ç›‘æ§

2. **è´¢åŠ¡ (finance)**
   - å……å€¼å®¡æ‰¹ã€å¯¹è´¦ç®¡ç†ã€è´¢åŠ¡åˆ†æ
   - å¯è®¿é—®æ‰€æœ‰è´¢åŠ¡ç›¸å…³æ•°æ®

3. **æ•°æ®å‘˜ (data_operator)**
   - æ—¥æŠ¥å®¡æ ¸ã€è´¦æˆ·åˆ†é…ã€æ•°æ®å¯¼å…¥
   - è´Ÿè´£æ•°æ®è´¨é‡å’Œå®¡æ ¸

4. **æˆ·ç®¡ (account_manager)**
   - è´¦æˆ·ç”³è¯·ã€çŠ¶æ€æ›´æ–°ã€é£é™©æ§åˆ¶
   - ç®¡ç†å¹¿å‘Šè´¦æˆ·ç”Ÿå‘½å‘¨æœŸ

5. **æŠ•æ‰‹ (media_buyer)**
   - æ—¥æŠ¥æäº¤ã€å……å€¼ç”³è¯·ã€è´¦æˆ·ç›‘æ§
   - æ‰§è¡Œæ—¥å¸¸æŠ•æ”¾ä»»åŠ¡

## ğŸ’» ä»£ç è§„èŒƒ

### Python åç«¯è§„èŒƒ

```python
# 1. å¯¼å…¥é¡ºåº
import os  # æ ‡å‡†åº“
from datetime import datetime  # æ ‡å‡†åº“

from fastapi import APIRouter, Depends  # ç¬¬ä¸‰æ–¹åº“
from sqlalchemy.orm import Session  # ç¬¬ä¸‰æ–¹åº“

from app.core.deps import get_current_user  # æœ¬åœ°å¯¼å…¥
from app.models.user import User  # æœ¬åœ°å¯¼å…¥

# 2. ç±»å‹æ³¨è§£ï¼ˆå¿…é¡»ï¼‰
from typing import Optional, List
from pydantic import BaseModel

def create_user(
    user_data: UserCreate,
    db: Session = Depends(get_db)
) -> UserResponse:
    """å‡½æ•°å¿…é¡»æœ‰ç±»å‹æ³¨è§£å’Œæ–‡æ¡£å­—ç¬¦ä¸²"""
    pass

# 3. APIå“åº”æ ¼å¼ï¼ˆç»Ÿä¸€ï¼‰
{
  "success": true,
  "data": {...},
  "message": "æ“ä½œæˆåŠŸ",
  "code": "SUCCESS",
  "request_id": "uuid",
  "timestamp": "2025-11-11T10:30:00Z"
}

# 4. é”™è¯¯å“åº”æ ¼å¼ï¼ˆç»Ÿä¸€ï¼‰
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "å‚æ•°éªŒè¯å¤±è´¥",
    "details": {...}
  },
  "request_id": "uuid",
  "timestamp": "2025-11-11T10:30:00Z"
}

# 5. æ•°æ®åº“æ¨¡å‹å‘½å
class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

# 6. Pydanticæ¨¡å‹å‘½å
class UserBase(BaseModel):
    username: str
    email: str

class UserCreate(UserBase):
    password: str

class UserResponse(UserBase):
    id: int
    created_at: datetime

    class Config:
        from_attributes = True
```

### TypeScript å‰ç«¯è§„èŒƒ

```typescript
// 1. å¯¼å…¥é¡ºåº
import React from 'react'  // Reactç›¸å…³
import { NextPage } from 'next'  // Next.jsç›¸å…³
import { zodResolver } from '@hookform/resolvers/zod'  // ç¬¬ä¸‰æ–¹åº“
import { useForm } from 'react-hook-form'  // ç¬¬ä¸‰æ–¹åº“

import { Button } from '@/components/ui/button'  # æœ¬åœ°ç»„ä»¶
import { useUserStore } from '@/stores/user'  # æœ¬åœ°store
import { UserCreateSchema } from '@/schemas/user'  # æœ¬åœ°schema

// 2. ç»„ä»¶å®šä¹‰
interface UserListProps {
  projectId: number
  onUserSelect?: (user: User) => void
}

export const UserList: React.FC<UserListProps> = ({
  projectId,
  onUserSelect
}) => {
  // ç»„ä»¶å®ç°
}

// 3. APIè°ƒç”¨è§„èŒƒ
const { data, isLoading, error } = useQuery({
  queryKey: ['users', projectId],
  queryFn: () => userApi.getUsers(projectId),
  staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿ
})

// 4. Mutationè§„èŒƒ
const createUserMutation = useMutation({
  mutationFn: userApi.createUser,
  onSuccess: () => {
    toast.success('ç”¨æˆ·åˆ›å»ºæˆåŠŸ')
    queryClient.invalidateQueries({ queryKey: ['users'] })
  },
  onError: (error) => {
    toast.error(error.message)
  }
})

// 5. çŠ¶æ€ç®¡ç†ï¼ˆZustandï¼‰
interface UserStore {
  users: User[]
  currentUser: User | null
  fetchUsers: () => Promise<void>
  setCurrentUser: (user: User) => void
}

export const useUserStore = create<UserStore>((set, get) => ({
  users: [],
  currentUser: null,
  fetchUsers: async () => {
    try {
      const users = await userApi.getUsers()
      set({ users })
    } catch (error) {
      console.error('Failed to fetch users:', error)
    }
  },
  setCurrentUser: (user) => set({ currentUser: user })
}))
```

## ğŸ”Œ APIå¼€å‘è§„èŒƒ

### 1. è·¯ç”±å®šä¹‰

```python
# router/api_v1/endpoints/users.py
from fastapi import APIRouter, Depends, Query
from app.schemas.user import UserCreate, UserResponse, UserUpdate

router = APIRouter(prefix="/users", tags=["users"])

@router.get("/", response_model=PaginatedResponse[UserResponse])
async def list_users(
    page: int = Query(1, ge=1),
    size: int = Query(20, ge=1, le=100),
    current_user: User = Depends(get_current_user),
    user_service: UserService = Depends(get_user_service)
):
    """è·å–ç”¨æˆ·åˆ—è¡¨"""
    pass

@router.post("/", response_model=Response[UserResponse])
async def create_user(
    user_data: UserCreate,
    current_user: User = Depends(get_current_user),
    user_service: UserService = Depends(get_user_service)
):
    """åˆ›å»ºç”¨æˆ·"""
    pass
```

### 2. æœåŠ¡å±‚è§„èŒƒ

```python
# app/services/user_service.py
from typing import Optional, List
from sqlalchemy.orm import Session

class UserService:
    def __init__(self, db: Session):
        self.db = db

    async def create_user(self, user_data: UserCreate) -> User:
        """åˆ›å»ºç”¨æˆ·"""
        # ä¸šåŠ¡é€»è¾‘éªŒè¯
        if await self.get_user_by_email(user_data.email):
            raise ValueError("é‚®ç®±å·²å­˜åœ¨")

        # åˆ›å»ºç”¨æˆ·
        user = User(**user_data.dict())
        self.db.add(user)
        self.db.commit()
        self.db.refresh(user)

        # è®°å½•å®¡è®¡æ—¥å¿—
        await self.audit_log("CREATE_USER", user.id)

        return user

    async def get_users(
        self,
        page: int = 1,
        size: int = 20
    ) -> PaginatedResult[User]:
        """åˆ†é¡µè·å–ç”¨æˆ·"""
        offset = (page - 1) * size
        query = self.db.query(User)

        total = query.count()
        items = query.offset(offset).limit(size).all()

        return PaginatedResult(
            items=items,
            total=total,
            page=page,
            size=size,
            pages=(total + size - 1) // size
        )
```

### 3. ä¾èµ–æ³¨å…¥è§„èŒƒ

```python
# app/core/deps.py
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer
from sqlalchemy.orm import Session

security = HTTPBearer()

async def get_current_user(
    token: str = Depends(security),
    db: Session = Depends(get_db)
) -> User:
    """è·å–å½“å‰ç”¨æˆ·"""
    try:
        payload = decode_jwt(token.credentials)
        user_id = payload.get("sub")
        if user_id is None:
            raise HTTPException(401, "æ— æ•ˆçš„token")

        user = db.query(User).filter(User.id == user_id).first()
        if user is None:
            raise HTTPException(401, "ç”¨æˆ·ä¸å­˜åœ¨")

        return user
    except JWTError:
        raise HTTPException(401, "tokenéªŒè¯å¤±è´¥")

def require_role(allowed_roles: List[str]):
    """è§’è‰²æƒé™è£…é¥°å™¨"""
    def role_checker(
        current_user: User = Depends(get_current_user)
    ) -> User:
        if current_user.role not in allowed_roles:
            raise HTTPException(403, "æƒé™ä¸è¶³")
        return current_user
    return role_checker
```

## ğŸ—ƒï¸ æ•°æ®åº“è§„èŒƒ

### 1. è¡¨å‘½åè§„èŒƒ

- å¤æ•°å½¢å¼ï¼š`users`, `projects`, `ad_accounts`
- å…³è”è¡¨ï¼š`user_projects`, `account_channels`
- å°å†™+ä¸‹åˆ’çº¿ï¼š`daily_reports`, `reconciliation_records`

### 2. å­—æ®µè§„èŒƒ

```sql
-- ä¸»é”®
id SERIAL PRIMARY KEY

-- æ—¶é—´æˆ³ï¼ˆå¿…é¡»ï¼‰
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()

-- å¤–é”®
project_id INTEGER REFERENCES projects(id) ON DELETE CASCADE
user_id INTEGER REFERENCES users(id) ON DELETE RESTRICT

-- çŠ¶æ€å­—æ®µ
status project_status NOT NULL DEFAULT 'active'

-- å®¡è®¡å­—æ®µ
created_by INTEGER REFERENCES users(id)
updated_by INTEGER REFERENCES users(id)
```

### 3. ç´¢å¼•è§„èŒƒ

```sql
-- å¤–é”®ç´¢å¼•
CREATE INDEX idx_users_tenant_id ON users(tenant_id);

-- å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_users_email ON users(email);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_reports_user_date ON daily_reports(user_id, report_date);

-- éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_active_projects ON projects(id) WHERE status = 'active';
```

### 4. RLSç­–ç•¥æ¨¡æ¿

```sql
-- å¯ç”¨RLS
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;

-- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±ç§Ÿæˆ·çš„æ•°æ®
CREATE POLICY tenant_isolation ON projects
    FOR ALL
    USING (tenant_id = current_setting('app.current_tenant_id')::int);

-- ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰æ•°æ®
CREATE POLICY admin_full_access ON projects
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM users
            WHERE id = current_user_id()
            AND role = 'admin'
        )
    );
```

## ğŸ“ Gitæäº¤è§„èŒƒ

### 1. æäº¤æ¶ˆæ¯æ ¼å¼

```
<type>(<scope>): <subject>

<body>

<footer>
```

### 2. Typeç±»å‹

- `feat`: æ–°åŠŸèƒ½
- `fix`: ä¿®å¤bug
- `docs`: æ–‡æ¡£æ›´æ–°
- `style`: ä»£ç æ ¼å¼è°ƒæ•´
- `refactor`: ä»£ç é‡æ„
- `perf`: æ€§èƒ½ä¼˜åŒ–
- `test`: æµ‹è¯•ç›¸å…³
- `chore`: æ„å»ºå·¥å…·ã€ä¾èµ–æ›´æ–°

### 3. ç¤ºä¾‹

```
feat(api): add user authentication endpoint

- Add JWT authentication middleware
- Implement login and refresh token endpoints
- Add password hashing with bcrypt

Closes #123
```

## ğŸ¨ UI/UXè§„èŒƒ

### 1. ç»„ä»¶ä½¿ç”¨

```typescript
// ä½¿ç”¨shadcn/uiç»„ä»¶
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'

// ä½¿ç”¨ç»Ÿä¸€çš„æ ·å¼ç±»
className="flex items-center justify-between p-4 space-y-4"
className="text-sm text-muted-foreground"
className="rounded-lg border bg-card text-card-foreground shadow-sm"
```

### 2. é¡µé¢å¸ƒå±€

```typescript
// æ ‡å‡†é¡µé¢ç»“æ„
export default function UserListPage() {
  return (
    <div className="container mx-auto py-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-3xl font-bold">ç”¨æˆ·ç®¡ç†</h1>
        <Button>æ–°å»ºç”¨æˆ·</Button>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>ç”¨æˆ·åˆ—è¡¨</CardTitle>
        </CardHeader>
        <CardContent>
          {/* è¡¨æ ¼å†…å®¹ */}
        </CardContent>
      </Card>
    </div>
  )
}
```

## ğŸ§ª æµ‹è¯•è§„èŒƒ

### 1. å•å…ƒæµ‹è¯•

```python
# tests/test_user_service.py
import pytest
from app.services.user_service import UserService

class TestUserService:
    def test_create_user_success(self, db_session):
        """æµ‹è¯•æˆåŠŸåˆ›å»ºç”¨æˆ·"""
        service = UserService(db_session)
        user_data = UserCreate(
            username="testuser",
            email="test@example.com",
            password="password123"
        )

        user = service.create_user(user_data)

        assert user.username == "testuser"
        assert user.email == "test@example.com"
        assert user.id is not None

    def test_create_user_duplicate_email(self, db_session):
        """æµ‹è¯•åˆ›å»ºé‡å¤é‚®ç®±ç”¨æˆ·"""
        # æµ‹è¯•é€»è¾‘
```

### 2. APIæµ‹è¯•

```python
# tests/test_api_users.py
import pytest
from fastapi.testclient import TestClient

def test_create_user(client: TestClient, auth_headers):
    """æµ‹è¯•åˆ›å»ºç”¨æˆ·API"""
    response = client.post(
        "/api/v1/users/",
        json={
            "username": "newuser",
            "email": "new@example.com",
            "password": "password123"
        },
        headers=auth_headers
    )

    assert response.status_code == 200
    data = response.json()
    assert data["success"] is True
    assert data["data"]["username"] == "newuser"
```

## ğŸ“‹ å¼€å‘æ£€æŸ¥æ¸…å•

### æäº¤ä»£ç å‰æ£€æŸ¥

- [ ] ä»£ç é€šè¿‡æ‰€æœ‰å•å…ƒæµ‹è¯•
- [ ] ä»£ç ç¬¦åˆæ ¼å¼åŒ–è§„èŒƒï¼ˆblack/isort/prettierï¼‰
- [ ] æ·»åŠ äº†å¿…è¦çš„é”™è¯¯å¤„ç†
- [ ] æ›´æ–°äº†ç›¸å…³æ–‡æ¡£
- [ ] APIæœ‰é€‚å½“çš„æ—¥å¿—è®°å½•
- [ ] æ•æ„Ÿä¿¡æ¯æ²¡æœ‰ç¡¬ç¼–ç 
- [ ] Gitæäº¤æ¶ˆæ¯ç¬¦åˆè§„èŒƒ

### åŠŸèƒ½å¼€å‘æ£€æŸ¥

- [ ] å®ç°äº†å¿…è¦çš„æƒé™æ§åˆ¶
- [ ] æ·»åŠ äº†è¾“å…¥éªŒè¯
- [ ] è€ƒè™‘äº†å¹¶å‘åœºæ™¯
- [ ] å®ç°äº†å®¡è®¡æ—¥å¿—
- [ ] æ·»åŠ äº†é€‚å½“çš„ç›‘æ§æŒ‡æ ‡
- [ ] é”™è¯¯ä¿¡æ¯ç”¨æˆ·å‹å¥½

## ğŸ”’ å®‰å…¨è§„èŒƒ

### 1. è®¤è¯å®‰å…¨

- JWT tokenæœ‰æ•ˆæœŸä¸º15åˆ†é’Ÿ
- Refresh tokenæœ‰æ•ˆæœŸä¸º7å¤©
- å¯†ç ä½¿ç”¨bcryptåŠ å¯†ï¼Œæœ€å°‘10è½®
- ç™»å½•å¤±è´¥5æ¬¡åé”å®šè´¦æˆ·30åˆ†é’Ÿ

### 2. æ•°æ®å®‰å…¨

- æ‰€æœ‰å¯†ç å­—æ®µå¿…é¡»åŠ å¯†
- æ•æ„Ÿæ•°æ®ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨
- APIå“åº”ä¸åŒ…å«å¯†ç ç­‰æ•æ„Ÿå­—æ®µ
- æ•°æ®åº“è¿æ¥ä½¿ç”¨SSL

### 3. è¾“å…¥éªŒè¯

```python
# ä½¿ç”¨Pydanticè¿›è¡Œä¸¥æ ¼éªŒè¯
class UserCreate(BaseModel):
    username: str = Field(..., min_length=3, max_length=50)
    email: EmailStr
    password: str = Field(..., min_length=8, regex=r"^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)")

    @validator('password')
    def validate_password(cls, v):
        if not any(c.isupper() for c in v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯')
        return v
```

## ğŸš€ æ€§èƒ½è§„èŒƒ

### 1. æ•°æ®åº“æŸ¥è¯¢

- ä½¿ç”¨select_related/preload_relatedå‡å°‘æŸ¥è¯¢æ¬¡æ•°
- å¤§æ•°æ®é‡æŸ¥è¯¢å¿…é¡»åˆ†é¡µ
- ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- é¿å…N+1æŸ¥è¯¢é—®é¢˜

### 2. ç¼“å­˜ç­–ç•¥

```python
# Redisç¼“å­˜ä½¿ç”¨
from app.core.cache import cache

@cache(expire=300)  # 5åˆ†é’Ÿç¼“å­˜
async def get_user_profile(user_id: int) -> UserProfile:
    """è·å–ç”¨æˆ·èµ„æ–™ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
    pass

# ç¼“å­˜å¤±æ•ˆ
await cache.delete(f"user_profile:{user_id}")
```

### 3. APIå“åº”

- åˆ—è¡¨æ¥å£é»˜è®¤åˆ†é¡µï¼Œæ¯é¡µæœ€å¤š100æ¡
- ä½¿ç”¨å¼‚æ­¥å¤„ç†é•¿æ—¶é—´ä»»åŠ¡
- å¤§æ–‡ä»¶ä¸Šä¼ ä½¿ç”¨æµå¼å¤„ç†
- å®ç°è¯·æ±‚é™æµ

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. æ—¥å¿—è§„èŒƒ

```python
import logging
from app.core.logger import logger

logger.info("User created successfully", extra={
    "user_id": user.id,
    "username": user.username,
    "ip_address": request.client.host
})

logger.error("Database connection failed", extra={
    "error": str(e),
    "query": query,
    "params": params
})
```

### 2. ç›‘æ§æŒ‡æ ‡

- APIå“åº”æ—¶é—´ï¼ˆP95 < 500msï¼‰
- é”™è¯¯ç‡ï¼ˆ< 1%ï¼‰
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡
- Redisç¼“å­˜å‘½ä¸­ç‡
- å†…å­˜å’ŒCPUä½¿ç”¨ç‡

---

**é‡è¦æé†’**ï¼š
1. æ‰€æœ‰ä»£ç å¿…é¡»éµå¾ªä¸Šè¿°è§„èŒƒ
2. æäº¤å‰å¿…é¡»é€šè¿‡è‡ªåŠ¨åŒ–æ£€æŸ¥
3. é‡åˆ°ä¸ç¡®å®šçš„åœ°æ–¹åŠæ—¶è¯¢é—®
4. ä¿æŒä»£ç ç®€æ´ã€å¯è¯»ã€å¯ç»´æŠ¤