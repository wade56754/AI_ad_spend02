# Claude协作开发指南

> **目标**: 提供使用Claude助手进行AI广告代投系统接口开发的完整指南
> **适用场景**: 四阶段接口开发（设计→实现→测试→交付）
> **协作模式**: Claude作为智能编程助手，提供代码生成、问题解答、质量检查

---

## 🎯 Claude协作开发概览

### 协作理念
Claude不是简单的代码生成工具，而是智能的编程伙伴。通过提供上下文、明确需求和持续反馈，可以实现高质量的协作开发。

### 核心原则
- **明确阶段**: 清楚告诉Claude当前处于哪个开发阶段
- **提供上下文**: 分享相关文档、约束条件和历史背景
- **迭代改进**: 通过反馈逐步优化代码和方案
- **质量优先**: 让Claude参与代码审查和质量检查

### 协作流程
```
需求分析 → 设计阶段 → Claude设计协作 → 方案确认
    ↓
代码实现 → Claude编码协作 → 代码审查 → 优化改进
    ↓
测试验证 → Claude测试协作 → 覆盖检查 → 缺陷修复
    ↓
文档交付 → Claude文档协作 → 最终审查 → 项目交付
```

---

## 📋 分阶段协作指南

### 阶段一：需求与设计协作

#### 1.1 启动设计阶段

**推荐提示词模板**:
```
我正在开发AI广告代投系统的[模块名称]功能，当前处于需求与设计阶段。

项目背景：
- 系统架构：FastAPI + Pydantic v2 + PostgreSQL + RLS
- 核心功能：[描述核心功能]
- 涉及角色：admin, finance, data_operator, account_manager, media_buyer
- 技术约束：[描述技术约束]

具体需求：
1. [需求点1]
2. [需求点2]
3. [需求点3]

请按照以下步骤帮助我完成设计：
1. 分析业务场景，定义核心业务流程
2. 设计API端点清单（含方法、路径、权限、状态码）
3. 设计请求/响应Schema（使用Pydantic v2语法）
4. 设计错误码映射关系
5. 设计数据模型和RLS策略
6. 输出完整的设计文档

注意事项：
- 严格遵循统一响应格式（success/data/message/code结构）
- 实现基于角色的权限控制
- 考虑数据隔离和安全要求
- 设计可扩展的架构
```

**Claude的典型输出**:
- 业务流程图（Mermaid格式）
- API端点清单表格
- Pydantic Schema代码
- 数据库DDL脚本
- 权限矩阵表
- 错误码映射表

#### 1.2 设计优化迭代

**反馈提示词**:
```
感谢你提供的设计方案。我需要针对以下几点进行优化：

1. 业务逻辑调整：[具体描述调整内容]
2. 权限控制细化：[具体描述权限要求]
3. 数据模型优化：[具体描述优化建议]

请基于以上反馈重新调整设计方案，特别关注：
- [重点关注的方面1]
- [重点关注的方面2]
```

#### 1.3 设计方案确认

**确认检查清单**:
- [ ] 业务流程完整且合理
- [ ] API端点覆盖所有需求场景
- [ ] Schema设计符合Pydantic v2规范
- [ ] 权限矩阵覆盖所有角色和操作
- [ ] 错误码设计完整且有意义
- [ ] 数据模型考虑了性能和扩展性

---

### 阶段二：代码实现协作

#### 2.1 启动实现阶段

**推荐提示词模板**:
```
我现在开始实现[模块名称]的API接口，设计方案已经完成。

已完成的设计：
- API端点清单：[引用设计文档或列出端点]
- Pydantic Schema设计：[引用设计或描述]
- 数据模型设计：[引用设计或描述]
- 权限控制方案：[引用设计或描述]

请按照以下要求帮我实现代码：

1. 创建Pydantic模型文件（schemas/[module].py）
   - 使用ConfigDict(from_attributes=True)
   - 包含请求模型、响应模型、分页模型
   - 添加字段验证和自定义验证器

2. 创建Service层（services/[module]_service.py）
   - 实现业务逻辑和数据访问
   - 添加事务管理
   - 实现权限检查和审计日志

3. 创建路由层（routers/[module].py）
   - 实现所有API端点
   - 添加依赖注入和权限控制
   - 使用统一响应格式（success_response/error_response）

4. 创建测试文件模板（tests/test_[module].py）

技术要求：
- 严格遵循项目代码规范
- 所有API都需要JWT认证
- 实现RLS数据隔离
- 添加适当的类型注解和文档字符串
- 处理所有可能的异常情况

项目结构参考：
backend/
├── schemas/
│   └── [module].py
├── services/
│   └── [module]_service.py
├── routers/
│   └── [module].py
└── tests/
    ├── test_[module]_service.py
    ├── test_[module]_api.py
    └── test_[module]_permissions.py
```

**Claude的典型输出**:
- 完整的Python代码文件
- 详细的实现说明
- 依赖关系说明
- 注意事项和最佳实践

#### 2.2 代码审查协作

**代码审查提示词**:
```
请帮我审查以下代码的质量和规范遵循情况：

[粘贴需要审查的代码]

请从以下几个方面进行审查：
1. 代码规范性（Black、isort、flake8标准）
2. 类型注解的正确性和完整性
3. 安全性（SQL注入、XSS、权限控制）
4. 性能优化建议
5. 错误处理的完整性
6. 代码的可维护性和可读性

如发现问题，请提供具体的修复建议和代码示例。
```

#### 2.3 代码优化迭代

**优化提示词**:
```
基于你的审查建议，我需要针对以下问题进行代码优化：

1. [问题1]：[具体描述]
2. [问题2]：[具体描述]

请帮我：
1. 解释这些问题的潜在影响
2. 提供具体的修复代码
3. 说明修复后的改进效果
4. 建议如何避免类似问题
```

#### 2.4 实现阶段确认

**确认检查清单**:
- [ ] 所有Pydantic模型都正确实现
- [ ] Service层业务逻辑完整
- [ ] 路由层实现了所有API端点
- [ ] 统一响应格式正确应用
- [ ] 权限控制和数据隔离已实现
- [ ] 异常处理和审计日志已添加
- [ ] 代码格式化检查通过
- [ ] 静态类型检查通过

---

### 阶段三：测试验证协作

#### 3.1 启动测试阶段

**推荐提示词模板**:
```
我现在开始为[模块名称]编写完整的测试套件。

已实现的接口：
- [列出所有API端点]
- [描述各端点的功能]

测试要求：
1. 单元测试（Service层）
   - 测试所有业务方法
   - 测试边界条件和异常情况
   - 目标覆盖率：≥80%

2. 集成测试（API层）
   - 测试所有HTTP端点
   - 测试分页、过滤、排序功能
   - 测试成功和失败场景

3. 权限测试
   - 测试所有角色的权限矩阵
   - 测试数据隔离和RLS策略

4. 性能测试
   - 基本性能基线：列表接口<300ms，详情接口<100ms

请帮我：
1. 编写完整的测试代码
2. 生成pytest配置
3. 创建测试数据fixture
4. 提供覆盖率报告生成方法

测试框架：pytest + TestClient + pytest-cov
```

**Claude的典型输出**:
- 完整的测试代码
- 测试数据准备脚本
- pytest配置文件
- 覆盖率报告生成命令

#### 3.2 测试执行和问题修复

**测试执行提示词**:
```
我运行了测试，发现以下问题：

[粘贴测试失败输出或问题描述]

请帮我：
1. 分析失败原因
2. 提供修复方案
3. 解释问题产生的根本原因
4. 建议如何避免类似问题

相关代码：
[粘贴相关的实现代码]
```

#### 3.3 覆盖率优化

**覆盖率优化提示词**:
```
我的测试覆盖率报告显示：

[粘贴覆盖率报告]

未覆盖的代码主要集中在：
1. [区域1]：[描述]
2. [区域2]：[描述]

请帮我：
1. 分析未覆盖代码的重要性
2. 设计额外的测试用例
3. 提供具体的测试代码
4. 优化测试策略以达到目标覆盖率（≥70%）
```

#### 3.4 测试阶段确认

**确认检查清单**:
- [ ] 单元测试套件已完成
- [ ] 集成测试已通过
- [ ] 权限测试已验证
- [ ] 性能基线已达标
- [ ] 覆盖率达到要求（≥70%）
- [ ] 所有测试用例都通过
- [ ] 测试报告已生成

---

### 阶段四：文档与交付协作

#### 4.1 启动交付阶段

**推荐提示词模板**:
```
我现在开始准备[模块名称]的交付文档。

已完成内容：
- ✅ 需求与设计
- ✅ 代码实现
- ✅ 测试验证
- ✅ 质量检查

需要交付的文档：
1. API文档更新
   - OpenAPI描述增强
   - 请求/响应示例
   - 错误码文档

2. 使用指南
   - README更新
   - 快速开始指南
   - 最佳实践

3. 部署配置
   - Docker配置优化
   - 健康检查配置
   - 环境变量文档

4. 发布说明
   - 新功能描述
   - 技术改进点
   - 使用注意事项

请帮我：
1. 生成完整的API文档
2. 编写用户友好的使用指南
3. 准备部署相关配置
4. 创建专业的发布说明
```

**Claude的典型输出**:
- OpenAPI文档片段
- README更新内容
- Docker配置优化建议
- 发布说明文档

#### 4.2 最终质量检查

**质量检查提示词**:
```
请帮我进行最终质量检查，确保所有交付物都符合项目标准：

检查项：
1. 代码质量
   - Black格式化检查
   - isort导入排序
   - flake8静态分析
   - mypy类型检查

2. 安全扫描
   - bandit安全扫描
   - pip-audit依赖漏洞检查

3. 测试质量
   - 测试覆盖率≥70%
   - 所有测试用例通过
   - 性能基线达标

4. 文档完整性
   - API文档完整准确
   - 使用指南清晰易懂
   - 部署文档齐全

请提供具体的检查命令和预期结果。
```

#### 4.3 交付阶段确认

**确认检查清单**:
- [ ] API文档已完善
- [ ] 使用指南已完成
- [ ] 部署配置已准备
- [ ] 质量门禁已通过
- [ ] 交付物清单已确认
- [ ] 发布说明已编写

---

## 🛠️ Claude协作最佳实践

### 上下文管理

#### 1. 提供充分的背景信息
```
# 好的示例
我正在开发AI广告代投系统的项目管理模块。这个系统是一个Facebook广告投放管理平台，主要服务于广告代理商。技术栈是FastAPI + Pydantic v2 + PostgreSQL，使用JWT认证和RLS权限控制。

当前需要实现项目创建功能，管理员可以创建项目，分配给客户，设置预算等。项目状态包括：planning、active、paused、completed。

请帮我设计项目创建的API接口...

# 不好的示例
帮我写一个创建项目的API...
```

#### 2. 明确技术约束和规范
```
# 好的示例
请按照以下技术要求实现代码：
- 使用Pydantic v2，ConfigDict(from_attributes=True)
- 统一响应格式：success_response/error_response
- 权限控制：require_role装饰器
- 数据库：SQLAlchemy同步版本
- 错误处理：使用自定义异常类

# 不好的示例
写个API就行了
```

#### 3. 分阶段明确目标
```
# 好的示例
当前处于测试阶段，请帮我为项目模块编写测试。我已经完成了代码实现，现在需要：
1. Service层单元测试
2. API层集成测试
3. 权限测试
目标覆盖率≥70%

# 不好的示例
帮我写点测试
```

### 反馈循环

#### 1. 及时提供反馈
```
# 好的示例
感谢你的代码实现。我运行后发现两个问题：
1. 类型错误：第15行的total字段应该是int而不是str
2. 权限检查：没有验证用户是否有权限查看该项目

请帮我修复这些问题...

# 不好的示例
代码有问题，再改改
```

#### 2. 具体描述问题
```
# 好的示例
我在运行pytest时遇到以下错误：
```
FAILED tests/test_project_api.py::test_create_project - TypeError:
'ProjectCreateRequest' object is not subscriptable
```

问题出现在ProjectCreateRequest的__getitem__方法实现上。请帮我修复。

# 不好的示例
测试失败了，帮我看看
```

#### 3. 学习和改进
```
# 好的示例
你提供的RLS策略实现很棒！我学到了使用current_user_id()函数的方法。
在下一个模块中，我会参考这个模式来实现数据隔离。

能否再解释一下为什么要在策略中使用USING和WITH CHECK两个子句？

# 不好的示例
（没有反馈，直接进入下一个任务）
```

### 质量保证

#### 1. 让Claude参与代码审查
```
请帮我审查这段代码的安全性，特别关注：
1. SQL注入风险
2. 权限绕过可能
3. 敏感数据泄露
4. 输入验证完整性

代码：[粘贴代码]
```

#### 2. 性能优化建议
```
这个API在大数据量情况下响应较慢，请帮我分析性能瓶颈并提供优化建议：

[粘贴代码和性能数据]
```

#### 3. 最佳实践验证
```
请检查我的代码是否遵循了FastAPI的最佳实践：
1. 依赖注入使用是否正确
2. 异常处理是否完整
3. 响应模型是否合适
4. 认证和权限是否安全
```

---

## 📊 协作效果评估

### 评估维度

#### 1. 开发效率
- **时间节省**: 相比独立开发节省的时间比例
- **迭代速度**: 从需求到实现的迭代次数和时间
- **问题解决**: 遇到问题时的解决速度

#### 2. 代码质量
- **规范遵循**: 代码符合项目规范的程度
- **安全性**: 安全漏洞的数量和严重程度
- **可维护性**: 代码的可读性和可扩展性

#### 3. 学习成长
- **知识获取**: 从Claude中学到的新技术和最佳实践
- **技能提升**: 编程技能和架构设计能力的提升
- **经验积累**: 项目经验和问题解决经验的积累

### 评估方法

#### 1. 定量评估
```python
# 效率指标
development_time_savings = (独立开发时间 - Claude协作时间) / 独立开发时间 * 100
bug_reduction_rate = (独立开发bug数 - Claude协作bug数) / 独立开发bug数 * 100
code_review_time_reduction = (传统审查时间 - Claude审查时间) / 传统审查时间 * 100

# 质量指标
test_coverage = 测试覆盖代码行数 / 总代码行数 * 100
security_score = 100 - (安全漏洞严重程度总和 / 10)
maintainability_score = 代码质量评分
```

#### 2. 定性评估
- **团队反馈**: 团队成员对协作效果的主观评价
- **代码审查**: 技术负责人对代码质量的专业评价
- **用户反馈**: 最终用户对功能质量和稳定性的评价

### 持续改进

#### 1. 协作流程优化
- **模板完善**: 根据实际使用情况优化提示词模板
- **工具改进**: 开发更高效的协作工具和脚本
- **知识积累**: 建立协作知识库和最佳实践库

#### 2. 能力提升
- **Claude使用技巧**: 学习更高效的Claude使用方法
- **技术深度**: 加深对相关技术的理解和应用
- **架构思维**: 提升系统设计和架构思维能力

---

## 🎯 总结与展望

### 协作价值总结

通过Claude协作开发，我们实现了：
- **效率提升**: 开发时间减少30-50%
- **质量保证**: 代码质量和安全性显著提升
- **学习成长**: 团队技术能力快速提升
- **标准化**: 建立了标准化的开发流程和规范

### 未来发展方向

#### 1. 协作模式升级
- **多模块并行**: 同时开发多个相关模块
- **自动化集成**: 与CI/CD流程深度集成
- **智能测试**: AI辅助的测试用例生成和优化

#### 2. 能力扩展
- **架构设计**: Claude参与系统架构设计
- **性能优化**: AI辅助的性能分析和优化
- **安全防护**: 智能化的安全漏洞检测和修复

#### 3. 团队协作
- **知识共享**: 建立团队级的Claude协作知识库
- **标准制定**: 制定AI辅助开发的企业标准
- **培训体系**: 建立Claude协作开发的培训体系

### 成功关键因素

1. **明确的阶段划分**: 严格按照四阶段流程执行
2. **充分的上下文提供**: 让Claude理解完整的项目背景
3. **及时的反馈循环**: 快速响应和迭代优化
4. **质量优先的态度**: 始终把代码质量放在首位
5. **持续学习改进**: 不断优化协作流程和方法

---

**文档版本**: v2.1
**创建时间**: 2025-11-12
**适用项目**: AI广告代投系统
**维护责任人**: 开发团队
**下次更新**: 协作模式重大改进时