name: ðŸ§ª æµ‹è¯•æµæ°´çº¿

on:
  push:
    branches: [ main, develop, test-* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
    - cron: '0 2 * * *'

# çŽ¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  POETRY_VERSION: '1.8.3'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint:
    name: ðŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ å®‰è£…Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}

      - name: ðŸ“¥ å®‰è£…ä¾èµ–
        run: |
          poetry install --with dev
          pip install flake8 black isort mypy

      - name: ðŸ” Flake8æ£€æŸ¥
        run: |
          flake8 backend/ tests/ \
            --count --select=E9,F63,F7,F82 \
            --show-source --statistics \
            --exclude=__pycache__,migrations,.venv,venv

      - name: âš« Blackä»£ç æ ¼å¼æ£€æŸ¥
        run: black --check backend/ tests/

      - name: ðŸ“š isortå¯¼å…¥æŽ’åºæ£€æŸ¥
        run: isort --check-only backend/ tests/

      - name: ðŸ”Ž MyPyç±»åž‹æ£€æŸ¥
        run: mypy backend/ --ignore-missing-imports

  # å•å…ƒæµ‹è¯•
  test-unit:
    name: ðŸ§ª å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: lint

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_ai_ad_spend
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'poetry'

      - name: ðŸ“¦ å®‰è£…Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}

      - name: ðŸ“¥ å®‰è£…ä¾èµ–
        run: |
          poetry install --with dev,test
          pip install -r requirements-test.txt

      - name: ðŸ—„ï¸ è®¾ç½®æµ‹è¯•æ•°æ®åº“
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_ai_ad_spend
          REDIS_URL: redis://localhost:6379/1
        run: |
          # åˆ›å»ºæ•°æ®åº“
          PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE DATABASE test_ai_ad_spend;"

          # è¿è¡Œæ•°æ®åº“è¿ç§»
          alembic upgrade head

      - name: ðŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        env:
          TESTING: true
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_ai_ad_spend
          REDIS_URL: redis://localhost:6379/1
          JWT_SECRET: test_secret_key_for_ci_32_characters
        run: |
          python run_tests.py --type unit --verbose --coverage

      - name: ðŸ“Š ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Š
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ðŸ“¤ ä¸Šä¼ è¦†ç›–çŽ‡åˆ°Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

  # é›†æˆæµ‹è¯•
  test-integration:
    name: ðŸ”— é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: lint

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_ai_ad_spend_integration
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'poetry'

      - name: ðŸ“¦ å®‰è£…Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}

      - name: ðŸ“¥ å®‰è£…ä¾èµ–
        run: |
          poetry install --with dev,test
          pip install -r requirements-test.txt

      - name: ðŸ—„ï¸ è®¾ç½®æµ‹è¯•æ•°æ®åº“
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_ai_ad_spend_integration
          REDIS_URL: redis://localhost:6379/2
        run: |
          # åˆ›å»ºæ•°æ®åº“
          PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE DATABASE test_ai_ad_spend_integration;"

          # è¿è¡Œæ•°æ®åº“è¿ç§»
          alembic upgrade head

      - name: ðŸ”— è¿è¡Œé›†æˆæµ‹è¯•
        env:
          TESTING: true
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_ai_ad_spend_integration
          REDIS_URL: redis://localhost:6379/2
          JWT_SECRET: test_secret_key_for_ci_integration_32_chars
        run: |
          python run_tests.py --type integration --verbose

  # å®‰å…¨æµ‹è¯•
  test-security:
    name: ðŸ”’ å®‰å…¨æµ‹è¯•
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'poetry'

      - name: ðŸ“¦ å®‰è£…Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}

      - name: ðŸ“¥ å®‰è£…ä¾èµ–
        run: |
          poetry install --with dev,test
          pip install -r requirements-test.txt
          pip install bandit safety

      - name: ðŸ”’ Banditå®‰å…¨æ‰«æ
        run: |
          bandit -r backend/ -f json -o bandit-report.json || true

      - name: ðŸ›¡ï¸ Safetyä¾èµ–æ£€æŸ¥
        run: |
          safety check --json --output safety-report.json || true

      - name: ðŸ§ª è¿è¡Œå®‰å…¨æµ‹è¯•
        env:
          TESTING: true
          JWT_SECRET: test_secret_for_security_tests_32_chars
        run: |
          python run_tests.py --type security --verbose

      - name: ðŸ“¤ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 30

  # æ€§èƒ½æµ‹è¯•
  test-performance:
    name: âš¡ æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [test-unit, test-integration]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'poetry'

      - name: ðŸ“¦ å®‰è£…Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}

      - name: ðŸ“¥ å®‰è£…ä¾èµ–
        run: |
          poetry install --with dev,test
          pip install -r requirements-test.txt
          pip install locust

      - name: âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•
        env:
          TESTING: true
          JWT_SECRET: test_secret_for_performance_tests_32_chars
        run: |
          python run_tests.py --type performance --verbose

      - name: ðŸ“Š ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-reports
          path: performance_reports/
          retention-days: 30

  # éƒ¨ç½²å°±ç»ªæ£€æŸ¥
  deploy-ready:
    name: âœ… éƒ¨ç½²å°±ç»ªæ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [test-unit, test-integration, test-security]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
        run: |
          echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œå‡†å¤‡éƒ¨ç½²"

  # æµ‹è¯•æ€»ç»“
  test-summary:
    name: ðŸ“‹ æµ‹è¯•æ€»ç»“
    runs-on: ubuntu-latest
    needs: [lint, test-unit, test-integration, test-security]
    if: always()

    steps:
      - name: ðŸ“‹ ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        run: |
          echo "## ðŸ§ª æµ‹è¯•æµæ°´çº¿æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ä»»åŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” ä»£ç è´¨é‡æ£€æŸ¥ | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª å•å…ƒæµ‹è¯• | ${{ needs.test-unit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— é›†æˆæµ‹è¯• | ${{ needs.test-integration.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ å®‰å…¨æµ‹è¯• | ${{ needs.test-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.lint.result }}" == "success" && "${{ needs.test-unit.result }}" == "success" && "${{ needs.test-integration.result }}" == "success" && "${{ needs.test-security.result }}" == "success" ]]; then
            echo "### âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi