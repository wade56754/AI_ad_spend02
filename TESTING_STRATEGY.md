# æµ‹è¯•ç­–ç•¥æ–‡æ¡£

> **æ–‡æ¡£ç›®çš„**: ä¸ºAIå¹¿å‘Šä»£æŠ•ç³»ç»Ÿæä¾›å…¨é¢çš„æµ‹è¯•ç­–ç•¥å’Œè´¨é‡ä¿è¯æŒ‡å—
> **ç›®æ ‡è¯»è€…**: æµ‹è¯•å·¥ç¨‹å¸ˆã€å¼€å‘å›¢é˜Ÿã€è´¨é‡ä¿è¯å›¢é˜Ÿ
> **æ›´æ–°æ—¥æœŸ**: 2025-11-11
> **ç‰ˆæœ¬**: v1.0

---

## ğŸ“‹ ç›®å½•

1. [æµ‹è¯•æ¶æ„æ¦‚è§ˆ](#1-æµ‹è¯•æ¶æ„æ¦‚è§ˆ)
2. [æµ‹è¯•é‡‘å­—å¡”](#2-æµ‹è¯•é‡‘å­—å¡”)
3. [å•å…ƒæµ‹è¯•](#3-å•å…ƒæµ‹è¯•)
4. [é›†æˆæµ‹è¯•](#4-é›†æˆæµ‹è¯•)
5. [APIæµ‹è¯•](#5-apiæµ‹è¯•)
6. [å‰ç«¯æµ‹è¯•](#6-å‰ç«¯æµ‹è¯•)
7. [ç«¯åˆ°ç«¯æµ‹è¯•](#7-ç«¯åˆ°ç«¯æµ‹è¯•)
8. [æ€§èƒ½æµ‹è¯•](#8-æ€§èƒ½æµ‹è¯•)
9. [å®‰å…¨æµ‹è¯•](#9-å®‰å…¨æµ‹è¯•)
10. [æµ‹è¯•è‡ªåŠ¨åŒ–](#10-æµ‹è¯•è‡ªåŠ¨åŒ–)

---

## 1. æµ‹è¯•æ¶æ„æ¦‚è§ˆ

### 1.1 æµ‹è¯•ç­–ç•¥ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æµ‹è¯•ç­–ç•¥é‡‘å­—å¡”                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                E2Eæµ‹è¯• (5%)                          â”‚   â”‚
â”‚  â”‚           ç”¨æˆ·åœºæ™¯ã€ä¸šåŠ¡æµç¨‹éªŒè¯                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              é›†æˆæµ‹è¯• (25%)                         â”‚   â”‚
â”‚  â”‚        APIæµ‹è¯•ã€æ•°æ®åº“æµ‹è¯•ã€æœåŠ¡é—´äº¤äº’                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              å•å…ƒæµ‹è¯• (70%)                          â”‚   â”‚
â”‚  â”‚        å‡½æ•°çº§æµ‹è¯•ã€ç»„ä»¶æµ‹è¯•ã€é€»è¾‘éªŒè¯                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æµ‹è¯•åˆ†ç±»

| æµ‹è¯•ç±»å‹ | æ¯”ä¾‹ | æ‰§è¡Œé¢‘ç‡ | è´Ÿè´£äºº | å·¥å…· |
|----------|------|----------|--------|------|
| **å•å…ƒæµ‹è¯•** | 70% | æ¯æ¬¡æäº¤ | å¼€å‘è€… | Jest, Pytest |
| **é›†æˆæµ‹è¯•** | 25% | æ¯æ¬¡æ„å»º | æµ‹è¯•å›¢é˜Ÿ | Supertest, TestContainers |
| **E2Eæµ‹è¯•** | 5% | å‘å¸ƒå‰ | QAå›¢é˜Ÿ | Playwright |
| **æ€§èƒ½æµ‹è¯•** | - | å®šæœŸ | æ€§èƒ½å›¢é˜Ÿ | K6, JMeter |
| **å®‰å…¨æµ‹è¯•** | - | å®šæœŸ | å®‰å…¨å›¢é˜Ÿ | OWASP ZAP, Bandit |

### 1.3 æµ‹è¯•ç¯å¢ƒ

| ç¯å¢ƒ | ç”¨é€” | æ•°æ®æ¥æº | æµ‹è¯•ç±»å‹ |
|------|------|----------|----------|
| **æœ¬åœ°å¼€å‘** | å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯• | Mockæ•°æ® | å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯• |
| **æµ‹è¯•ç¯å¢ƒ** | åŠŸèƒ½æµ‹è¯•ã€APIæµ‹è¯• | æµ‹è¯•æ•°æ® | é›†æˆæµ‹è¯•ã€APIæµ‹è¯• |
| **é¢„ç”Ÿäº§ç¯å¢ƒ** | ç«¯åˆ°ç«¯æµ‹è¯•ã€æ€§èƒ½æµ‹è¯• | è„±æ•ç”Ÿäº§æ•°æ® | E2Eæµ‹è¯•ã€æ€§èƒ½æµ‹è¯• |
| **ç”Ÿäº§ç¯å¢ƒ** | ç›‘æ§æµ‹è¯•ã€å¥åº·æ£€æŸ¥ | ç”Ÿäº§æ•°æ® | ç›‘æ§æµ‹è¯• |

---

## 2. æµ‹è¯•é‡‘å­—å¡”

### 2.1 æµ‹è¯•å±‚æ¬¡å®šä¹‰

```python
# tests/conftest.py - æµ‹è¯•é…ç½®
import pytest
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
import tempfile
import os

# æµ‹è¯•æ•°æ®åº“é…ç½®
@pytest.fixture(scope="session")
def test_db():
    """åˆ›å»ºæµ‹è¯•æ•°æ®åº“"""
    # ä½¿ç”¨å†…å­˜æ•°æ®åº“æˆ–ä¸´æ—¶æ–‡ä»¶
    db_fd, db_path = tempfile.mkstemp()

    engine = create_engine(
        f"sqlite:///{db_path}",
        connect_args={"check_same_thread": False}
    )

    TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

    # åˆ›å»ºè¡¨
    Base.metadata.create_all(bind=engine)

    yield TestingSessionLocal

    # æ¸…ç†
    os.close(db_fd)
    os.unlink(db_path)

@pytest.fixture
def db_session(test_db):
    """åˆ›å»ºæ•°æ®åº“ä¼šè¯"""
    session = test_db()
    try:
        yield session
    finally:
        session.close()

@pytest.fixture
def client(db_session):
    """åˆ›å»ºæµ‹è¯•å®¢æˆ·ç«¯"""
    from app.main import app
    from app.database import get_db

    def override_get_db():
        try:
            yield db_session
        finally:
            pass

    app.dependency_overrides[get_db] = override_get_db

    with TestClient(app) as test_client:
        yield test_client

    app.dependency_overrides.clear()
```

### 2.2 æµ‹è¯•æ•°æ®ç®¡ç†

```python
# tests/fixtures/data.py
import pytest
from app.models import User, Project, AdAccount, DailyReport
from app.core.security import get_password_hash
from datetime import datetime, date

@pytest.fixture
def sample_user():
    """ç¤ºä¾‹ç”¨æˆ·æ•°æ®"""
    return User(
        id="test-user-id",
        email="test@example.com",
        hashed_password=get_password_hash("testpassword"),
        name="Test User",
        role="media_buyer",
        is_active=True,
        created_at=datetime.utcnow()
    )

@pytest.fixture
def sample_project():
    """ç¤ºä¾‹é¡¹ç›®æ•°æ®"""
    return Project(
        id="test-project-id",
        name="Test Project",
        description="Test project description",
        client_name="Test Client",
        status="active",
        budget=10000.0,
        created_at=datetime.utcnow(),
        updated_at=datetime.utcnow()
    )

@pytest.fixture
def sample_ad_account():
    """ç¤ºä¾‹å¹¿å‘Šè´¦æˆ·æ•°æ®"""
    return AdAccount(
        id="test-account-id",
        name="Test Ad Account",
        account_id="act_test123",
        platform="facebook",
        status="active",
        daily_budget=100.0,
        project_id="test-project-id",
        assigned_user_id="test-user-id",
        created_at=datetime.utcnow()
    )

@pytest.fixture
def sample_daily_report():
    """ç¤ºä¾‹æ—¥æŠ¥æ•°æ®"""
    return DailyReport(
        id="test-report-id",
        ad_account_id="test-account-id",
        user_id="test-user-id",
        report_date=date.today(),
        spend=50.0,
        impressions=1000,
        clicks=50,
        conversions=5,
        created_at=datetime.utcnow()
    )
```

---

## 3. å•å…ƒæµ‹è¯•

### 3.1 åç«¯å•å…ƒæµ‹è¯•

```python
# tests/unit/test_user_service.py
import pytest
from unittest.mock import Mock, patch
from app.services.user_service import UserService
from app.models import User
from app.schemas import UserCreate

class TestUserService:

    @pytest.fixture
    def user_service(self, db_session):
        """åˆ›å»ºç”¨æˆ·æœåŠ¡å®ä¾‹"""
        return UserService(db_session)

    @pytest.fixture
    def user_create_data(self):
        """ç”¨æˆ·åˆ›å»ºæ•°æ®"""
        return UserCreate(
            email="newuser@example.com",
            password="newpassword123",
            name="New User",
            role="media_buyer"
        )

    def test_create_user_success(self, user_service, user_create_data):
        """æµ‹è¯•æˆåŠŸåˆ›å»ºç”¨æˆ·"""
        # æ‰§è¡Œ
        user = user_service.create_user(user_create_data)

        # éªŒè¯
        assert user.email == user_create_data.email
        assert user.name == user_create_data.name
        assert user.role == user_create_data.role
        assert user.hashed_password is not None
        assert user.hashed_password != user_create_data.password

    def test_create_user_duplicate_email(self, user_service, user_create_data, sample_user):
        """æµ‹è¯•åˆ›å»ºé‡å¤é‚®ç®±ç”¨æˆ·"""
        # æ·»åŠ å·²æœ‰ç”¨æˆ·
        user_service.db.add(sample_user)
        user_service.db.commit()

        # å°è¯•åˆ›å»ºç›¸åŒé‚®ç®±çš„ç”¨æˆ·
        with pytest.raises(ValueError, match="é‚®ç®±å·²å­˜åœ¨"):
            user_service.create_user(user_create_data)

    def test_authenticate_user_success(self, user_service, sample_user):
        """æµ‹è¯•æˆåŠŸè®¤è¯ç”¨æˆ·"""
        # æ·»åŠ ç”¨æˆ·åˆ°æ•°æ®åº“
        user_service.db.add(sample_user)
        user_service.db.commit()

        # æ‰§è¡Œè®¤è¯
        authenticated_user = user_service.authenticate_user(
            sample_user.email,
            "testpassword"
        )

        # éªŒè¯
        assert authenticated_user is not None
        assert authenticated_user.id == sample_user.id

    def test_authenticate_user_wrong_password(self, user_service, sample_user):
        """æµ‹è¯•é”™è¯¯å¯†ç è®¤è¯"""
        # æ·»åŠ ç”¨æˆ·åˆ°æ•°æ®åº“
        user_service.db.add(sample_user)
        user_service.db.commit()

        # æ‰§è¡Œè®¤è¯
        authenticated_user = user_service.authenticate_user(
            sample_user.email,
            "wrongpassword"
        )

        # éªŒè¯
        assert authenticated_user is None

    def test_authenticate_user_not_found(self, user_service):
        """æµ‹è¯•ä¸å­˜åœ¨çš„ç”¨æˆ·è®¤è¯"""
        # æ‰§è¡Œè®¤è¯
        authenticated_user = user_service.authenticate_user(
            "nonexistent@example.com",
            "password"
        )

        # éªŒè¯
        assert authenticated_user is None

    @patch('app.services.user_service.redis_client')
    def test_reset_password_success(self, mock_redis, user_service, sample_user):
        """æµ‹è¯•æˆåŠŸé‡ç½®å¯†ç """
        # æ·»åŠ ç”¨æˆ·åˆ°æ•°æ®åº“
        user_service.db.add(sample_user)
        user_service.db.commit()

        # æ¨¡æ‹ŸRedisæ“ä½œ
        mock_redis.get.return_value = "valid_token"
        mock_redis.delete.return_value = True

        # æ‰§è¡Œå¯†ç é‡ç½®
        result = user_service.reset_password(
            sample_user.email,
            "reset_token",
            "newpassword123"
        )

        # éªŒè¯
        assert result is True
        mock_redis.get.assert_called_once_with(f"reset_token:{sample_user.email}")
        mock_redis.delete.assert_called_once()

    def test_get_user_by_id_success(self, user_service, sample_user):
        """æµ‹è¯•æ ¹æ®IDè·å–ç”¨æˆ·"""
        # æ·»åŠ ç”¨æˆ·åˆ°æ•°æ®åº“
        user_service.db.add(sample_user)
        user_service.db.commit()

        # æ‰§è¡ŒæŸ¥è¯¢
        user = user_service.get_user_by_id(sample_user.id)

        # éªŒè¯
        assert user is not None
        assert user.id == sample_user.id
        assert user.email == sample_user.email

    def test_get_user_by_id_not_found(self, user_service):
        """æµ‹è¯•è·å–ä¸å­˜åœ¨çš„ç”¨æˆ·"""
        # æ‰§è¡ŒæŸ¥è¯¢
        user = user_service.get_user_by_id("nonexistent-id")

        # éªŒè¯
        assert user is None
```

### 3.2 å·¥å…·å‡½æ•°æµ‹è¯•

```python
# tests/unit/test_utils.py
import pytest
from app.utils.format import format_currency, format_percentage
from app.utils.validation import validate_email, validate_phone
from app.utils.date import get_date_range

class TestFormatUtils:

    def test_format_currency_valid(self):
        """æµ‹è¯•æœ‰æ•ˆè´§å¸æ ¼å¼åŒ–"""
        assert format_currency(1234.56) == "Â¥1,234.56"
        assert format_currency(0) == "Â¥0.00"
        assert format_currency(-123.45) == "-Â¥123.45"

    def test_format_currency_none(self):
        """æµ‹è¯•Noneå€¼è´§å¸æ ¼å¼åŒ–"""
        assert format_currency(None) == "Â¥0.00"

    def test_format_percentage_valid(self):
        """æµ‹è¯•æœ‰æ•ˆç™¾åˆ†æ¯”æ ¼å¼åŒ–"""
        assert format_percentage(0.1234) == "12.34%"
        assert format_percentage(1.0) == "100.00%"
        assert format_percentage(0) == "0.00%"

class TestValidationUtils:

    def test_validate_email_valid(self):
        """æµ‹è¯•æœ‰æ•ˆé‚®ç®±éªŒè¯"""
        valid_emails = [
            "test@example.com",
            "user.name@domain.co.uk",
            "user+tag@example.org"
        ]
        for email in valid_emails:
            assert validate_email(email) is True

    def test_validate_email_invalid(self):
        """æµ‹è¯•æ— æ•ˆé‚®ç®±éªŒè¯"""
        invalid_emails = [
            "invalid-email",
            "@example.com",
            "user@",
            "user..name@example.com"
        ]
        for email in invalid_emails:
            assert validate_email(email) is False

    def test_validate_phone_valid(self):
        """æµ‹è¯•æœ‰æ•ˆæ‰‹æœºå·éªŒè¯"""
        valid_phones = [
            "13812345678",
            "15987654321",
            "18612345678"
        ]
        for phone in valid_phones:
            assert validate_phone(phone) is True

    def test_validate_phone_invalid(self):
        """æµ‹è¯•æ— æ•ˆæ‰‹æœºå·éªŒè¯"""
        invalid_phones = [
            "12345678901",
            "1381234567",
            "12812345678",
            "abc12345678"
        ]
        for phone in invalid_phones:
            assert validate_phone(phone) is False

class TestDateUtils:

    def test_get_date_range_this_month(self):
        """æµ‹è¯•è·å–æœ¬æœˆæ—¥æœŸèŒƒå›´"""
        start_date, end_date = get_date_range("this_month")

        assert start_date.day == 1
        assert end_date >= start_date
        assert end_date.day >= start_date.day

    def test_get_date_range_last_month(self):
        """æµ‹è¯•è·å–ä¸Šæœˆæ—¥æœŸèŒƒå›´"""
        start_date, end_date = get_date_range("last_month")

        assert start_date.day == 1
        assert end_date.day >= 28  # è‡³å°‘28å¤©

    def test_get_date_range_custom(self):
        """æµ‹è¯•è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´"""
        start_date, end_date = get_date_range("2024-01-01", "2024-01-31")

        assert start_date.strftime("%Y-%m-%d") == "2024-01-01"
        assert end_date.strftime("%Y-%m-%d") == "2024-01-31"
```

---

## 4. é›†æˆæµ‹è¯•

### 4.1 APIé›†æˆæµ‹è¯•

```python
# tests/integration/test_projects_api.py
import pytest
from fastapi.testclient import TestClient
from app.main import app
from app.core.security import create_access_token

class TestProjectsAPI:

    @pytest.fixture
    def auth_headers(self, sample_user):
        """è®¤è¯å¤´"""
        token = create_access_token(data={"sub": sample_user.id})
        return {"Authorization": f"Bearer {token}"}

    @pytest.fixture
    def sample_project_data(self):
        """ç¤ºä¾‹é¡¹ç›®æ•°æ®"""
        return {
            "name": "Integration Test Project",
            "description": "Test project for integration testing",
            "client_name": "Test Client",
            "budget": 15000.0,
            "start_date": "2024-01-01",
            "end_date": "2024-12-31"
        }

    def test_create_project_success(self, client: TestClient, auth_headers, sample_project_data):
        """æµ‹è¯•æˆåŠŸåˆ›å»ºé¡¹ç›®"""
        response = client.post(
            "/api/projects",
            json=sample_project_data,
            headers=auth_headers
        )

        assert response.status_code == 201
        data = response.json()
        assert data["success"] is True
        assert data["data"]["name"] == sample_project_data["name"]
        assert data["data"]["client_name"] == sample_project_data["client_name"]
        assert "id" in data["data"]

    def test_create_project_unauthorized(self, client: TestClient, sample_project_data):
        """æµ‹è¯•æœªæˆæƒåˆ›å»ºé¡¹ç›®"""
        response = client.post("/api/projects", json=sample_project_data)

        assert response.status_code == 401

    def test_create_project_invalid_data(self, client: TestClient, auth_headers):
        """æµ‹è¯•æ— æ•ˆæ•°æ®åˆ›å»ºé¡¹ç›®"""
        invalid_data = {
            "name": "",  # ç©ºåç§°
            "budget": -1000  # è´Ÿé¢„ç®—
        }

        response = client.post(
            "/api/projects",
            json=invalid_data,
            headers=auth_headers
        )

        assert response.status_code == 422

    def test_get_projects_list(self, client: TestClient, auth_headers, sample_project, db_session):
        """æµ‹è¯•è·å–é¡¹ç›®åˆ—è¡¨"""
        # æ·»åŠ ç¤ºä¾‹é¡¹ç›®
        db_session.add(sample_project)
        db_session.commit()

        response = client.get("/api/projects", headers=auth_headers)

        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True
        assert len(data["data"]) >= 1
        assert any(p["id"] == sample_project.id for p in data["data"])

    def test_get_project_by_id(self, client: TestClient, auth_headers, sample_project, db_session):
        """æµ‹è¯•æ ¹æ®IDè·å–é¡¹ç›®"""
        # æ·»åŠ ç¤ºä¾‹é¡¹ç›®
        db_session.add(sample_project)
        db_session.commit()

        response = client.get(
            f"/api/projects/{sample_project.id}",
            headers=auth_headers
        )

        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True
        assert data["data"]["id"] == sample_project.id
        assert data["data"]["name"] == sample_project.name

    def test_get_project_not_found(self, client: TestClient, auth_headers):
        """æµ‹è¯•è·å–ä¸å­˜åœ¨çš„é¡¹ç›®"""
        response = client.get(
            "/api/projects/nonexistent-id",
            headers=auth_headers
        )

        assert response.status_code == 404

    def test_update_project_success(self, client: TestClient, auth_headers, sample_project, db_session):
        """æµ‹è¯•æˆåŠŸæ›´æ–°é¡¹ç›®"""
        # æ·»åŠ ç¤ºä¾‹é¡¹ç›®
        db_session.add(sample_project)
        db_session.commit()

        update_data = {
            "name": "Updated Project Name",
            "description": "Updated description",
            "budget": 20000.0
        }

        response = client.put(
            f"/api/projects/{sample_project.id}",
            json=update_data,
            headers=auth_headers
        )

        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True
        assert data["data"]["name"] == update_data["name"]
        assert data["data"]["budget"] == update_data["budget"]

    def test_delete_project_success(self, client: TestClient, auth_headers, sample_project, db_session):
        """æµ‹è¯•æˆåŠŸåˆ é™¤é¡¹ç›®"""
        # æ·»åŠ ç¤ºä¾‹é¡¹ç›®
        db_session.add(sample_project)
        db_session.commit()

        response = client.delete(
            f"/api/projects/{sample_project.id}",
            headers=auth_headers
        )

        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True

    def test_delete_project_not_found(self, client: TestClient, auth_headers):
        """æµ‹è¯•åˆ é™¤ä¸å­˜åœ¨çš„é¡¹ç›®"""
        response = client.delete(
            "/api/projects/nonexistent-id",
            headers=auth_headers
        )

        assert response.status_code == 404

    def test_project_statistics(self, client: TestClient, auth_headers, sample_project, db_session):
        """æµ‹è¯•é¡¹ç›®ç»Ÿè®¡"""
        # æ·»åŠ ç¤ºä¾‹é¡¹ç›®
        db_session.add(sample_project)
        db_session.commit()

        response = client.get(
            "/api/projects/statistics",
            headers=auth_headers
        )

        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True
        assert "total_projects" in data["data"]
        assert "active_projects" in data["data"]
        assert "total_budget" in data["data"]
```

### 4.2 æ•°æ®åº“é›†æˆæµ‹è¯•

```python
# tests/integration/test_database.py
import pytest
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from app.models import Base, User, Project, AdAccount
from app.services.project_service import ProjectService

class TestDatabaseIntegration:

    @pytest.fixture
    def engine(self):
        """åˆ›å»ºæµ‹è¯•æ•°æ®åº“å¼•æ“"""
        engine = create_engine(
            "sqlite:///:memory:",
            connect_args={"check_same_thread": False}
        )
        Base.metadata.create_all(bind=engine)
        yield engine
        Base.metadata.drop_all(bind=engine)

    @pytest.fixture
    def db_session(self, engine):
        """åˆ›å»ºæ•°æ®åº“ä¼šè¯"""
        SessionLocal = sessionmaker(bind=engine)
        session = SessionLocal()
        try:
            yield session
        finally:
            session.close()

    def test_foreign_key_constraints(self, db_session, sample_user, sample_project):
        """æµ‹è¯•å¤–é”®çº¦æŸ"""
        # æ·»åŠ ç”¨æˆ·å’Œé¡¹ç›®
        db_session.add(sample_user)
        db_session.add(sample_project)
        db_session.commit()

        # åˆ›å»ºå…³è”çš„å¹¿å‘Šè´¦æˆ·
        ad_account = AdAccount(
            name="Test Account",
            account_id="act_test123",
            platform="facebook",
            project_id=sample_project.id,  # æœ‰æ•ˆçš„å¤–é”®
            assigned_user_id=sample_user.id  # æœ‰æ•ˆçš„å¤–é”®
        )

        db_session.add(ad_account)
        db_session.commit()

        # éªŒè¯å…³è”å…³ç³»
        retrieved_account = db_session.query(AdAccount).first()
        assert retrieved_account.project_id == sample_project.id
        assert retrieved_account.assigned_user_id == sample_user.id

    def test_cascade_delete(self, db_session, sample_project, sample_ad_account):
        """æµ‹è¯•çº§è”åˆ é™¤"""
        # æ·»åŠ é¡¹ç›®å’Œå¹¿å‘Šè´¦æˆ·
        db_session.add(sample_project)
        db_session.add(sample_ad_account)
        db_session.commit()

        # åˆ é™¤é¡¹ç›®
        db_session.delete(sample_project)
        db_session.commit()

        # éªŒè¯å…³è”çš„å¹¿å‘Šè´¦æˆ·ä¹Ÿè¢«åˆ é™¤
        remaining_accounts = db_session.query(AdAccount).filter(
            AdAccount.project_id == sample_project.id
        ).all()

        assert len(remaining_accounts) == 0

    def test_transaction_rollback(self, db_session, sample_user):
        """æµ‹è¯•äº‹åŠ¡å›æ»š"""
        try:
            # å¼€å§‹äº‹åŠ¡
            user = User(
                email="rollback@test.com",
                hashed_password="password",
                name="Rollback User"
            )
            db_session.add(user)
            db_session.flush()  # ä¸æäº¤ï¼Œåªåˆ·æ–°

            # æ¨¡æ‹Ÿé”™è¯¯
            raise Exception("æ¨¡æ‹Ÿé”™è¯¯")

        except Exception:
            # å›æ»šäº‹åŠ¡
            db_session.rollback()

        # éªŒè¯ç”¨æˆ·æ²¡æœ‰è¢«ä¿å­˜
        saved_user = db_session.query(User).filter(
            User.email == "rollback@test.com"
        ).first()

        assert saved_user is None

    def test_database_indexes(self, db_session, sample_user):
        """æµ‹è¯•æ•°æ®åº“ç´¢å¼•"""
        # æ·»åŠ ç”¨æˆ·
        db_session.add(sample_user)
        db_session.commit()

        # æµ‹è¯•æŸ¥è¯¢æ€§èƒ½
        import time
        start_time = time.time()

        user = db_session.query(User).filter(
            User.email == sample_user.email
        ).first()

        end_time = time.time()
        query_time = end_time - start_time

        # éªŒè¯æŸ¥è¯¢å¾ˆå¿«ï¼ˆåº”è¯¥ä½¿ç”¨ç´¢å¼•ï¼‰
        assert query_time < 0.01  # 10mså†…å®Œæˆ
        assert user is not None
        assert user.email == sample_user.email
```

---

## 5. APIæµ‹è¯•

### 5.1 APIæµ‹è¯•æ¡†æ¶

```python
# tests/api/test_api_framework.py
import pytest
import requests
from typing import Dict, Any, Optional

class APIClient:
    """APIæµ‹è¯•å®¢æˆ·ç«¯"""

    def __init__(self, base_url: str):
        self.base_url = base_url
        self.session = requests.Session()
        self.token: Optional[str] = None

    def login(self, email: str, password: str) -> bool:
        """ç™»å½•è·å–token"""
        response = self.session.post(
            f"{self.base_url}/api/auth/login",
            json={"email": email, "password": password}
        )

        if response.status_code == 200:
            data = response.json()
            self.token = data["data"]["access_token"]
            self.session.headers.update({
                "Authorization": f"Bearer {self.token}"
            })
            return True
        return False

    def get(self, endpoint: str, params: Dict[str, Any] = None) -> requests.Response:
        """GETè¯·æ±‚"""
        return self.session.get(f"{self.base_url}{endpoint}", params=params)

    def post(self, endpoint: str, data: Dict[str, Any] = None) -> requests.Response:
        """POSTè¯·æ±‚"""
        return self.session.post(f"{self.base_url}{endpoint}", json=data)

    def put(self, endpoint: str, data: Dict[str, Any] = None) -> requests.Response:
        """PUTè¯·æ±‚"""
        return self.session.put(f"{self.base_url}{endpoint}", json=data)

    def delete(self, endpoint: str) -> requests.Response:
        """DELETEè¯·æ±‚"""
        return self.session.delete(f"{self.base_url}{endpoint}")

@pytest.fixture
def api_client():
    """APIæµ‹è¯•å®¢æˆ·ç«¯fixture"""
    return APIClient("http://localhost:8000")

class TestAPIFramework:

    def test_api_health_check(self, api_client):
        """æµ‹è¯•APIå¥åº·æ£€æŸ¥"""
        response = api_client.get("/health")

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "healthy"
        assert "timestamp" in data
        assert "services" in data

    def test_api_authentication(self, api_client):
        """æµ‹è¯•APIè®¤è¯"""
        # æœªè®¤è¯è¯·æ±‚
        response = api_client.get("/api/users/profile")
        assert response.status_code == 401

        # ç™»å½•
        login_success = api_client.login("test@example.com", "testpassword")
        assert login_success is True

        # è®¤è¯åçš„è¯·æ±‚
        response = api_client.get("/api/users/profile")
        assert response.status_code == 200
```

### 5.2 APIå¥‘çº¦æµ‹è¯•

```python
# tests/api/test_contract.py
import pytest
import jsonschema
from jsonschema import validate

class TestAPIContract:

    # APIå“åº”schemaå®šä¹‰
    project_schema = {
        "type": "object",
        "properties": {
            "success": {"type": "boolean"},
            "data": {
                "type": "object",
                "properties": {
                    "id": {"type": "string"},
                    "name": {"type": "string"},
                    "description": {"type": "string"},
                    "client_name": {"type": "string"},
                    "status": {"type": "string"},
                    "budget": {"type": "number"},
                    "created_at": {"type": "string"},
                    "updated_at": {"type": "string"}
                },
                "required": ["id", "name", "client_name", "status", "budget"]
            },
            "message": {"type": "string"}
        },
        "required": ["success", "data"]
    }

    error_schema = {
        "type": "object",
        "properties": {
            "success": {"type": "boolean"},
            "message": {"type": "string"},
            "code": {"type": "string"},
            "errors": {"type": "array"}
        },
        "required": ["success", "message"]
    }

    def test_create_project_contract(self, api_client):
        """æµ‹è¯•åˆ›å»ºé¡¹ç›®APIå¥‘çº¦"""
        # ç™»å½•
        api_client.login("test@example.com", "testpassword")

        # åˆ›å»ºé¡¹ç›®
        project_data = {
            "name": "Contract Test Project",
            "description": "Test project for contract testing",
            "client_name": "Test Client",
            "budget": 10000.0
        }

        response = api_client.post("/api/projects", data=project_data)

        assert response.status_code == 201

        # éªŒè¯å“åº”schema
        response_data = response.json()
        validate(instance=response_data, schema=self.project_schema)

        # éªŒè¯å…·ä½“å­—æ®µ
        assert response_data["success"] is True
        assert response_data["data"]["name"] == project_data["name"]
        assert response_data["data"]["client_name"] == project_data["client_name"]
        assert response_data["data"]["budget"] == project_data["budget"]

    def test_error_response_contract(self, api_client):
        """æµ‹è¯•é”™è¯¯å“åº”APIå¥‘çº¦"""
        # å‘é€æ— æ•ˆæ•°æ®
        invalid_data = {
            "name": "",  # ç©ºåç§°
            "budget": "invalid"  # æ— æ•ˆé¢„ç®—
        }

        response = api_client.post("/api/projects", data=invalid_data)

        assert response.status_code == 422

        # éªŒè¯é”™è¯¯å“åº”schema
        response_data = response.json()
        validate(instance=response_data, schema=self.error_schema)

        # éªŒè¯é”™è¯¯å­—æ®µ
        assert response_data["success"] is False
        assert "errors" in response_data
        assert len(response_data["errors"]) > 0

    def test_pagination_contract(self, api_client):
        """æµ‹è¯•åˆ†é¡µAPIå¥‘çº¦"""
        # ç™»å½•
        api_client.login("test@example.com", "testpassword")

        # è·å–é¡¹ç›®åˆ—è¡¨
        response = api_client.get("/api/projects?page=1&size=10")

        assert response.status_code == 200

        # éªŒè¯åˆ†é¡µå“åº”
        data = response.json()
        assert "pagination" in data

        pagination = data["pagination"]
        assert "page" in pagination
        assert "size" in pagination
        assert "total" in pagination
        assert "pages" in pagination

        assert pagination["page"] == 1
        assert pagination["size"] == 10
        assert pagination["total"] >= 0
```

---

## 6. å‰ç«¯æµ‹è¯•

### 6.1 ç»„ä»¶å•å…ƒæµ‹è¯•

```typescript
// tests/components/ProjectCard.test.tsx
import React from 'react'
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { ProjectCard } from '@/components/projects/ProjectCard'
import { Project } from '@/types/project'

// Mocké¡¹ç›®æ•°æ®
const mockProject: Project = {
  id: '1',
  name: 'Test Project',
  description: 'Test Description',
  client_name: 'Test Client',
  status: 'active',
  budget: 10000,
  start_date: '2024-01-01',
  end_date: '2024-12-31',
  created_at: '2024-01-01T00:00:00Z',
  updated_at: '2024-01-01T00:00:00Z'
}

// æµ‹è¯•åŒ…è£…å™¨
const createTestWrapper = () => {
  const queryClient = new QueryClient({
    defaultOptions: {
      queries: { retry: false },
      mutations: { retry: false },
    },
  })

  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  )
}

describe('ProjectCard', () => {
  it('renders project information correctly', () => {
    const Wrapper = createTestWrapper()

    render(
      <Wrapper>
        <ProjectCard project={mockProject} />
      </Wrapper>
    )

    expect(screen.getByText('Test Project')).toBeInTheDocument()
    expect(screen.getByText('Test Description')).toBeInTheDocument()
    expect(screen.getByText('Test Client')).toBeInTheDocument()
    expect(screen.getByText('Â¥10,000')).toBeInTheDocument()
  })

  it('displays correct status badge', () => {
    const Wrapper = createTestWrapper()

    render(
      <Wrapper>
        <ProjectCard project={mockProject} />
      </Wrapper>
    )

    const statusBadge = screen.getByText('active')
    expect(statusBadge).toBeInTheDocument()
    expect(statusBadge).toHaveClass('bg-green-100')
  })

  it('calls onEdit when edit button is clicked', () => {
    const onEdit = jest.fn()
    const Wrapper = createTestWrapper()

    render(
      <Wrapper>
        <ProjectCard project={mockProject} onEdit={onEdit} />
      </Wrapper>
    )

    const editButton = screen.getByRole('button', { name: /edit/i })
    fireEvent.click(editButton)

    expect(onEdit).toHaveBeenCalledWith(mockProject)
  })

  it('calls onDelete when delete button is clicked', () => {
    const onDelete = jest.fn()
    const Wrapper = createTestWrapper()

    render(
      <Wrapper>
        <ProjectCard project={mockProject} onDelete={onDelete} />
      </Wrapper>
    )

    const deleteButton = screen.getByRole('button', { name: /delete/i })
    fireEvent.click(deleteButton)

    expect(onDelete).toHaveBeenCalledWith(mockProject)
  })

  it('shows loading state during deletion', async () => {
    const onDelete = jest.fn(() => new Promise(resolve => setTimeout(resolve, 100)))
    const Wrapper = createTestWrapper()

    render(
      <Wrapper>
        <ProjectCard project={mockProject} onDelete={onDelete} />
      </Wrapper>
    )

    const deleteButton = screen.getByRole('button', { name: /delete/i })
    fireEvent.click(deleteButton)

    // æ£€æŸ¥åŠ è½½çŠ¶æ€
    await waitFor(() => {
      expect(screen.getByText('åˆ é™¤ä¸­...')).toBeInTheDocument()
    })

    // ç­‰å¾…åˆ é™¤å®Œæˆ
    await waitFor(() => {
      expect(screen.queryByText('åˆ é™¤ä¸­...')).not.toBeInTheDocument()
    })
  })
})
```

### 6.2 React Hookæµ‹è¯•

```typescript
// tests/hooks/useProjects.test.ts
import { renderHook, waitFor } from '@testing-library/react'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { useProjects, useCreateProject } from '@/hooks/useProjects'
import { projectApi } from '@/lib/api/projects'
import { ProjectCreateRequest } from '@/types/project'

// Mock API
jest.mock('@/lib/api/projects')
const mockProjectApi = projectApi as jest.Mocked<typeof projectApi>

const createWrapper = () => {
  const queryClient = new QueryClient({
    defaultOptions: {
      queries: { retry: false },
      mutations: { retry: false },
    },
  })

  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  )
}

describe('useProjects', () => {
  beforeEach(() => {
    jest.clearAllMocks()
  })

  it('should fetch projects successfully', async () => {
    const mockProjects = [
      { id: '1', name: 'Project 1' },
      { id: '2', name: 'Project 2' }
    ]

    mockProjectApi.getProjects.mockResolvedValue(mockProjects)

    const { result } = renderHook(() => useProjects(), {
      wrapper: createWrapper()
    })

    expect(result.current.isLoading).toBe(true)

    await waitFor(() => {
      expect(result.current.isLoading).toBe(false)
    })

    expect(result.current.projects).toEqual(mockProjects)
    expect(result.current.error).toBeNull()
    expect(mockProjectApi.getProjects).toHaveBeenCalledTimes(1)
  })

  it('should handle API error', async () => {
    const mockError = new Error('Failed to fetch projects')
    mockProjectApi.getProjects.mockRejectedValue(mockError)

    const { result } = renderHook(() => useProjects(), {
      wrapper: createWrapper()
    })

    await waitFor(() => {
      expect(result.current.isLoading).toBe(false)
    })

    expect(result.current.projects).toEqual([])
    expect(result.current.error).toBeTruthy()
  })
})

describe('useCreateProject', () => {
  beforeEach(() => {
    jest.clearAllMocks()
  })

  it('should create project successfully', async () => {
    const newProject = { id: '3', name: 'New Project' }
    const projectData: ProjectCreateRequest = {
      name: 'New Project',
      client_name: 'Test Client',
      budget: 10000
    }

    mockProjectApi.create.mockResolvedValue(newProject)

    const { result } = renderHook(() => useCreateProject(), {
      wrapper: createWrapper()
    })

    expect(result.current.isPending).toBe(false)

    result.current.mutate(projectData)

    expect(result.current.isPending).toBe(true)

    await waitFor(() => {
      expect(result.current.isPending).toBe(false)
    })

    expect(result.current.isSuccess).toBe(true)
    expect(result.current.data).toEqual(newProject)
    expect(mockProjectApi.create).toHaveBeenCalledWith(projectData)
  })

  it('should handle create error', async () => {
    const mockError = new Error('Failed to create project')
    const projectData: ProjectCreateRequest = {
      name: 'New Project',
      client_name: 'Test Client',
      budget: 10000
    }

    mockProjectApi.create.mockRejectedValue(mockError)

    const { result } = renderHook(() => useCreateProject(), {
      wrapper: createWrapper()
    })

    result.current.mutate(projectData)

    await waitFor(() => {
      expect(result.current.isError).toBe(true)
    })

    expect(result.current.error).toBeTruthy()
    expect(result.current.isPending).toBe(false)
  })
})
```

---

## 7. ç«¯åˆ°ç«¯æµ‹è¯•

### 7.1 Playwright E2Eæµ‹è¯•

```typescript
// tests/e2e/project-management.spec.ts
import { test, expect } from '@playwright/test'

test.describe('é¡¹ç›®ç®¡ç† E2E æµ‹è¯•', () => {
  test.beforeEach(async ({ page }) => {
    // ç™»å½•
    await page.goto('/auth/login')
    await page.fill('[data-testid="email"]', 'test@example.com')
    await page.fill('[data-testid="password"]', 'testpassword123')
    await page.click('[data-testid="login-button"]')

    // ç­‰å¾…è·³è½¬åˆ°ä»ªè¡¨ç›˜
    await expect(page).toHaveURL('/dashboard')
  })

  test('should create, view, edit and delete a project', async ({ page }) => {
    // 1. åˆ›å»ºé¡¹ç›®
    await page.click('[data-testid="nav-projects"]')
    await expect(page).toHaveURL('/dashboard/projects')

    await page.click('[data-testid="create-project-button"]')
    await expect(page.locator('[data-testid="project-modal"]')).toBeVisible()

    await page.fill('[data-testid="project-name"]', 'E2E Test Project')
    await page.fill('[data-testid="project-description"]', 'This is a test project for E2E testing')
    await page.fill('[data-testid="client-name"]', 'E2E Test Client')
    await page.fill('[data-testid="project-budget"]', '15000')
    await page.click('[data-testid="submit-button"]')

    // éªŒè¯é¡¹ç›®åˆ›å»ºæˆåŠŸ
    await expect(page.locator('[data-testid="success-message"]')).toBeVisible()
    await expect(page.locator('text=E2E Test Project')).toBeVisible()

    // 2. æŸ¥çœ‹é¡¹ç›®è¯¦æƒ…
    await page.click('[data-testid="view-project-E2E Test Project"]')
    await expect(page).toHaveURL(/\/dashboard\/projects\/\w+/)

    await expect(page.locator('[data-testid="project-name"]')).toHaveText('E2E Test Project')
    await expect(page.locator('[data-testid="project-description"]')).toHaveText('This is a test project for E2E testing')
    await expect(page.locator('[data-testid="client-name"]')).toHaveText('E2E Test Client')
    await expect(page.locator('[data-testid="project-budget"]')).toHaveText('Â¥15,000')

    // 3. ç¼–è¾‘é¡¹ç›®
    await page.click('[data-testid="edit-project-button"]')
    await expect(page.locator('[data-testid="project-modal"]')).toBeVisible()

    await page.fill('[data-testid="project-name"]', 'Updated E2E Test Project')
    await page.fill('[data-testid="project-budget"]', '20000')
    await page.click('[data-testid="submit-button"]')

    // éªŒè¯æ›´æ–°æˆåŠŸ
    await expect(page.locator('[data-testid="success-message"]')).toBeVisible()
    await expect(page.locator('[data-testid="project-name"]')).toHaveText('Updated E2E Test Project')
    await expect(page.locator('[data-testid="project-budget"]')).toHaveText('Â¥20,000')

    // 4. åˆ é™¤é¡¹ç›®
    page.on('dialog', dialog => dialog.accept())
    await page.click('[data-testid="delete-project-button"]')

    // éªŒè¯åˆ é™¤æˆåŠŸ
    await expect(page.locator('[data-testid="success-message"]')).toBeVisible()
    await expect(page).toHaveURL('/dashboard/projects')

    // éªŒè¯é¡¹ç›®ä¸åœ¨åˆ—è¡¨ä¸­
    await expect(page.locator('text=Updated E2E Test Project')).not.toBeVisible()
  })

  test('should filter and search projects', async ({ page }) => {
    // å¯¼èˆªåˆ°é¡¹ç›®åˆ—è¡¨
    await page.click('[data-testid="nav-projects"]')

    // æµ‹è¯•æœç´¢åŠŸèƒ½
    await page.fill('[data-testid="search-input"]', 'Test')
    await page.press('[data-testid="search-input"]', 'Enter')

    // éªŒè¯æœç´¢ç»“æœ
    const projectCards = page.locator('[data-testid="project-card"]')
    const count = await projectCards.count()

    for (let i = 0; i < count; i++) {
      const card = projectCards.nth(i)
      const text = await card.textContent()
      expect(text?.toLowerCase()).toContain('test')
    }

    // æµ‹è¯•çŠ¶æ€è¿‡æ»¤
    await page.selectOption('[data-testid="status-filter"]', 'active')
    await page.press('[data-testid="status-filter"]', 'Enter')

    // éªŒè¯è¿‡æ»¤ç»“æœ
    const activeCards = page.locator('[data-testid="project-card"][data-status="active"]')
    const activeCount = await activeCards.count()

    const allCards = await page.locator('[data-testid="project-card"]').count()
    expect(activeCount).toBeLessThanOrEqual(allCards)
  })

  test('should export project data', async ({ page }) => {
    // å¯¼èˆªåˆ°é¡¹ç›®åˆ—è¡¨
    await page.click('[data-testid="nav-projects"]')

    // ç‚¹å‡»å¯¼å‡ºæŒ‰é’®
    const downloadPromise = page.waitForEvent('download')
    await page.click('[data-testid="export-button"]')

    const download = await downloadPromise

    // éªŒè¯ä¸‹è½½æ–‡ä»¶
    expect(download.suggestedFilename()).toMatch(/\.(xlsx|csv)$/)

    // ä¿å­˜ä¸‹è½½æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
    await download.saveAs('/tmp/projects-export.xlsx')
  })
})
```

### 7.2 è·¨æµè§ˆå™¨æµ‹è¯•

```typescript
// tests/e2e/cross-browser.spec.ts
import { test, devices } from '@playwright/test'

// ç§»åŠ¨è®¾å¤‡æµ‹è¯•
test.describe('ç§»åŠ¨è®¾å¤‡æµ‹è¯•', () => {
  test('should work on mobile devices', async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 }) // iPhone SE

    await page.goto('/')

    // æµ‹è¯•å“åº”å¼å¸ƒå±€
    await expect(page.locator('[data-testid="mobile-menu"]')).toBeVisible()
    await expect(page.locator('[data-testid="desktop-sidebar"]')).not.toBeVisible()

    // æµ‹è¯•ç§»åŠ¨ç«¯å¯¼èˆª
    await page.click('[data-testid="mobile-menu-toggle"]')
    await expect(page.locator('[data-testid="mobile-navigation"]')).toBeVisible()
  })
})

// è·¨æµè§ˆå™¨æµ‹è¯•
const browsers = ['chromium', 'firefox', 'webkit']
for (const browser of browsers) {
  test.describe(`${browser} æµè§ˆå™¨æµ‹è¯•`, () => {
    test.use({ browserName: browser })

    test('should work correctly in different browsers', async ({ page }) => {
      await page.goto('/auth/login')

      // åŸºæœ¬åŠŸèƒ½æµ‹è¯•
      await expect(page.locator('h1')).toContainText('ç™»å½•')
      await expect(page.locator('[data-testid="email-input"]')).toBeVisible()
      await expect(page.locator('[data-testid="password-input"]')).toBeVisible()
      await expect(page.locator('[data-testid="login-button"]')).toBeVisible()
    })
  })
}
```

---

## 8. æ€§èƒ½æµ‹è¯•

### 8.1 APIæ€§èƒ½æµ‹è¯•

```javascript
// tests/performance/api-performance-test.js
import { check, sleep } from 'k6';
import http from 'k6/http';

export let options = {
  stages: [
    { duration: '2m', target: 100 }, // 2åˆ†é’Ÿå†…å¢åŠ åˆ°100ç”¨æˆ·
    { duration: '5m', target: 100 }, // ä¿æŒ100ç”¨æˆ·5åˆ†é’Ÿ
    { duration: '2m', target: 200 }, // 2åˆ†é’Ÿå†…å¢åŠ åˆ°200ç”¨æˆ·
    { duration: '5m', target: 200 }, // ä¿æŒ200ç”¨æˆ·5åˆ†é’Ÿ
    { duration: '2m', target: 0 },   // 2åˆ†é’Ÿå†…å‡å°‘åˆ°0ç”¨æˆ·
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'], // 95%çš„è¯·æ±‚å“åº”æ—¶é—´å°äº500ms
    http_req_failed: ['rate<0.1'],    // é”™è¯¯ç‡å°äº10%
  },
};

const BASE_URL = 'http://localhost:8000';

export function setup() {
  // è·å–è®¤è¯token
  const loginResponse = http.post(`${BASE_URL}/api/auth/login`, JSON.stringify({
    email: 'test@example.com',
    password: 'testpassword123'
  }), {
    headers: {
      'Content-Type': 'application/json',
    },
  });

  return {
    token: loginResponse.json('data.access_token'),
  };
}

export default function(data) {
  const headers = {
    'Authorization': `Bearer ${data.token}`,
    'Content-Type': 'application/json',
  };

  // æµ‹è¯•é¡¹ç›®åˆ—è¡¨API
  let response = http.get(`${BASE_URL}/api/projects`, { headers });

  check(response, {
    'é¡¹ç›®åˆ—è¡¨çŠ¶æ€ç æ˜¯200': (r) => r.status === 200,
    'é¡¹ç›®åˆ—è¡¨å“åº”æ—¶é—´<200ms': (r) => r.timings.duration < 200,
    'é¡¹ç›®åˆ—è¡¨è¿”å›æ•°æ®': (r) => r.json('success') === true,
  });

  sleep(1);

  // æµ‹è¯•é¡¹ç›®ç»Ÿè®¡API
  response = http.get(`${BASE_URL}/api/projects/statistics`, { headers });

  check(response, {
    'ç»Ÿè®¡æ•°æ®çŠ¶æ€ç æ˜¯200': (r) => r.status === 200,
    'ç»Ÿè®¡æ•°æ®å“åº”æ—¶é—´<300ms': (r) => r.timings.duration < 300,
    'ç»Ÿè®¡æ•°æ®åŒ…å«å¿…è¦å­—æ®µ': (r) => {
      const data = r.json('data');
      return data.total_projects !== undefined &&
             data.active_projects !== undefined;
    },
  });

  sleep(1);
}

export function teardown() {
  console.log('æ€§èƒ½æµ‹è¯•å®Œæˆ');
}
```

### 8.2 å‰ç«¯æ€§èƒ½æµ‹è¯•

```typescript
// tests/performance/frontend-performance.spec.ts
import { test, expect } from '@playwright/test'

test.describe('å‰ç«¯æ€§èƒ½æµ‹è¯•', () => {
  test('should load main dashboard within performance budgets', async ({ page }) => {
    const start = Date.now()

    await page.goto('/dashboard')
    await page.waitForLoadState('networkidle')

    const loadTime = Date.now() - start

    // æ€§èƒ½é¢„ç®—æ£€æŸ¥
    expect(loadTime).toBeLessThan(3000) // 3ç§’å†…åŠ è½½å®Œæˆ

    // Core Web Vitals
    const webVitals = await page.evaluate(() => {
      return new Promise((resolve) => {
        const vitals = {}

        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (entry.entryType === 'largest-contentful-paint') {
              vitals.LCP = entry.startTime
            } else if (entry.entryType === 'first-input') {
              vitals.FID = entry.processingStart - entry.startTime
            } else if (entry.entryType === 'layout-shift') {
              vitals.CLS = (vitals.CLS || 0) + entry.value
            }
          }
        })

        observer.observe({ entryTypes: ['largest-contentful-paint', 'first-input', 'layout-shift'] })

        setTimeout(() => resolve(vitals), 5000)
      })
    })

    // LCP (Largest Contentful Paint) < 2.5s
    expect(webVitals.LCP).toBeLessThan(2500)

    // FID (First Input Delay) < 100ms
    expect(webVitals.FID).toBeLessThan(100)

    // CLS (Cumulative Layout Shift) < 0.1
    expect(webVitals.CLS).toBeLessThan(0.1)
  })

  test('should handle large datasets efficiently', async ({ page }) => {
    await page.goto('/dashboard/projects')

    // æ¨¡æ‹Ÿå¤§æ•°æ®é›†
    await page.evaluate(() => {
      // æ³¨å…¥å¤§é‡é¡¹ç›®æ•°æ®
      const projects = Array.from({ length: 1000 }, (_, i) => ({
        id: `project-${i}`,
        name: `Project ${i}`,
        client_name: `Client ${i}`,
        budget: Math.random() * 100000,
        status: 'active'
      }))

      // æ¸²æŸ“åˆ°é¡µé¢ä¸Š
      window.testProjects = projects
    })

    const start = Date.now()

    // æµ‹è¯•å¤§æ•°æ®é›†æ¸²æŸ“æ€§èƒ½
    await page.evaluate(() => {
      const container = document.createElement('div')
      container.innerHTML = window.testProjects.map(project =>
        `<div class="project-card" data-id="${project.id}">${project.name}</div>`
      ).join('')
      document.body.appendChild(container)
    })

    const renderTime = Date.now() - start

    expect(renderTime).toBeLessThan(1000) // 1ç§’å†…å®Œæˆæ¸²æŸ“
  })
})
```

---

## 9. å®‰å…¨æµ‹è¯•

### 9.1 OWASPå®‰å…¨æµ‹è¯•

```python
# tests/security/owasp_tests.py
import pytest
import requests
from urllib.parse import urljoin

class OWASPSecurityTests:

    def __init__(self, base_url: str):
        self.base_url = base_url
        self.session = requests.Session()

    def test_sql_injection(self):
        """æµ‹è¯•SQLæ³¨å…¥æ¼æ´"""
        sql_payloads = [
            "'; DROP TABLE users; --",
            "1' OR '1'='1",
            "UNION SELECT * FROM users --",
            "'; INSERT INTO users VALUES ('hacker', 'password'); --"
        ]

        for payload in sql_payloads:
            response = self.session.get(
                f"{self.base_url}/api/projects",
                params={"search": payload}
            )

            # ä¸åº”è¯¥è¿”å›æ•°æ®åº“é”™è¯¯ä¿¡æ¯
            assert response.status_code not in [500, 502]
            assert "error" not in response.text.lower()
            assert "mysql" not in response.text.lower()

    def test_xss_attacks(self):
        """æµ‹è¯•XSSæ”»å‡»"""
        xss_payloads = [
            "<script>alert('XSS')</script>",
            "<img src=x onerror=alert('XSS')>",
            "javascript:alert('XSS')",
            "<svg onload=alert('XSS')>"
        ]

        for payload in xss_payloads:
            response = self.session.post(
                f"{self.base_url}/api/projects",
                json={"name": payload, "description": payload}
            )

            if response.status_code == 200:
                # æ£€æŸ¥å“åº”æ˜¯å¦è¢«æ­£ç¡®è½¬ä¹‰
                response_data = response.json()
                assert "<script>" not in str(response_data)
                assert "javascript:" not in str(response_data)

    def test_csrf_protection(self):
        """æµ‹è¯•CSRFé˜²æŠ¤"""
        # å°è¯•æ²¡æœ‰CSRFä»¤ç‰Œçš„è¯·æ±‚
        response = self.session.post(
            f"{self.base_url}/api/projects",
            json={"name": "CSRF Test"}
        )

        # åº”è¯¥è¿”å›403æˆ–åŒ…å«CSRFä»¤ç‰Œè¦æ±‚
        assert response.status_code in [403, 422]

    def test_authentication_bypass(self):
        """æµ‹è¯•è®¤è¯ç»•è¿‡"""
        protected_endpoints = [
            "/api/projects",
            "/api/users",
            "/api/reports"
        ]

        for endpoint in protected_endpoints:
            response = self.session.get(f"{self.base_url}{endpoint}")
            assert response.status_code == 401, f"{endpoint} åº”è¯¥éœ€è¦è®¤è¯"

    def test_authorization_bypass(self):
        """æµ‹è¯•æƒé™ç»•è¿‡"""
        # å…ˆç™»å½•æ™®é€šç”¨æˆ·
        login_response = self.session.post(
            f"{self.base_url}/api/auth/login",
            json={"email": "user@example.com", "password": "password"}
        )

        if login_response.status_code == 200:
            token = login_response.json()["data"]["access_token"]
            self.session.headers.update({"Authorization": f"Bearer {token}"})

            # å°è¯•è®¿é—®ç®¡ç†å‘˜ç«¯ç‚¹
            admin_endpoints = [
                "/api/admin/users",
                "/api/admin/system-config"
            ]

            for endpoint in admin_endpoints:
                response = self.session.get(f"{self.base_url}{endpoint}")
                assert response.status_code == 403, f"{endpoint} åº”è¯¥éœ€è¦ç®¡ç†å‘˜æƒé™"

# Pytesté›†æˆ
@pytest.fixture
def security_tester():
    return OWASPSecurityTests("http://localhost:8000")

class TestOWASPSecurity:

    def test_sql_injection_protection(self, security_tester):
        """æµ‹è¯•SQLæ³¨å…¥é˜²æŠ¤"""
        security_tester.test_sql_injection()

    def test_xss_protection(self, security_tester):
        """æµ‹è¯•XSSé˜²æŠ¤"""
        security_tester.test_xss_attacks()

    def test_authentication_required(self, security_tester):
        """æµ‹è¯•è®¤è¯è¦æ±‚"""
        security_tester.test_authentication_bypass()

    def test_authorization_check(self, security_tester):
        """æµ‹è¯•æƒé™æ£€æŸ¥"""
        security_tester.test_authorization_bypass()
```

---

## 10. æµ‹è¯•è‡ªåŠ¨åŒ–

### 10.1 CI/CDé›†æˆ

```yaml
# .github/workflows/test.yml
name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Run code linting
      run: |
        cd backend
        flake8 app/
        black --check app/
        isort --check-only app/

    - name: Run security checks
      run: |
        cd backend
        bandit -r app/ -f json -o security-report.json
        safety check

    - name: Run unit tests
      run: |
        cd backend
        pytest tests/unit/ -v --cov=app --cov-report=xml --cov-report=html

    - name: Run integration tests
      run: |
        cd backend
        pytest tests/integration/ -v

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml

  frontend-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    - name: Run code linting
      run: |
        cd frontend
        npm run lint
        npm run type-check

    - name: Run unit tests
      run: |
        cd frontend
        npm run test:unit -- --coverage --watchAll=false

    - name: Run component tests
      run: |
        cd frontend
        npm run test:component -- --watchAll=false

    - name: Build application
      run: |
        cd frontend
        npm run build

    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./frontend/coverage/lcov.info

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Playwright
      run: |
        npx playwright install --with-deps

    - name: Start services
      run: |
        docker-compose -f docker-compose.test.yml up -d
        sleep 30

    - name: Run E2E tests
      run: |
        npx playwright test

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: playwright-report/

  performance-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests]
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Set up K6
      run: |
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6

    - name: Start backend service
      run: |
        docker-compose -f docker-compose.test.yml up -d
        sleep 30

    - name: Run performance tests
      run: |
        k6 run tests/performance/api-performance-test.js

    - name: Upload performance results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: performance-results/
```

### 10.2 æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ

```python
# tests/utils/report_generator.py
import json
import pytest
from datetime import datetime
from typing import Dict, List, Any

class TestReportGenerator:
    def __init__(self):
        self.results = []
        self.start_time = datetime.now()

    def add_test_result(self, test_name: str, status: str, duration: float, details: Dict[str, Any] = None):
        """æ·»åŠ æµ‹è¯•ç»“æœ"""
        self.results.append({
            "test_name": test_name,
            "status": status,  # passed, failed, skipped
            "duration": duration,
            "details": details or {},
            "timestamp": datetime.now().isoformat()
        })

    def generate_summary(self) -> Dict[str, Any]:
        """ç”Ÿæˆæµ‹è¯•æ‘˜è¦"""
        total = len(self.results)
        passed = len([r for r in self.results if r["status"] == "passed"])
        failed = len([r for r in self.results if r["status"] == "failed"])
        skipped = len([r for r in self.results if r["status"] == "skipped"])

        total_duration = sum(r["duration"] for r in self.results)
        avg_duration = total_duration / total if total > 0 else 0

        return {
            "summary": {
                "total_tests": total,
                "passed": passed,
                "failed": failed,
                "skipped": skipped,
                "pass_rate": f"{(passed / total * 100):.1f}%" if total > 0 else "0%",
                "total_duration": f"{total_duration:.2f}s",
                "average_duration": f"{avg_duration:.2f}s"
            },
            "execution_time": {
                "start": self.start_time.isoformat(),
                "end": datetime.now().isoformat(),
                "total_seconds": (datetime.now() - self.start_time).total_seconds()
            }
        }

    def generate_html_report(self, output_file: str = "test-report.html"):
        """ç”ŸæˆHTMLæµ‹è¯•æŠ¥å‘Š"""
        summary = self.generate_summary()

        html_template = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>æµ‹è¯•æŠ¥å‘Š - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 20px; }}
                .summary {{ background: #f5f5f5; padding: 20px; border-radius: 5px; margin-bottom: 20px; }}
                .passed {{ color: green; }}
                .failed {{ color: red; }}
                .skipped {{ color: orange; }}
                table {{ border-collapse: collapse; width: 100%; }}
                th, td {{ border: 1px solid #ddd; padding: 8px; text-align: left; }}
                th {{ background-color: #f2f2f2; }}
            </style>
        </head>
        <body>
            <h1>æµ‹è¯•æŠ¥å‘Š</h1>

            <div class="summary">
                <h2>æµ‹è¯•æ‘˜è¦</h2>
                <p><strong>æ€»æµ‹è¯•æ•°:</strong> {summary['summary']['total_tests']}</p>
                <p class="passed"><strong>é€šè¿‡:</strong> {summary['summary']['passed']}</p>
                <p class="failed"><strong>å¤±è´¥:</strong> {summary['summary']['failed']}</p>
                <p class="skipped"><strong>è·³è¿‡:</strong> {summary['summary']['skipped']}</p>
                <p><strong>é€šè¿‡ç‡:</strong> {summary['summary']['pass_rate']}</p>
                <p><strong>æ€»è€—æ—¶:</strong> {summary['summary']['total_duration']}</p>
                <p><strong>å¹³å‡è€—æ—¶:</strong> {summary['summary']['average_duration']}</p>
            </div>

            <h2>è¯¦ç»†ç»“æœ</h2>
            <table>
                <tr>
                    <th>æµ‹è¯•åç§°</th>
                    <th>çŠ¶æ€</th>
                    <th>è€—æ—¶</th>
                    <th>è¯¦æƒ…</th>
                </tr>
        """

        for result in self.results:
            status_class = result["status"]
            html_template += f"""
                <tr>
                    <td>{result['test_name']}</td>
                    <td class="{status_class}">{result['status']}</td>
                    <td>{result['duration']:.3f}s</td>
                    <td>{json.dumps(result['details'], ensure_ascii=False)}</td>
                </tr>
            """

        html_template += """
            </table>
        </body>
        </html>
        """

        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(html_template)

    def generate_json_report(self, output_file: str = "test-report.json"):
        """ç”ŸæˆJSONæµ‹è¯•æŠ¥å‘Š"""
        report_data = {
            "report_metadata": {
                "generated_at": datetime.now().isoformat(),
                "generator": "TestReportGenerator v1.0"
            },
            "summary": self.generate_summary(),
            "test_results": self.results
        }

        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(report_data, f, indent=2, ensure_ascii=False)

# Pytestæ’ä»¶
def pytest_configure(config):
    """Pytesté…ç½®é’©å­"""
    config._test_report_generator = TestReportGenerator()

def pytest_runtest_logreport(report):
    """æµ‹è¯•ç»“æœè®°å½•é’©å­"""
    if hasattr(config, '_test_report_generator'):
        generator = config._test_report_generator

        if report.when == 'call':
            details = {}
            if hasattr(report, 'longrepr') and report.longrepr:
                details["error"] = str(report.longrepr)

            generator.add_test_result(
                test_name=report.nodeid,
                status="passed" if report.passed else "failed",
                duration=report.duration,
                details=details
            )

def pytest_sessionfinish(session, exitstatus):
    """æµ‹è¯•ä¼šè¯ç»“æŸé’©å­"""
    if hasattr(config, '_test_report_generator'):
        generator = config._test_report_generator

        generator.generate_html_report()
        generator.generate_json_report()

        print(f"\næµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ:")
        print(f"- HTMLæŠ¥å‘Š: test-report.html")
        print(f"- JSONæŠ¥å‘Š: test-report.json")
```

---

## ğŸ“ æµ‹è¯•æ”¯æŒ

### æµ‹è¯•å›¢é˜Ÿè”ç³»
- **æµ‹è¯•è´Ÿè´£äºº**: qa@company.com
- **è‡ªåŠ¨åŒ–å·¥ç¨‹å¸ˆ**: automation@company.com
- **æ€§èƒ½æµ‹è¯•**: performance@company.com
- **å®‰å…¨æµ‹è¯•**: security@company.com

### æµ‹è¯•å·¥å…·å’Œèµ„æº
- **æµ‹è¯•ç®¡ç†**: https://testrail.yourdomain.com
- **ç¼ºé™·ç®¡ç†**: https://jira.yourdomain.com
- **æµ‹è¯•æŠ¥å‘Š**: https://reports.yourdomain.com
- **æµ‹è¯•æ–‡æ¡£**: https://wiki.yourdomain.com/testing

### æµ‹è¯•ç¯å¢ƒ
- **æµ‹è¯•ç¯å¢ƒ**: https://test.yourdomain.com
- **é¢„ç”Ÿäº§ç¯å¢ƒ**: https://staging.yourdomain.com
- **æ€§èƒ½æµ‹è¯•ç¯å¢ƒ**: https://perf.yourdomain.com

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-11
**ä¸‹æ¬¡å®¡æŸ¥**: æµ‹è¯•æµç¨‹æ›´æ–°æ—¶
**ç»´æŠ¤è´£ä»»äºº**: æµ‹è¯•å›¢é˜Ÿè´Ÿè´£äºº