# AIå¹¿å‘Šä»£æŠ•ç³»ç»Ÿå¼€å‘æ–‡æ¡£

> **é¡¹ç›®åç§°**: AIå¹¿å‘Šä»£æŠ•ä¸è´¢åŠ¡ç®¡ç†ç³»ç»Ÿ
> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-10
> **æ–‡æ¡£ç±»å‹**: ç»¼åˆå¼€å‘æŒ‡å—
> **é€‚ç”¨è§’è‰²**: å¼€å‘å›¢é˜Ÿã€é¡¹ç›®ç®¡ç†ã€è¿ç»´å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#2-æŠ€æœ¯æ¶æ„)
3. [å¼€å‘ç¯å¢ƒå‡†å¤‡](#3-å¼€å‘ç¯å¢ƒå‡†å¤‡)
4. [ä¸šåŠ¡æµç¨‹å®ç°è¯¦è§£](#4-ä¸šåŠ¡æµç¨‹å®ç°è¯¦è§£)
5. [æ ¸å¿ƒæ¨¡å—å¼€å‘æŒ‡å—](#5-æ ¸å¿ƒæ¨¡å—å¼€å‘æŒ‡å—)
6. [æ•°æ®æ¨¡å‹ä¸APIè®¾è®¡](#6-æ•°æ®æ¨¡å‹ä¸apiè®¾è®¡)
7. [å‰ç«¯å¼€å‘å®ç°](#7-å‰ç«¯å¼€å‘å®ç°)
8. [éƒ¨ç½²ä¸è¿ç»´](#8-éƒ¨ç½²ä¸è¿ç»´)
9. [æµ‹è¯•ä¸è´¨é‡ä¿è¯](#9-æµ‹è¯•ä¸è´¨é‡ä¿è¯)
10. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#10-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

æˆ‘ä»¬æ˜¯ä¸€å®¶ä¸“ä¸šçš„Facebookå¹¿å‘Šä»£æŠ•å…¬å¸ï¼Œä¸ºç”²æ–¹å®¢æˆ·æä¾›å¹¿å‘ŠæŠ•æ”¾æœåŠ¡ã€‚ä¸»è¦ä¸šåŠ¡æ¨¡å¼æ˜¯é€šè¿‡æ”¶å–é¡¹ç›®å¯åŠ¨è´¹ï¼Œå¹¶æ ¹æ®å¸®åŠ©ç”²æ–¹å¸¦æ¥çš„æ½œåœ¨å®¢æˆ·æ•°é‡è¿›è¡Œè®¡è´¹ã€‚

### 1.2 æ ¸å¿ƒä¸šåŠ¡æŒ‘æˆ˜

1. **æŠ•æ‰‹æ•ˆç‡ç®¡ç†**: ç¼ºä¹æœ‰æ•ˆçš„ç»©æ•ˆè€ƒæ ¸å’Œå®æ—¶ç›‘æ§
2. **è´¢åŠ¡å¯¹è´¦å›°éš¾**: å……å€¼ç”³è¯·å®¡æ‰¹æµç¨‹æ··ä¹±ï¼Œæ¶ˆè€—ä¸å……å€¼å¯¹è´¦ä¸æ¸…æ™°
3. **æ¸ é“ç®¡ç†å¤æ‚**: å¤šä¸ªå¹¿å‘Šä»£ç†å•†è´¨é‡å‚å·®ä¸é½ï¼Œç¼ºä¹æ¸ é“ç»©æ•ˆè¯„ä¼°
4. **ç›ˆåˆ©åˆ†æä¸æ¸…æ™°**: æ— æ³•å‡†ç¡®è¯„ä¼°é¡¹ç›®ç›ˆåˆ©çŠ¶å†µ
5. **è´¦æˆ·ç”Ÿå‘½å‘¨æœŸç®¡ç†**: å¹¿å‘Šè´¦æˆ·å¯¿å‘½ä¸ç¡®å®šï¼ˆå‡ å¤©åˆ°å‡ ä¸ªæœˆä¸ç­‰ï¼‰

### 1.3 ç³»ç»Ÿç›®æ ‡

- **è‡ªåŠ¨åŒ–æµç¨‹**: å‡å°‘90%çš„äººå·¥æ•°æ®å½•å…¥å·¥ä½œ
- **è´¢åŠ¡å‡†ç¡®æ€§**: è§£å†³è´¢åŠ¡å¯¹è´¦åå·®é—®é¢˜ï¼Œå®ç°ç²¾å‡†æˆæœ¬æ ¸ç®—
- **å†³ç­–æ”¯æŒ**: åŸºäºçœŸå®æ•°æ®è¿›è¡Œä¸šåŠ¡å†³ç­–
- **æ‰©å±•æ€§**: æ”¯æŒä¸šåŠ¡è§„æ¨¡æ‰©å±•å’Œæ¨¡å¼å¤åˆ¶

### 1.4 æ ¸å¿ƒä¸šåŠ¡æµç¨‹

```mermaid
graph TD
    A[ç”²æ–¹ç­¾çº¦ä»˜æ¬¾] --> B[åˆ›å»ºé¡¹ç›®]
    B --> C[ç”³è¯·æ¸ é“è´¦æˆ·]
    C --> D[åˆ†é…è´¦æˆ·ç»™æŠ•æ‰‹]
    D --> E[æŠ•æ‰‹æŠ•æ”¾å¹¿å‘Š]
    E --> F[æ¯æ—¥æäº¤æ—¥æŠ¥]
    F --> G[æ•°æ®å‘˜å®¡æ ¸ç”²æ–¹ç²‰æ•°]
    E --> H[æäº¤å……å€¼ç”³è¯·]
    H --> I[æ•°æ®å‘˜å®¡æ ¸éœ€æ±‚]
    I --> J[è´¢åŠ¡å®¡æ‰¹]
    J --> K[è´¢åŠ¡æ‰“æ¬¾ç»™ä»£ç†å•†]
    K --> L[ä»£ç†å•†å……å€¼]
    L --> M[æœˆåº•è´¢åŠ¡å¯¹è´¦]
    M --> N[é¡¹ç›®ç›ˆåˆ©åˆ†æ]
```

---

## 2. æŠ€æœ¯æ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯å±‚ (Next.js)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                ä¸šåŠ¡é€»è¾‘å±‚ (FastAPI)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              æ•°æ®è®¿é—®å±‚ (SQLAlchemy)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                æ•°æ®å±‚ (PostgreSQL)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯æ ˆ

#### å‰ç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: Next.js 14 (App Router)
- **è¯­è¨€**: TypeScript
- **æ ·å¼**: Tailwind CSS + CSS Modules
- **UIç»„ä»¶**: Radix UI + è‡ªå®šä¹‰ç»„ä»¶
- **çŠ¶æ€ç®¡ç†**: React Context + Hooks
- **å›¾è¡¨åº“**: Recharts
- **è®¤è¯**: Supabase Auth
- **APIè¯·æ±‚**: fetch + è‡ªå®šä¹‰hook

#### åç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: FastAPI
- **è¯­è¨€**: Python 3.8+
- **æ•°æ®åº“**: PostgreSQL + Supabase
- **ORM**: SQLAlchemy 2.0
- **è®¤è¯**: JWT + Supabase Auth
- **æ•°æ®éªŒè¯**: Pydantic
- **APIæ–‡æ¡£**: è‡ªåŠ¨ç”ŸæˆOpenAPI/Swagger

#### åŸºç¡€è®¾æ–½
- **æ•°æ®åº“**: PostgreSQL (Supabaseæ‰˜ç®¡)
- **éƒ¨ç½²**: Vercel + å®å¡”é¢æ¿
- **ç›‘æ§**: å¥åº·æ£€æŸ¥ã€å®¡è®¡æ—¥å¿—
- **å®‰å…¨**: RLSè¡Œçº§å®‰å…¨ã€JWTåŠ å¯†

### 2.3 å®‰å…¨æ¶æ„

- **æ•°æ®å®‰å…¨**: RLSè¡Œçº§å®‰å…¨ç­–ç•¥
- **è®¤è¯æˆæƒ**: JWT + è§’è‰²æƒé™ç®¡ç†
- **æ“ä½œå®¡è®¡**: å®Œæ•´çš„æ“ä½œæ—¥å¿—è®°å½•
- **æ•°æ®åŠ å¯†**: æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨

---

## 3. å¼€å‘ç¯å¢ƒå‡†å¤‡

### 3.1 ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Windows 10/11, macOS, Ubuntu 20.04+
- **Python**: 3.8+
- **Node.js**: 18+
- **Git**: 2.30+

### 3.2 å¼€å‘å·¥å…·å®‰è£…

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository-url>
cd AI_ad_spend02

# 2. åç«¯ç¯å¢ƒé…ç½®
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt

# 3. å‰ç«¯ç¯å¢ƒé…ç½®
npm install

# 4. ç¯å¢ƒå˜é‡é…ç½®
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥å®é™…é…ç½®
```

### 3.3 æ•°æ®åº“è®¾ç½®

```bash
# 1. åˆ›å»ºSupabaseé¡¹ç›®
# 2. è·å–æ•°æ®åº“è¿æ¥ä¿¡æ¯
# 3. æ›´æ–° .env æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®
# 4. è¿è¡Œæ•°æ®åº“è¿ç§»
cd backend
python -m alembic upgrade head
```

### 3.4 å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
# å¯åŠ¨åç«¯æœåŠ¡
cd backend
python main.py

# å¯åŠ¨å‰ç«¯æœåŠ¡ (æ–°ç»ˆç«¯)
cd app
npm run dev
```

### 3.5 éªŒè¯ç¯å¢ƒ

- åç«¯API: http://localhost:8000/docs
- å‰ç«¯åº”ç”¨: http://localhost:3000
- æ•°æ®åº“è¿æ¥: æ£€æŸ¥æ—¥å¿—è¾“å‡º

---

## 4. ä¸šåŠ¡æµç¨‹å®ç°è¯¦è§£

### 4.1 å››å±‚æ•°æ®å…³ç³»å®ç°

#### ä¸šåŠ¡é€»è¾‘
```
é¡¹ç›® (Project) â†’ æ¸ é“ (Channel) â†’ å¹¿å‘Šè´¦æˆ· (AdAccount) â†’ æŠ•æ‰‹ (User)
```

#### æ•°æ®æ¨¡å‹è®¾è®¡

```python
# é¡¹ç›®æ¨¡å‹ (projects.py)
class Project(Base):
    __tablename__ = "projects"

    id = Column(GUID(), primary_key=True, default=uuid.uuid4)
    name = Column(String(255), nullable=False)
    client_name = Column(String(255), nullable=False)
    pricing_model = Column(String(50), default="per_lead")
    lead_price = Column(Numeric(10, 2), nullable=False)
    # ... å…¶ä»–å­—æ®µ

# æ¸ é“æ¨¡å‹ (channels.py)
class Channel(Base):
    __tablename__ = "channels"

    id = Column(GUID(), primary_key=True, default=uuid.uuid4)
    name = Column(String(255), nullable=False)
    service_fee_rate = Column(Numeric(5, 4), nullable=False)  # 5%-20%
    # ... å…¶ä»–å­—æ®µ

# å¹¿å‘Šè´¦æˆ·æ¨¡å‹ (ad_accounts.py)
class AdAccount(Base):
    __tablename__ = "ad_accounts"

    id = Column(GUID(), primary_key=True, default=uuid.uuid4)
    account_id = Column(String(255), unique=True, nullable=False)
    project_id = Column(GUID(), ForeignKey("projects.id"))
    channel_id = Column(GUID(), ForeignKey("channels.id"))
    assigned_user_id = Column(GUID(), ForeignKey("users.id"))
    status = Column(String(20), default="new")
    # ... å…¶ä»–å­—æ®µ
```

#### å…³é”®å®ç°ç‚¹

1. **å¤–é”®çº¦æŸ**: ç¡®ä¿æ•°æ®å…³ç³»çš„å®Œæ•´æ€§
2. **ç´¢å¼•ä¼˜åŒ–**: åœ¨å…³è”å­—æ®µä¸Šå»ºç«‹ç´¢å¼•
3. **çº§è”åˆ é™¤**: åˆç†è®¾ç½®åˆ é™¤ç­–ç•¥
4. **æ•°æ®éªŒè¯**: åœ¨APIå±‚è¿›è¡Œæ•°æ®å®Œæ•´æ€§éªŒè¯

### 4.2 "ç²‰"ç®¡ç†ä¸šåŠ¡æµç¨‹

#### ä¸šåŠ¡è§„åˆ™
1. **ç»Ÿä¸€æœ¯è¯­**: æ½œåœ¨å®¢æˆ·ç»Ÿä¸€ç”¨"ç²‰"æŒ‡ä»£
2. **æ•°é‡ç¡®å®š**: ç²‰æ•°æœ€ç»ˆç”±ç”²æ–¹åé¦ˆå†³å®šï¼Œä¸æ˜¯ç³»ç»Ÿè‡ªåŠ¨ç»Ÿè®¡
3. **æ•°æ®æ¥æº**: é€šè¿‡è¡¨å•æäº¤çš„æ½œåœ¨å®¢æˆ·
4. **ç»Ÿè®¡ç»´åº¦**: åªåˆ†é¡¹ç›®å’ŒæŠ•æ‰‹ç»´åº¦ï¼Œä¸åŒºåˆ†å…·ä½“å¹¿å‘Šè´¦æˆ·

#### å®ç°æµç¨‹

```python
# æ—¥æŠ¥ç®¡ç†æ¨¡å‹ (ad_spend_daily.py)
class AdSpendDaily(Base):
    __tablename__ = "ad_spend_daily"

    id = Column(GUID(), primary_key=True, default=uuid.uuid4)
    project_id = Column(GUID(), ForeignKey("projects.id"))
    user_id = Column(GUID(), ForeignKey("users.id"))  # æŠ•æ‰‹
    date = Column(Date, nullable=False)

    # æŠ•æ‰‹æäº¤æ•°æ®
    leads_submitted = Column(Integer, default=0)  # æŠ•æ‰‹ç»Ÿè®¡çš„ç²‰æ•°
    spend = Column(Numeric(15, 2), nullable=False)

    # ç”²æ–¹ç¡®è®¤æ•°æ®
    leads_confirmed = Column(Integer, nullable=True)  # ç”²æ–¹ç¡®è®¤çš„ç²‰æ•°
    confirmed_by = Column(GUID(), ForeignKey("users.id"))  # æ•°æ®å‘˜
    confirmed_at = Column(DateTime, nullable=True)

    # å·®å¼‚åˆ†æ
    leads_diff = Column(Integer, nullable=True)  # å·®å¼‚æ•°é‡
    diff_reason = Column(Text, nullable=True)  # å·®å¼‚åŸå› 
```

#### APIå®ç°

```python
# routers/ad_spend.py
@router.post("/daily-report")
async def submit_daily_report(
    report: AdSpendDailyCreate,
    current_user: User = Depends(get_current_user)
):
    """æŠ•æ‰‹æäº¤æ—¥æŠ¥"""
    # éªŒè¯ç”¨æˆ·æƒé™
    if current_user.role != "media_buyer":
        raise HTTPException(403, "æƒé™ä¸è¶³")

    # åˆ›å»ºæ—¥æŠ¥è®°å½•
    daily_report = AdSpendDaily(
        project_id=report.project_id,
        user_id=current_user.id,
        date=report.date,
        leads_submitted=report.leads,
        spend=report.spend
    )

    db.add(daily_report)
    db.commit()

    # é€šçŸ¥æ•°æ®å‘˜å®¡æ ¸
    await notify_data_clerk(daily_report)

    return {"message": "æ—¥æŠ¥æäº¤æˆåŠŸ", "id": daily_report.id}

@router.put("/daily-report/{report_id}/confirm")
async def confirm_daily_report(
    report_id: str,
    confirmation: AdSpendDailyConfirm,
    current_user: User = Depends(get_current_user)
):
    """æ•°æ®å‘˜ç¡®è®¤ç²‰æ•°"""
    # éªŒè¯æƒé™
    if current_user.role not in ["data_clerk", "admin"]:
        raise HTTPException(403, "æƒé™ä¸è¶³")

    # è·å–æ—¥æŠ¥è®°å½•
    report = db.query(AdSpendDaily).filter(
        AdSpendDaily.id == report_id
    ).first()

    if not report:
        raise HTTPException(404, "æ—¥æŠ¥è®°å½•ä¸å­˜åœ¨")

    # æ›´æ–°ç¡®è®¤æ•°æ®
    report.leads_confirmed = confirmation.leads_confirmed
    report.confirmed_by = current_user.id
    report.confirmed_at = datetime.utcnow()

    # è®¡ç®—å·®å¼‚
    report.leads_diff = confirmation.leads_confirmed - report.leads_submitted
    if report.leads_diff != 0:
        report.diff_reason = confirmation.reason

    db.commit()

    return {"message": "ç²‰æ•°ç¡®è®¤æˆåŠŸ"}
```

### 4.3 ç®€åŒ–å……å€¼æµç¨‹å®ç°

#### ä¸šåŠ¡æµç¨‹
```
æŠ•æ‰‹ç”³è¯· â†’ æ•°æ®å‘˜å®¡æ ¸ â†’ è´¢åŠ¡å®¡æ‰¹ â†’ è´¢åŠ¡æ‰“æ¬¾ â†’ ä»£ç†å•†å……å€¼
```

#### æ•°æ®æ¨¡å‹

```python
# topup.py
class Topup(Base):
    __tablename__ = "topups"

    id = Column(GUID(), primary_key=True, default=uuid.uuid4)
    project_id = Column(GUID(), ForeignKey("projects.id"))
    ad_account_id = Column(GUID(), ForeignKey("ad_accounts.id"))
    requested_by = Column(GUID(), ForeignKey("users.id"))  # æŠ•æ‰‹

    # ç”³è¯·ä¿¡æ¯
    amount = Column(Numeric(15, 2), nullable=False)
    purpose = Column(Text, nullable=True)
    urgency_level = Column(String(20), default="normal")  # normal, urgent

    # å®¡æ‰¹æµç¨‹
    status = Column(String(20), default="pending")  # pending, clerk_approved, finance_approved, completed, rejected
    clerk_approval = Column(JSON, nullable=True)  # æ•°æ®å‘˜å®¡æ‰¹ä¿¡æ¯
    finance_approval = Column(JSON, nullable=True)  # è´¢åŠ¡å®¡æ‰¹ä¿¡æ¯

    # è´¹ç”¨è®¡ç®—
    fee_rate = Column(Numeric(5, 4), nullable=False)  # æ‰‹ç»­è´¹ç‡
    fee_amount = Column(Numeric(15, 2), nullable=False)  # æ‰‹ç»­è´¹é‡‘é¢
    total_amount = Column(Numeric(15, 2), nullable=False)  # æ€»é‡‘é¢

    # æ‰§è¡Œä¿¡æ¯
    payment_method = Column(String(50), nullable=True)
    transaction_id = Column(String(255), nullable=True)
    completed_at = Column(DateTime, nullable=True)
```

#### æµç¨‹å®ç°

```python
# routers/topups.py
@router.post("/request")
async def create_topup_request(
    request: TopupRequest,
    current_user: User = Depends(get_current_user)
):
    """æŠ•æ‰‹æäº¤å……å€¼ç”³è¯·"""

    # éªŒè¯æŠ•æ‰‹æƒé™
    if current_user.role != "media_buyer":
        raise HTTPException(403, "åªæœ‰æŠ•æ‰‹å¯ä»¥æäº¤å……å€¼ç”³è¯·")

    # è·å–è´¦æˆ·ä¿¡æ¯
    account = db.query(AdAccount).filter(
        AdAccount.id == request.ad_account_id,
        AdAccount.assigned_user_id == current_user.id
    ).first()

    if not account:
        raise HTTPException(404, "è´¦æˆ·ä¸å­˜åœ¨æˆ–æ— æƒé™")

    # è·å–æ¸ é“è´¹ç‡
    channel = db.query(Channel).filter(Channel.id == account.channel_id).first()
    fee_rate = channel.service_fee_rate

    # è®¡ç®—è´¹ç”¨
    fee_amount = request.amount * fee_rate
    total_amount = request.amount + fee_amount

    # åˆ›å»ºå……å€¼ç”³è¯·
    topup = Topup(
        project_id=account.project_id,
        ad_account_id=request.ad_account_id,
        requested_by=current_user.id,
        amount=request.amount,
        purpose=request.purpose,
        fee_rate=fee_rate,
        fee_amount=fee_amount,
        total_amount=total_amount
    )

    db.add(topup)
    db.commit()

    # é€šçŸ¥æ•°æ®å‘˜
    await notify_data_clerk_for_approval(topup)

    return {"message": "å……å€¼ç”³è¯·æäº¤æˆåŠŸ", "id": topup.id}

@router.put("/{topup_id}/clerk-approval")
async def clerk_approval(
    topup_id: str,
    approval: ClerkApproval,
    current_user: User = Depends(get_current_user)
):
    """æ•°æ®å‘˜å®¡æ‰¹"""

    # éªŒè¯æƒé™
    if current_user.role not in ["data_clerk", "admin"]:
        raise HTTPException(403, "æƒé™ä¸è¶³")

    topup = db.query(Topup).filter(Topup.id == topup_id).first()
    if not topup:
        raise HTTPException(404, "å……å€¼ç”³è¯·ä¸å­˜åœ¨")

    # æ›´æ–°å®¡æ‰¹çŠ¶æ€
    if approval.approved:
        topup.status = "clerk_approved"
        topup.clerk_approval = {
            "approved_by": current_user.id,
            "approved_at": datetime.utcnow().isoformat(),
            "notes": approval.notes,
            "recommended_amount": approval.recommended_amount
        }

        # é€šçŸ¥è´¢åŠ¡å®¡æ‰¹
        await notify_finance_for_approval(topup)
    else:
        topup.status = "rejected"
        topup.clerk_approval = {
            "rejected_by": current_user.id,
            "rejected_at": datetime.utcnow().isoformat(),
            "reason": approval.reason
        }

    db.commit()
    return {"message": "æ•°æ®å‘˜å®¡æ‰¹å®Œæˆ"}

@router.put("/{topup_id}/finance-approval")
async def finance_approval(
    topup_id: str,
    approval: FinanceApproval,
    current_user: User = Depends(get_current_user)
):
    """è´¢åŠ¡å®¡æ‰¹å’Œæ‰§è¡Œ"""

    # éªŒè¯æƒé™
    if current_user.role not in ["finance", "admin"]:
        raise HTTPException(403, "æƒé™ä¸è¶³")

    topup = db.query(Topup).filter(Topup.id == topup_id).first()
    if not topup:
        raise HTTPException(404, "å……å€¼ç”³è¯·ä¸å­˜åœ¨")

    if approval.approved:
        # æ‰§è¡Œå……å€¼
        topup.status = "completed"
        topup.finance_approval = {
            "approved_by": current_user.id,
            "approved_at": datetime.utcnow().isoformat(),
            "payment_method": approval.payment_method,
            "transaction_id": approval.transaction_id
        }
        topup.completed_at = datetime.utcnow()

        # æ›´æ–°è´¦æˆ·ä½™é¢
        await update_account_balance(topup.ad_account_id, topup.amount)

        # è®°å½•è´¢åŠ¡æµæ°´
        await create_financial_transaction(topup)
    else:
        topup.status = "rejected"
        topup.finance_approval = {
            "rejected_by": current_user.id,
            "rejected_at": datetime.utcnow().isoformat(),
            "reason": approval.reason
        }

    db.commit()
    return {"message": "è´¢åŠ¡å®¡æ‰¹å®Œæˆ"}
```

### 4.4 å¯¹è´¦æœºåˆ¶ä¸šåŠ¡é€»è¾‘

#### å¯¹è´¦ç®—æ³•

```python
# services/reconciliation_service.py
class ReconciliationService:

    def __init__(self, db_session):
        self.db = db_session

    async def monthly_reconciliation(self, project_id: str, year: int, month: int):
        """æœˆåº¦å¯¹è´¦"""

        # è·å–æ—¶é—´èŒƒå›´
        start_date = datetime(year, month, 1)
        if month == 12:
            end_date = datetime(year + 1, 1, 1)
        else:
            end_date = datetime(year, month + 1, 1)

        # 1. ç»Ÿè®¡å……å€¼æ€»é¢
        total_topups = self.db.query(func.sum(Topup.total_amount)).filter(
            Topup.project_id == project_id,
            Topup.status == "completed",
            Topup.completed_at >= start_date,
            Topup.completed_at < end_date
        ).scalar() or 0

        # 2. ç»Ÿè®¡æ¶ˆè€—æ€»é¢
        total_spend = self.db.query(func.sum(AdSpendDaily.spend)).filter(
            AdSpendDaily.project_id == project_id,
            AdSpendDaily.date >= start_date.date(),
            AdSpendDaily.date < end_date.date()
        ).scalar() or 0

        # 3. è®¡ç®—å·®å¼‚
        difference = total_topups - total_spend

        # 4. åˆ†æå·®å¼‚åŸå› 
        variance_analysis = await self.analyze_variance(
            project_id, start_date, end_date, difference
        )

        # 5. ç”Ÿæˆå¯¹è´¦æŠ¥å‘Š
        reconciliation = Reconciliation(
            project_id=project_id,
            period_type="monthly",
            period_start=start_date,
            period_end=end_date - timedelta(days=1),
            total_topups=total_topups,
            total_spend=total_spend,
            difference=difference,
            variance_analysis=variance_analysis
        )

        self.db.add(reconciliation)
        self.db.commit()

        return reconciliation

    async def analyze_variance(self, project_id: str, start_date: datetime,
                            end_date: datetime, difference: float):
        """åˆ†æå·®å¼‚åŸå› """

        analysis = {
            "time_delay": 0,  # æ—¶é—´å·®å¯¼è‡´çš„å·®å¼‚
            "processing_fees": 0,  # æ‰‹ç»­è´¹
            "pending_transactions": 0,  # å¾…å¤„ç†äº¤æ˜“
            "other": 0  # å…¶ä»–åŸå› 
        }

        # æ£€æŸ¥æ—¶é—´å·®
        pending_topups = self.db.query(func.sum(Topup.total_amount)).filter(
            Topup.project_id == project_id,
            Topup.status == "finance_approved",
            Topup.completed_at >= start_date,
            Topup.completed_at < end_date
        ).scalar() or 0

        analysis["time_delay"] = pending_topups

        # æ£€æŸ¥æ‰‹ç»­è´¹
        total_fees = self.db.query(func.sum(Topup.fee_amount)).filter(
            Topup.project_id == project_id,
            Topup.status == "completed",
            Topup.completed_at >= start_date,
            Topup.completed_at < end_date
        ).scalar() or 0

        analysis["processing_fees"] = total_fees

        # å…¶ä»–å·®å¼‚
        analysis["other"] = difference - sum(analysis.values())

        return analysis
```

---

## 5. æ ¸å¿ƒæ¨¡å—å¼€å‘æŒ‡å—

### 5.1 é¡¹ç›®ç®¡ç†æ¨¡å—

#### åŠŸèƒ½ç‰¹æ€§
- é¡¹ç›®åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤
- å®¢æˆ·ä¿¡æ¯ç®¡ç†
- æ”¶è´¹æ¨¡å¼é…ç½®
- é¢„ç®—å’Œç›®æ ‡ç®¡ç†

#### å…³é”®ä»£ç å®ç°

```python
# routers/projects.py
@router.post("/", response_model=ProjectResponse)
async def create_project(
    project: ProjectCreate,
    current_user: User = Depends(get_current_user)
):
    """åˆ›å»ºé¡¹ç›®"""

    # éªŒè¯æƒé™
    if current_user.role not in ["admin", "manager"]:
        raise HTTPException(403, "æƒé™ä¸è¶³")

    # åˆ›å»ºé¡¹ç›®
    db_project = Project(
        name=project.name,
        client_name=project.client_name,
        pricing_model=project.pricing_model,
        lead_price=project.lead_price,
        setup_fee=project.setup_fee,
        monthly_budget=project.monthly_budget,
        created_by=current_user.id
    )

    db.add(db_project)
    db.commit()
    db.refresh(db_project)

    # è®°å½•å®¡è®¡æ—¥å¿—
    audit_logger.log_create(
        table_name="projects",
        record_id=str(db_project.id),
        new_values=project.dict(),
        user_id=current_user.id
    )

    return db_project

@router.get("/", response_model=List[ProjectResponse])
async def list_projects(
    skip: int = 0,
    limit: int = 100,
    status: Optional[str] = None,
    current_user: User = Depends(get_current_user)
):
    """è·å–é¡¹ç›®åˆ—è¡¨"""

    query = db.query(Project)

    # æ ¹æ®ç”¨æˆ·è§’è‰²è¿‡æ»¤
    if current_user.role == "media_buyer":
        # æŠ•æ‰‹åªèƒ½çœ‹åˆ°åˆ†é…ç»™è‡ªå·±çš„é¡¹ç›®
        query = query.join(AdAccount).filter(
            AdAccount.assigned_user_id == current_user.id
        )
    elif current_user.role in ["data_clerk", "finance"]:
        # æ•°æ®å‘˜å’Œè´¢åŠ¡å¯ä»¥çœ‹åˆ°æ‰€æœ‰é¡¹ç›®
        pass

    # çŠ¶æ€è¿‡æ»¤
    if status:
        query = query.filter(Project.status == status)

    projects = query.offset(skip).limit(limit).all()
    return projects
```

### 5.2 æ¸ é“ç®¡ç†æ¨¡å—

#### åŠŸèƒ½ç‰¹æ€§
- ä»£ç†å•†ä¿¡æ¯ç®¡ç†
- è´¨é‡è¯„ä¼°ç³»ç»Ÿ
- è´¹ç”¨ç»“æ„é…ç½®
- è¡¨ç°ç»Ÿè®¡åˆ†æ

#### è´¨é‡è¯„ä¼°å®ç°

```python
# services/channel_service.py
class ChannelService:

    async def evaluate_channel_quality(self, channel_id: str):
        """è¯„ä¼°æ¸ é“è´¨é‡"""

        # è·å–æ¸ é“è´¦æˆ·æ•°æ®
        accounts = db.query(AdAccount).filter(
            AdAccount.channel_id == channel_id
        ).all()

        if not accounts:
            return {"score": 0, "details": "æ— è´¦æˆ·æ•°æ®"}

        # è®¡ç®—å­˜æ´»ç‡
        total_accounts = len(accounts)
        active_accounts = len([a for a in accounts if a.status == "active"])
        survival_rate = active_accounts / total_accounts if total_accounts > 0 else 0

        # è®¡ç®—å¹³å‡å¯¿å‘½
        lifetimes = []
        for account in accounts:
            if account.dead_date:
                lifetime = (account.dead_date - account.created_date).days
                lifetimes.append(lifetime)

        avg_lifetime = sum(lifetimes) / len(lifetimes) if lifetimes else 0

        # è®¡ç®—ç»¼åˆè¯„åˆ†
        quality_score = (
            survival_rate * 0.4 +  # å­˜æ´»ç‡æƒé‡40%
            min(avg_lifetime / 30, 1) * 0.3 +  # å¹³å‡å¯¿å‘½æƒé‡30%
            self.calculate_price_competitiveness(channel_id) * 0.3  # ä»·æ ¼ç«äº‰åŠ›æƒé‡30%
        )

        # æ›´æ–°æ¸ é“è¯„åˆ†
        channel = db.query(Channel).filter(Channel.id == channel_id).first()
        channel.quality_score = quality_score
        channel.total_accounts = total_accounts
        channel.active_accounts = active_accounts

        db.commit()

        return {
            "score": quality_score,
            "survival_rate": survival_rate,
            "avg_lifetime": avg_lifetime,
            "total_accounts": total_accounts,
            "active_accounts": active_accounts
        }

    def calculate_price_competitiveness(self, channel_id: str):
        """è®¡ç®—ä»·æ ¼ç«äº‰åŠ›"""

        channel = db.query(Channel).filter(Channel.id == channel_id).first()

        # è·å–æ‰€æœ‰æ¸ é“çš„å¹³å‡è´¹ç‡
        avg_fee_rate = db.query(func.avg(Channel.service_fee_rate)).scalar() or 0.1

        # è®¡ç®—ç«äº‰åŠ› (è´¹ç‡è¶Šä½ç«äº‰åŠ›è¶Šé«˜)
        if channel.service_fee_rate <= avg_fee_rate:
            return 1.0
        else:
            return max(0, 1 - (channel.service_fee_rate - avg_fee_rate) / avg_fee_rate)
```

### 5.3 å¹¿å‘Šè´¦æˆ·ç®¡ç†æ¨¡å—

#### åŠŸèƒ½ç‰¹æ€§
- è´¦æˆ·ç”Ÿå‘½å‘¨æœŸç®¡ç†
- çŠ¶æ€è·Ÿè¸ªå’Œé¢„è­¦
- é¢„ç®—ç›‘æ§
- æ€§èƒ½åˆ†æ

#### ç”Ÿå‘½å‘¨æœŸç®¡ç†å®ç°

```python
# services/account_service.py
class AccountService:

    async def update_account_status(self, account_id: str, new_status: str,
                                  reason: str = None, user_id: str = None):
        """æ›´æ–°è´¦æˆ·çŠ¶æ€"""

        account = db.query(AdAccount).filter(AdAccount.id == account_id).first()
        if not account:
            raise HTTPException(404, "è´¦æˆ·ä¸å­˜åœ¨")

        old_status = account.status

        # æ›´æ–°çŠ¶æ€
        account.status = new_status
        account.status_reason = reason
        account.last_status_change = datetime.utcnow()

        # æ›´æ–°æ—¶é—´æˆ³
        if new_status == "active" and old_status != "active":
            account.activated_date = datetime.utcnow()
        elif new_status == "suspended":
            account.suspended_date = datetime.utcnow()
        elif new_status == "dead":
            account.dead_date = datetime.utcnow()
        elif new_status == "archived":
            account.archived_date = datetime.utcnow()

        # è®°å½•çŠ¶æ€å˜æ›´å†å²
        status_history = AccountStatusHistory(
            account_id=account_id,
            old_status=old_status,
            new_status=new_status,
            change_reason=reason,
            changed_at=datetime.utcnow(),
            changed_by=user_id
        )

        db.add(status_history)

        # è®°å½•å®¡è®¡æ—¥å¿—
        audit_logger.log_update(
            table_name="ad_accounts",
            record_id=account_id,
            old_values={"status": old_status},
            new_values={"status": new_status, "reason": reason},
            user_id=user_id
        )

        db.commit()

        # å‘é€é€šçŸ¥
        await notify_account_status_change(account, old_status, new_status)

        return account

    async def check_account_alerts(self):
        """æ£€æŸ¥è´¦æˆ·é¢„è­¦"""

        # æ£€æŸ¥é¢„ç®—é¢„è­¦
        accounts = db.query(AdAccount).filter(
            AdAccount.status == "active",
            AdAccount.auto_monitoring == True
        ).all()

        for account in accounts:
            alerts = []

            # é¢„ç®—ä½¿ç”¨ç‡é¢„è­¦
            if account.remaining_budget and account.daily_budget:
                usage_rate = 1 - (account.remaining_budget / account.total_budget)
                if usage_rate > 0.8:
                    alerts.append({
                        "type": "budget_exceeded",
                        "severity": "high",
                        "message": f"è´¦æˆ· {account.name} é¢„ç®—ä½¿ç”¨ç‡å·²è¾¾ {usage_rate:.1%}"
                    })

            # æ€§èƒ½é¢„è­¦
            if account.avg_cpl and account.target_cpl:
                if account.avg_cpl > account.target_cpl * 1.5:
                    alerts.append({
                        "type": "high_cpl",
                        "severity": "medium",
                        "message": f"è´¦æˆ· {account.name} å•ç²‰æˆæœ¬è¿‡é«˜: {account.avg_cpl}"
                    })

            # åˆ›å»ºé¢„è­¦è®°å½•
            for alert_data in alerts:
                alert = AccountAlert(
                    account_id=account.id,
                    alert_type=alert_data["type"],
                    severity=alert_data["severity"],
                    title=f"è´¦æˆ·é¢„è­¦: {alert_data['type']}",
                    message=alert_data["message"],
                    status="active"
                )
                db.add(alert)

        if alerts:
            db.commit()
            await send_alert_notifications(alerts)
```

### 5.4 æƒé™ç®¡ç†æ¨¡å—

#### è§’è‰²æƒé™çŸ©é˜µ

| åŠŸèƒ½æ¨¡å— | ç®¡ç†å‘˜ | é¡¹ç›®ç»ç† | æ•°æ®å‘˜ | è´¢åŠ¡ | æŠ•æ‰‹ |
|---------|--------|----------|--------|------|------|
| é¡¹ç›®ç®¡ç† | å…¨éƒ¨ | è¯»å†™ | åªè¯» | åªè¯» | åªè¯»(è‡ªå·±çš„) |
| æ¸ é“ç®¡ç† | å…¨éƒ¨ | è¯»å†™ | è¯»å†™ | åªè¯» | æ—  |
| è´¦æˆ·ç®¡ç† | å…¨éƒ¨ | è¯»å†™ | è¯»å†™ | åªè¯» | åªè¯»(è‡ªå·±çš„) |
| æ—¥æŠ¥ç®¡ç† | å…¨éƒ¨ | è¯»å†™ | è¯»å†™ | åªè¯» | è¯»å†™(è‡ªå·±çš„) |
| å……å€¼ç®¡ç† | å…¨éƒ¨ | åªè¯» | å®¡æ ¸ | å®¡æ‰¹æ‰§è¡Œ | ç”³è¯· |
| å¯¹è´¦ç®¡ç† | å…¨éƒ¨ | åªè¯» | åªè¯» | è¯»å†™ | æ—  |

#### æƒé™å®ç°

```python
# core/permissions.py
class PermissionChecker:

    @staticmethod
    def can_access_project(user: User, project_id: str, action: str) -> bool:
        """æ£€æŸ¥é¡¹ç›®è®¿é—®æƒé™"""

        project = db.query(Project).filter(Project.id == project_id).first()
        if not project:
            return False

        # ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
        if user.role == "admin":
            return True

        # é¡¹ç›®ç»ç†å¯ä»¥ç®¡ç†è‡ªå·±çš„é¡¹ç›®
        if user.role == "manager" and project.manager_id == user.id:
            return True

        # æŠ•æ‰‹åªèƒ½æŸ¥çœ‹åˆ†é…ç»™è‡ªå·±çš„é¡¹ç›®
        if user.role == "media_buyer":
            account = db.query(AdAccount).filter(
                AdAccount.project_id == project_id,
                AdAccount.assigned_user_id == user.id
            ).first()
            return account is not None and action in ["read"]

        # å…¶ä»–è§’è‰²æ ¹æ®å…·ä½“æƒé™åˆ¤æ–­
        return action in ["read"]

    @staticmethod
    def can_manage_account(user: User, account_id: str, action: str) -> bool:
        """æ£€æŸ¥è´¦æˆ·ç®¡ç†æƒé™"""

        account = db.query(AdAccount).filter(AdAccount.id == account_id).first()
        if not account:
            return False

        # ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
        if user.role == "admin":
            return True

        # é¡¹ç›®ç»ç†å’Œæ•°æ®å‘˜å¯ä»¥ç®¡ç†æ‰€æœ‰è´¦æˆ·
        if user.role in ["manager", "data_clerk"]:
            return True

        # æŠ•æ‰‹åªèƒ½ç®¡ç†åˆ†é…ç»™è‡ªå·±çš„è´¦æˆ·
        if user.role == "media_buyer" and account.assigned_user_id == user.id:
            return action in ["read", "update_performance"]

        return False

# æƒé™è£…é¥°å™¨
def require_permission(resource: str, action: str):
    """æƒé™éªŒè¯è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            current_user = kwargs.get('current_user')
            if not current_user:
                raise HTTPException(401, "æœªè®¤è¯")

            # è·å–èµ„æºID
            resource_id = kwargs.get(f"{resource}_id")
            if not resource_id:
                raise HTTPException(400, f"ç¼ºå°‘{resource}_idå‚æ•°")

            # æ£€æŸ¥æƒé™
            checker = PermissionChecker()
            has_permission = getattr(checker, f"can_{action}_{resource}")(current_user, resource_id, action)

            if not has_permission:
                raise HTTPException(403, "æƒé™ä¸è¶³")

            return await func(*args, **kwargs)
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@router.put("/accounts/{account_id}")
@require_permission(resource="account", action="update")
async def update_account(
    account_id: str,
    account_update: AccountUpdate,
    current_user: User = Depends(get_current_user)
):
    """æ›´æ–°è´¦æˆ·ä¿¡æ¯"""
    # ä¸šåŠ¡é€»è¾‘...
    pass
```

---

## 6. æ•°æ®æ¨¡å‹ä¸APIè®¾è®¡

### 6.1 æ•°æ®åº“è®¾è®¡

#### æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- é¡¹ç›®è¡¨
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    client_name VARCHAR(255) NOT NULL,
    pricing_model VARCHAR(50) DEFAULT 'per_lead',
    lead_price DECIMAL(10,2) NOT NULL,
    setup_fee DECIMAL(10,2) DEFAULT 0,
    status VARCHAR(20) DEFAULT 'planning',
    monthly_budget DECIMAL(12,2),
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- æ¸ é“è¡¨
CREATE TABLE channels (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    service_fee_rate DECIMAL(5,4) NOT NULL, -- 0.05 = 5%
    account_setup_fee DECIMAL(10,2) DEFAULT 0,
    quality_score DECIMAL(3,2), -- 0-10åˆ†
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW()
);

-- å¹¿å‘Šè´¦æˆ·è¡¨
CREATE TABLE ad_accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_id VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    project_id UUID REFERENCES projects(id),
    channel_id UUID REFERENCES channels(id),
    assigned_user_id UUID REFERENCES users(id),
    status VARCHAR(20) DEFAULT 'new',
    daily_budget DECIMAL(10,2),
    total_budget DECIMAL(12,2),
    remaining_budget DECIMAL(12,2),
    currency VARCHAR(3) DEFAULT 'USD',
    total_spend DECIMAL(15,2) DEFAULT 0,
    total_leads INTEGER DEFAULT 0,
    avg_cpl DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT NOW()
);

-- æ¯æ—¥æ¶ˆè€—è¡¨
CREATE TABLE ad_spend_daily (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id),
    ad_account_id UUID REFERENCES ad_accounts(id),
    user_id UUID REFERENCES users(id),
    date DATE NOT NULL,
    leads_submitted INTEGER DEFAULT 0,
    leads_confirmed INTEGER,
    spend DECIMAL(15,2) NOT NULL,
    confirmed_by UUID REFERENCES users(id),
    confirmed_at TIMESTAMP,
    leads_diff INTEGER,
    diff_reason TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- å……å€¼è¡¨
CREATE TABLE topups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id),
    ad_account_id UUID REFERENCES ad_accounts(id),
    requested_by UUID REFERENCES users(id),
    amount DECIMAL(15,2) NOT NULL,
    purpose TEXT,
    status VARCHAR(20) DEFAULT 'pending',
    fee_rate DECIMAL(5,4) NOT NULL,
    fee_amount DECIMAL(15,2) NOT NULL,
    total_amount DECIMAL(15,2) NOT NULL,
    clerk_approval JSONB,
    finance_approval JSONB,
    transaction_id VARCHAR(255),
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### ç´¢å¼•è®¾è®¡

```sql
-- æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_client ON projects(client_name);
CREATE INDEX idx_ad_accounts_project ON ad_accounts(project_id);
CREATE INDEX idx_ad_accounts_user ON ad_accounts(assigned_user_id);
CREATE INDEX idx_ad_accounts_status ON ad_accounts(status);
CREATE INDEX idx_ad_spend_daily_date ON ad_spend_daily(date);
CREATE INDEX idx_ad_spend_daily_project ON ad_spend_daily(project_id);
CREATE INDEX idx_ad_spend_daily_user ON ad_spend_daily(user_id);
CREATE INDEX idx_topups_status ON topups(status);
CREATE INDEX idx_topups_project ON topups(project_id);
CREATE INDEX idx_audit_logs_user ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_created ON audit_logs(created_at);
```

### 6.2 APIæ¥å£è®¾è®¡

#### RESTful APIè§„èŒƒ

```
# é¡¹ç›®ç®¡ç†
GET    /api/projects              # è·å–é¡¹ç›®åˆ—è¡¨
POST   /api/projects              # åˆ›å»ºé¡¹ç›®
GET    /api/projects/{id}         # è·å–é¡¹ç›®è¯¦æƒ…
PUT    /api/projects/{id}         # æ›´æ–°é¡¹ç›®
DELETE /api/projects/{id}         # åˆ é™¤é¡¹ç›®

# æ¸ é“ç®¡ç†
GET    /api/channels              # è·å–æ¸ é“åˆ—è¡¨
POST   /api/channels              # åˆ›å»ºæ¸ é“
GET    /api/channels/{id}         # è·å–æ¸ é“è¯¦æƒ…
PUT    /api/channels/{id}         # æ›´æ–°æ¸ é“
POST   /api/channels/{id}/evaluate # è¯„ä¼°æ¸ é“è´¨é‡

# å¹¿å‘Šè´¦æˆ·ç®¡ç†
GET    /api/accounts              # è·å–è´¦æˆ·åˆ—è¡¨
POST   /api/accounts              # åˆ›å»ºè´¦æˆ·
GET    /api/accounts/{id}         # è·å–è´¦æˆ·è¯¦æƒ…
PUT    /api/accounts/{id}         # æ›´æ–°è´¦æˆ·
PUT    /api/accounts/{id}/status  # æ›´æ–°è´¦æˆ·çŠ¶æ€
GET    /api/accounts/{id}/performance # è·å–è´¦æˆ·è¡¨ç°

# æ—¥æŠ¥ç®¡ç†
GET    /api/daily-reports         # è·å–æ—¥æŠ¥åˆ—è¡¨
POST   /api/daily-reports         # æäº¤æ—¥æŠ¥
PUT    /api/daily-reports/{id}/confirm # ç¡®è®¤ç²‰æ•°
GET    /api/daily-reports/summary  # è·å–æ±‡æ€»æ•°æ®

# å……å€¼ç®¡ç†
GET    /api/topups                # è·å–å……å€¼åˆ—è¡¨
POST   /api/topups/request        # ç”³è¯·å……å€¼
PUT    /api/topups/{id}/clerk-approval  # æ•°æ®å‘˜å®¡æ‰¹
PUT    /api/topups/{id}/finance-approval # è´¢åŠ¡å®¡æ‰¹
GET    /api/topups/summary        # å……å€¼æ±‡æ€»

# å¯¹è´¦ç®¡ç†
GET    /api/reconciliation        # è·å–å¯¹è´¦è®°å½•
POST   /api/reconciliation/monthly # æœˆåº¦å¯¹è´¦
GET    /api/reconciliation/{id}/report  # å¯¹è´¦æŠ¥å‘Š

# ç”¨æˆ·è®¤è¯
POST   /api/auth/login            # ç”¨æˆ·ç™»å½•
POST   /api/auth/logout           # ç”¨æˆ·ç™»å‡º
GET    /api/auth/me               # è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
PUT    /api/auth/password         # ä¿®æ”¹å¯†ç 
```

#### APIå“åº”æ ¼å¼

```python
# æˆåŠŸå“åº”
{
    "success": true,
    "data": {
        // å®é™…æ•°æ®
    },
    "message": "æ“ä½œæˆåŠŸ",
    "timestamp": "2025-11-10T10:30:00Z"
}

# é”™è¯¯å“åº”
{
    "success": false,
    "error": {
        "code": "VALIDATION_ERROR",
        "message": "è¾“å…¥æ•°æ®éªŒè¯å¤±è´¥",
        "details": {
            "field": "email",
            "reason": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
        }
    },
    "timestamp": "2025-11-10T10:30:00Z"
}

# åˆ†é¡µå“åº”
{
    "success": true,
    "data": {
        "items": [...],
        "pagination": {
            "page": 1,
            "size": 20,
            "total": 100,
            "pages": 5
        }
    }
}
```

### 6.3 æ•°æ®éªŒè¯ä¸å®‰å…¨

#### Pydanticæ¨¡å‹

```python
# schemas/projects.py
from pydantic import BaseModel, validator
from typing import Optional
from datetime import datetime

class ProjectBase(BaseModel):
    name: str
    client_name: str
    pricing_model: str = "per_lead"
    lead_price: float
    setup_fee: float = 0
    monthly_budget: Optional[float] = None
    description: Optional[str] = None

class ProjectCreate(ProjectBase):
    @validator('lead_price')
    def lead_price_must_be_positive(cls, v):
        if v <= 0:
            raise ValueError('å•ç²‰ä»·æ ¼å¿…é¡»å¤§äº0')
        return v

    @validator('pricing_model')
    def validate_pricing_model(cls, v):
        if v not in ['per_lead', 'fixed_fee', 'hybrid']:
            raise ValueError('æ— æ•ˆçš„æ”¶è´¹æ¨¡å¼')
        return v

class ProjectUpdate(BaseModel):
    name: Optional[str] = None
    client_name: Optional[str] = None
    status: Optional[str] = None
    monthly_budget: Optional[float] = None

    @validator('status')
    def validate_status(cls, v):
        if v and v not in ['planning', 'active', 'paused', 'completed', 'cancelled']:
            raise ValueError('æ— æ•ˆçš„é¡¹ç›®çŠ¶æ€')
        return v

class ProjectResponse(ProjectBase):
    id: str
    status: str
    created_at: datetime
    updated_at: datetime
    manager: Optional[dict] = None

    class Config:
        from_attributes = True
```

#### æ•°æ®åº“å®‰å…¨

```sql
-- è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)
-- å¯ç”¨RLS
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE ad_accounts ENABLE ROW LEVEL SECURITY;
ALTER TABLE ad_spend_daily ENABLE ROW LEVEL SECURITY;

-- é¡¹ç›®è®¿é—®ç­–ç•¥
CREATE POLICY project_access_policy ON projects
    USING (
        -- ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰é¡¹ç›®
        created_by = current_setting('app.current_user_id')::uuid
        OR
        -- é¡¹ç›®ç»ç†å¯ä»¥è®¿é—®è‡ªå·±çš„é¡¹ç›®
        manager_id = current_setting('app.current_user_id')::uuid
        OR
        -- æŠ•æ‰‹å¯ä»¥è®¿é—®åˆ†é…ç»™è‡ªå·±çš„é¡¹ç›®
        EXISTS (
            SELECT 1 FROM ad_accounts
            WHERE ad_accounts.project_id = projects.id
            AND ad_accounts.assigned_user_id = current_setting('app.current_user_id')::uuid
        )
    );

-- è´¦æˆ·è®¿é—®ç­–ç•¥
CREATE POLICY account_access_policy ON ad_accounts
    USING (
        -- ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰è´¦æˆ·
        current_setting('app.current_role') = 'admin'
        OR
        -- é¡¹ç›®ç»ç†å’Œæ•°æ®å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰è´¦æˆ·
        current_setting('app.current_role') IN ('manager', 'data_clerk')
        OR
        -- æŠ•æ‰‹åªèƒ½è®¿é—®åˆ†é…ç»™è‡ªå·±çš„è´¦æˆ·
        assigned_user_id = current_setting('app.current_user_id')::uuid
    );
```

---

## 7. å‰ç«¯å¼€å‘å®ç°

### 7.1 é¡¹ç›®ç»“æ„

```
app/
â”œâ”€â”€ layout.tsx                 # æ ¹å¸ƒå±€
â”œâ”€â”€ page.tsx                   # é¦–é¡µ
â”œâ”€â”€ globals.css                # å…¨å±€æ ·å¼
â”œâ”€â”€ components/                # ç»„ä»¶åº“
â”‚   â”œâ”€â”€ ui/                    # åŸºç¡€UIç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”œâ”€â”€ input.tsx
â”‚   â”‚   â”œâ”€â”€ table.tsx
â”‚   â”‚   â””â”€â”€ modal.tsx
â”‚   â”œâ”€â”€ auth/                  # è®¤è¯ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ login-form.tsx
â”‚   â”‚   â””â”€â”€ protected-route.tsx
â”‚   â””â”€â”€ business/              # ä¸šåŠ¡ç»„ä»¶
â”‚       â”œâ”€â”€ project-card.tsx
â”‚       â”œâ”€â”€ account-table.tsx
â”‚       â””â”€â”€ topup-form.tsx
â”œâ”€â”€ lib/                       # å·¥å…·åº“
â”‚   â”œâ”€â”€ api.ts                 # APIå®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ auth.ts                # è®¤è¯å·¥å…·
â”‚   â””â”€â”€ utils.ts               # é€šç”¨å·¥å…·
â”œâ”€â”€ hooks/                     # è‡ªå®šä¹‰Hook
â”‚   â”œâ”€â”€ use-auth.ts
â”‚   â”œâ”€â”€ use-api.ts
â”‚   â””â”€â”€ use-permissions.ts
â””â”€â”€ app/                       # é¡µé¢è·¯ç”±
    â”œâ”€â”€ auth/
    â”œâ”€â”€ projects/
    â”œâ”€â”€ accounts/
    â”œâ”€â”€ finance/
    â””â”€â”€ reports/
```

### 7.2 è®¤è¯å®ç°

```typescript
// lib/auth.ts
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!

export const supabase = createClient(supabaseUrl, supabaseAnonKey)

export interface User {
  id: string
  email: string
  role: 'admin' | 'manager' | 'data_clerk' | 'finance' | 'media_buyer'
  name: string
}

export async function signIn(email: string, password: string) {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  })

  if (error) throw error

  // è·å–ç”¨æˆ·è§’è‰²ç­‰ä¿¡æ¯
  const { data: userData } = await supabase
    .from('users')
    .select('*')
    .eq('id', data.user?.id)
    .single()

  return { ...data, user: { ...data.user, ...userData } }
}

export async function signOut() {
  const { error } = await supabase.auth.signOut()
  if (error) throw error
}

// hooks/use-auth.ts
import { createContext, useContext, useEffect, useState } from 'react'
import { User, supabase } from '@/lib/auth'

interface AuthContextType {
  user: User | null
  loading: boolean
  signIn: (email: string, password: string) => Promise<void>
  signOut: () => Promise<void>
}

const AuthContext = createContext<AuthContextType | undefined>(undefined)

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    // è·å–åˆå§‹ä¼šè¯
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session?.user) {
        fetchUser(session.user.id).then(setUser)
      }
      setLoading(false)
    })

    // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        if (session?.user) {
          const userData = await fetchUser(session.user.id)
          setUser(userData)
        } else {
          setUser(null)
        }
        setLoading(false)
      }
    )

    return () => subscription.unsubscribe()
  }, [])

  async function fetchUser(userId: string): Promise<User | null> {
    const { data } = await supabase
      .from('users')
      .select('*')
      .eq('id', userId)
      .single()

    return data
  }

  const value = {
    user,
    loading,
    signIn: async (email: string, password: string) => {
      const { data } = await signIn(email, password)
      setUser(data.user as User)
    },
    signOut: async () => {
      await signOut()
      setUser(null)
    }
  }

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  )
}

export function useAuth() {
  const context = useContext(AuthContext)
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider')
  }
  return context
}
```

### 7.3 APIå®¢æˆ·ç«¯

```typescript
// lib/api.ts
import { useAuth } from '@/hooks/use-auth'

class ApiClient {
  private baseURL: string

  constructor(baseURL: string = '/api') {
    this.baseURL = baseURL
  }

  private async request<T>(
    endpoint: string,
    options: RequestInit = {}
  ): Promise<T> {
    const { user } = useAuth()

    const url = `${this.baseURL}${endpoint}`
    const config: RequestInit = {
      headers: {
        'Content-Type': 'application/json',
        ...options.headers,
      },
      ...options,
    }

    // æ·»åŠ è®¤è¯å¤´
    if (user?.id) {
      config.headers = {
        ...config.headers,
        Authorization: `Bearer ${await getAuthToken()}`
      }
    }

    const response = await fetch(url, config)

    if (!response.ok) {
      const error = await response.json()
      throw new Error(error.message || 'APIè¯·æ±‚å¤±è´¥')
    }

    return response.json()
  }

  // é¡¹ç›®ç›¸å…³API
  async getProjects(params?: {
    skip?: number
    limit?: number
    status?: string
  }) {
    const searchParams = new URLSearchParams(params as any).toString()
    return this.request(`/projects?${searchParams}`)
  }

  async createProject(data: ProjectCreate) {
    return this.request('/projects', {
      method: 'POST',
      body: JSON.stringify(data),
    })
  }

  async updateProject(id: string, data: ProjectUpdate) {
    return this.request(`/projects/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    })
  }

  // è´¦æˆ·ç›¸å…³API
  async getAccounts(params?: {
    projectId?: string
    userId?: string
    status?: string
  }) {
    const searchParams = new URLSearchParams(params as any).toString()
    return this.request(`/accounts?${searchParams}`)
  }

  async updateAccountStatus(id: string, status: string, reason?: string) {
    return this.request(`/accounts/${id}/status`, {
      method: 'PUT',
      body: JSON.stringify({ status, reason }),
    })
  }

  // æ—¥æŠ¥ç›¸å…³API
  async submitDailyReport(data: DailyReportCreate) {
    return this.request('/daily-reports', {
      method: 'POST',
      body: JSON.stringify(data),
    })
  }

  async confirmDailyReport(id: string, data: { leads_confirmed: number, reason?: string }) {
    return this.request(`/daily-reports/${id}/confirm`, {
      method: 'PUT',
      body: JSON.stringify(data),
    })
  }

  // å……å€¼ç›¸å…³API
  async createTopupRequest(data: TopupRequest) {
    return this.request('/topups/request', {
      method: 'POST',
      body: JSON.stringify(data),
    })
  }

  async clerkApproval(id: string, data: ClerkApproval) {
    return this.request(`/topups/${id}/clerk-approval`, {
      method: 'PUT',
      body: JSON.stringify(data),
    })
  }

  async financeApproval(id: string, data: FinanceApproval) {
    return this.request(`/topups/${id}/finance-approval`, {
      method: 'PUT',
      body: JSON.stringify(data),
    })
  }
}

export const apiClient = new ApiClient()

// hooks/use-api.ts
import { useState, useEffect } from 'react'
import { apiClient } from '@/lib/api'

export function useApi<T>(
  apiCall: () => Promise<T>,
  dependencies: any[] = []
) {
  const [data, setData] = useState<T | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<Error | null>(null)

  useEffect(() => {
    let cancelled = false

    async function fetchData() {
      try {
        setLoading(true)
        setError(null)
        const result = await apiCall()
        if (!cancelled) {
          setData(result)
        }
      } catch (err) {
        if (!cancelled) {
          setError(err as Error)
        }
      } finally {
        if (!cancelled) {
          setLoading(false)
        }
      }
    }

    fetchData()

    return () => {
      cancelled = true
    }
  }, dependencies)

  return { data, loading, error, refetch: () => fetchData() }
}
```

### 7.4 ä¸šåŠ¡ç»„ä»¶ç¤ºä¾‹

```typescript
// components/business/project-card.tsx
import { Project } from '@/types'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { formatCurrency, formatDate } from '@/lib/utils'

interface ProjectCardProps {
  project: Project
  onEdit?: (project: Project) => void
  onDelete?: (project: Project) => void
}

export function ProjectCard({ project, onEdit, onDelete }: ProjectCardProps) {
  const getStatusColor = (status: string) => {
    switch (status) {
      case 'active': return 'bg-green-100 text-green-800'
      case 'planning': return 'bg-blue-100 text-blue-800'
      case 'paused': return 'bg-yellow-100 text-yellow-800'
      case 'completed': return 'bg-gray-100 text-gray-800'
      default: return 'bg-gray-100 text-gray-800'
    }
  }

  const getStatusText = (status: string) => {
    switch (status) {
      case 'active': return 'è¿›è¡Œä¸­'
      case 'planning': return 'è§„åˆ’ä¸­'
      case 'paused': return 'æš‚åœ'
      case 'completed': return 'å·²å®Œæˆ'
      default: return status
    }
  }

  return (
    <Card className="hover:shadow-md transition-shadow">
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle className="text-lg">{project.name}</CardTitle>
          <Badge className={getStatusColor(project.status)}>
            {getStatusText(project.status)}
          </Badge>
        </div>
        <p className="text-sm text-gray-600">
          å®¢æˆ·: {project.client_name}
        </p>
      </CardHeader>

      <CardContent>
        <div className="space-y-2">
          <div className="flex justify-between text-sm">
            <span>æ”¶è´¹æ¨¡å¼:</span>
            <span>{project.pricing_model === 'per_lead' ? 'æŒ‰ç²‰è®¡è´¹' : 'å›ºå®šè´¹ç”¨'}</span>
          </div>

          {project.pricing_model === 'per_lead' && (
            <div className="flex justify-between text-sm">
              <span>å•ç²‰ä»·æ ¼:</span>
              <span>{formatCurrency(project.lead_price)}</span>
            </div>
          )}

          {project.monthly_budget && (
            <div className="flex justify-between text-sm">
              <span>æœˆåº¦é¢„ç®—:</span>
              <span>{formatCurrency(project.monthly_budget)}</span>
            </div>
          )}

          <div className="flex justify-between text-sm">
            <span>åˆ›å»ºæ—¶é—´:</span>
            <span>{formatDate(project.created_at)}</span>
          </div>
        </div>

        <div className="flex gap-2 mt-4">
          {onEdit && (
            <Button
              variant="outline"
              size="sm"
              onClick={() => onEdit(project)}
            >
              ç¼–è¾‘
            </Button>
          )}

          {onDelete && (
            <Button
              variant="destructive"
              size="sm"
              onClick={() => onDelete(project)}
            >
              åˆ é™¤
            </Button>
          )}
        </div>
      </CardContent>
    </Card>
  )
}

// components/business/topup-form.tsx
import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { useAuth } from '@/hooks/use-auth'
import { apiClient } from '@/lib/api'

interface TopupFormProps {
  accounts: Array<{ id: string; name: string; remaining_budget: number }>
  onSuccess?: () => void
}

interface TopupFormData {
  ad_account_id: string
  amount: number
  purpose: string
  urgency_level: 'normal' | 'urgent'
}

export function TopupForm({ accounts, onSuccess }: TopupFormProps) {
  const { user } = useAuth()
  const [loading, setLoading] = useState(false)
  const [selectedAccount, setSelectedAccount] = useState<string>('')

  const {
    register,
    handleSubmit,
    setValue,
    watch,
    formState: { errors }
  } = useForm<TopupFormData>()

  const watchedAccountId = watch('ad_account_id')
  const watchedAmount = watch('amount')

  // è®¡ç®—é¢„ä¼°è´¹ç”¨
  const selectedAccountData = accounts.find(a => a.id === watchedAccountId)
  const estimatedFee = selectedAccountData && watchedAmount
    ? watchedAmount * 0.1 // å‡è®¾10%æ‰‹ç»­è´¹
    : 0
  const totalAmount = (watchedAmount || 0) + estimatedFee

  const onSubmit = async (data: TopupFormData) => {
    try {
      setLoading(true)
      await apiClient.createTopupRequest(data)
      onSuccess?.()
    } catch (error) {
      console.error('æäº¤å……å€¼ç”³è¯·å¤±è´¥:', error)
    } finally {
      setLoading(false)
    }
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>ç”³è¯·å……å€¼</CardTitle>
      </CardHeader>

      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <div>
            <Label htmlFor="ad_account_id">å¹¿å‘Šè´¦æˆ·</Label>
            <Select
              value={watchedAccountId}
              onValueChange={(value) => setValue('ad_account_id', value)}
            >
              <SelectTrigger>
                <SelectValue placeholder="é€‰æ‹©å¹¿å‘Šè´¦æˆ·" />
              </SelectTrigger>
              <SelectContent>
                {accounts.map((account) => (
                  <SelectItem key={account.id} value={account.id}>
                    {account.name} (ä½™é¢: {account.remaining_budget})
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            {errors.ad_account_id && (
              <p className="text-red-500 text-sm mt-1">
                {errors.ad_account_id.message}
              </p>
            )}
          </div>

          <div>
            <Label htmlFor="amount">å……å€¼é‡‘é¢ (USD)</Label>
            <Input
              id="amount"
              type="number"
              step="0.01"
              placeholder="è¾“å…¥å……å€¼é‡‘é¢"
              {...register('amount', {
                required: 'è¯·è¾“å…¥å……å€¼é‡‘é¢',
                min: { value: 1, message: 'å……å€¼é‡‘é¢å¿…é¡»å¤§äº0' }
              })}
            />
            {errors.amount && (
              <p className="text-red-500 text-sm mt-1">
                {errors.amount.message}
              </p>
            )}
          </div>

          {watchedAmount && (
            <div className="bg-gray-50 p-3 rounded-md">
              <div className="flex justify-between text-sm">
                <span>å……å€¼é‡‘é¢:</span>
                <span>${watchedAmount.toFixed(2)}</span>
              </div>
              <div className="flex justify-between text-sm">
                <span>é¢„ä¼°æ‰‹ç»­è´¹ (10%):</span>
                <span>${estimatedFee.toFixed(2)}</span>
              </div>
              <div className="flex justify-between font-semibold border-t pt-2">
                <span>æ€»è®¡:</span>
                <span>${totalAmount.toFixed(2)}</span>
              </div>
            </div>
          )}

          <div>
            <Label htmlFor="purpose">å……å€¼ç”¨é€”</Label>
            <Textarea
              id="purpose"
              placeholder="è¯·è¯´æ˜å……å€¼ç”¨é€”..."
              {...register('purpose', {
                required: 'è¯·è¯´æ˜å……å€¼ç”¨é€”'
              })}
            />
            {errors.purpose && (
              <p className="text-red-500 text-sm mt-1">
                {errors.purpose.message}
              </p>
            )}
          </div>

          <div>
            <Label>ç´§æ€¥ç¨‹åº¦</Label>
            <Select
              value={watch('urgency_level')}
              onValueChange={(value) => setValue('urgency_level', value as any)}
            >
              <SelectTrigger>
                <SelectValue placeholder="é€‰æ‹©ç´§æ€¥ç¨‹åº¦" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="normal">æ™®é€š</SelectItem>
                <SelectItem value="urgent">ç´§æ€¥</SelectItem>
              </SelectContent>
            </Select>
          </div>

          <Button type="submit" disabled={loading} className="w-full">
            {loading ? 'æäº¤ä¸­...' : 'æäº¤ç”³è¯·'}
          </Button>
        </form>
      </CardContent>
    </Card>
  )
}
```

---

## 8. éƒ¨ç½²ä¸è¿ç»´

### 8.1 ç¯å¢ƒé…ç½®

#### ç”Ÿäº§ç¯å¢ƒå˜é‡

```bash
# .env.production
# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://user:password@host:port/database
SUPABASE_URL=your-supabase-url
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_KEY=your-service-key

# JWTé…ç½®
JWT_SECRET_KEY=your-jwt-secret-key
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30

# APIé…ç½®
API_V1_STR=/api/v1
PROJECT_NAME=AIå¹¿å‘Šä»£æŠ•ç³»ç»Ÿ
DEBUG=false

# CORSé…ç½®
BACKEND_CORS_ORIGINS=["https://yourdomain.com", "https://admin.yourdomain.com"]

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=10485760  # 10MB

# é‚®ä»¶é…ç½®
SMTP_TLS=true
SMTP_PORT=587
SMTP_HOST=smtp.gmail.com
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password

# ç›‘æ§é…ç½®
SENTRY_DSN=your-sentry-dsn
LOG_LEVEL=INFO
```

#### Dockeré…ç½®

```dockerfile
# Dockerfile
FROM node:18-alpine AS frontend-builder

WORKDIR /app/frontend
COPY app/package*.json ./
RUN npm ci --only=production

COPY app/ ./
RUN npm run build

FROM python:3.11-slim AS backend

WORKDIR /app/backend

RUN apt-get update && apt-get install -y \
    gcc \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

COPY backend/requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

COPY backend/ ./
COPY --from=frontend-builder /app/frontend/public ./public

EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/ad_spend
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: ad_spend
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app

volumes:
  postgres_data:
  redis_data:
```

### 8.2 Nginxé…ç½®

```nginx
# nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream backend {
        server app:8000;
    }

    server {
        listen 80;
        server_name yourdomain.com www.yourdomain.com;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name yourdomain.com www.yourdomain.com;

        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # å‰ç«¯é™æ€æ–‡ä»¶
        location / {
            root /var/www/html;
            try_files $uri $uri/ /index.html;

            # ç¼“å­˜é™æ€èµ„æº
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # APIä»£ç†
        location /api/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
        client_max_body_size 10M;

        # å®‰å…¨å¤´
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    }
}
```

### 8.3 æ•°æ®åº“ç®¡ç†

#### è¿ç§»è„šæœ¬

```python
# alembic/versions/001_initial_schema.py
"""Initial schema

Revision ID: 001
Revises:
Create Date: 2025-11-10 10:00:00.000000

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers
revision = '001'
down_revision = None
branch_labels = None
depends_on = None

def upgrade():
    # åˆ›å»ºç”¨æˆ·è¡¨
    op.create_table('users',
        sa.Column('id', postgresql.UUID(as_uuid=True), nullable=False),
        sa.Column('email', sa.String(length=255), nullable=False),
        sa.Column('hashed_password', sa.String(length=255), nullable=False),
        sa.Column('full_name', sa.String(length=255), nullable=True),
        sa.Column('role', sa.String(length=50), nullable=False),
        sa.Column('is_active', sa.Boolean(), nullable=True),
        sa.Column('created_at', sa.DateTime(), nullable=True),
        sa.Column('updated_at', sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('email')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=False)
    op.create_index(op.f('ix_users_role'), 'users', ['role'], unique=False)

    # åˆ›å»ºé¡¹ç›®è¡¨
    op.create_table('projects',
        sa.Column('id', postgresql.UUID(as_uuid=True), nullable=False),
        sa.Column('name', sa.String(length=255), nullable=False),
        sa.Column('client_name', sa.String(length=255), nullable=False),
        sa.Column('pricing_model', sa.String(length=50), nullable=False),
        sa.Column('lead_price', sa.Numeric(precision=10, scale=2), nullable=False),
        sa.Column('setup_fee', sa.Numeric(precision=10, scale=2), nullable=True),
        sa.Column('status', sa.String(length=20), nullable=False),
        sa.Column('monthly_budget', sa.Numeric(precision=12, scale=2), nullable=True),
        sa.Column('created_by', postgresql.UUID(as_uuid=True), nullable=False),
        sa.Column('created_at', sa.DateTime(), nullable=True),
        sa.Column('updated_at', sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(['created_by'], ['users.id'], ),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_projects_client_name'), 'projects', ['client_name'], unique=False)
    op.create_index(op.f('ix_projects_status'), 'projects', ['status'], unique=False)

    # ... å…¶ä»–è¡¨çš„åˆ›å»º

def downgrade():
    op.drop_table('projects')
    op.drop_table('users')
```

#### å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# scripts/backup.sh

# é…ç½®
DB_HOST="localhost"
DB_PORT="5432"
DB_NAME="ad_spend"
DB_USER="postgres"
BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ•°æ®åº“å¤‡ä»½
echo "å¼€å§‹æ•°æ®åº“å¤‡ä»½..."
pg_dump -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME \
    --format=custom \
    --compress=9 \
    --file=$BACKUP_DIR/db_backup_$DATE.dump

if [ $? -eq 0 ]; then
    echo "æ•°æ®åº“å¤‡ä»½æˆåŠŸ: $BACKUP_DIR/db_backup_$DATE.dump"
else
    echo "æ•°æ®åº“å¤‡ä»½å¤±è´¥!"
    exit 1
fi

# æ–‡ä»¶å¤‡ä»½
echo "å¼€å§‹æ–‡ä»¶å¤‡ä»½..."
tar -czf $BACKUP_DIR/files_backup_$DATE.tar.gz \
    uploads/ \
    logs/ \
    .env.production

if [ $? -eq 0 ]; then
    echo "æ–‡ä»¶å¤‡ä»½æˆåŠŸ: $BACKUP_DIR/files_backup_$DATE.tar.gz"
else
    echo "æ–‡ä»¶å¤‡ä»½å¤±è´¥!"
    exit 1
fi

# æ¸…ç†æ—§å¤‡ä»½ (ä¿ç•™7å¤©)
find $BACKUP_DIR -name "*.dump" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ!"
```

### 8.4 ç›‘æ§ä¸æ—¥å¿—

#### åº”ç”¨ç›‘æ§

```python
# monitoring/health_check.py
from fastapi import APIRouter, Depends
from sqlalchemy import text
from backend.core.db import get_db_session
from backend.core.redis import redis_client
import psutil
import datetime

router = APIRouter()

@router.get("/health")
async def health_check():
    """å¥åº·æ£€æŸ¥"""
    return {
        "status": "healthy",
        "timestamp": datetime.utcnow().isoformat(),
        "version": "1.0.0"
    }

@router.get("/health/detailed")
async def detailed_health_check():
    """è¯¦ç»†å¥åº·æ£€æŸ¥"""

    health_status = {
        "status": "healthy",
        "timestamp": datetime.utcnow().isoformat(),
        "services": {}
    }

    # æ•°æ®åº“æ£€æŸ¥
    try:
        with get_db_session() as session:
            result = session.execute(text("SELECT 1"))
            health_status["services"]["database"] = {
                "status": "healthy",
                "response_time": "< 10ms"
            }
    except Exception as e:
        health_status["services"]["database"] = {
            "status": "unhealthy",
            "error": str(e)
        }
        health_status["status"] = "unhealthy"

    # Redisæ£€æŸ¥
    try:
        redis_client.ping()
        health_status["services"]["redis"] = {
            "status": "healthy",
            "response_time": "< 5ms"
        }
    except Exception as e:
        health_status["services"]["redis"] = {
            "status": "unhealthy",
            "error": str(e)
        }
        health_status["status"] = "unhealthy"

    # ç³»ç»Ÿèµ„æºæ£€æŸ¥
    health_status["services"]["system"] = {
        "cpu_percent": psutil.cpu_percent(),
        "memory_percent": psutil.virtual_memory().percent,
        "disk_percent": psutil.disk_usage('/').percent
    }

    return health_status

@router.get("/metrics")
async def get_metrics():
    """è·å–ç³»ç»ŸæŒ‡æ ‡"""

    # æ•°æ®åº“æŒ‡æ ‡
    with get_db_session() as session:
        # æ´»è·ƒç”¨æˆ·æ•°
        active_users = session.execute(text("""
            SELECT COUNT(*) FROM users WHERE is_active = true
        """)).scalar()

        # ä»Šæ—¥æ•°æ®é‡
        today_stats = session.execute(text("""
            SELECT
                COUNT(*) as daily_reports,
                SUM(spend) as total_spend,
                SUM(leads_confirmed) as total_leads
            FROM ad_spend_daily
            WHERE date = CURRENT_DATE
        """)).fetchone()

    # ç³»ç»ŸæŒ‡æ ‡
    system_metrics = {
        "cpu_percent": psutil.cpu_percent(),
        "memory_percent": psutil.virtual_memory().percent,
        "disk_usage": psutil.disk_usage('/').percent,
        "load_average": psutil.getloadavg()[0] if hasattr(psutil, 'getloadavg') else None
    }

    return {
        "timestamp": datetime.utcnow().isoformat(),
        "business_metrics": {
            "active_users": active_users,
            "daily_reports": today_stats.daily_reports or 0,
            "total_spend": float(today_stats.total_spend or 0),
            "total_leads": today_stats.total_leads or 0
        },
        "system_metrics": system_metrics
    }
```

#### æ—¥å¿—é…ç½®

```python
# logging_config.py
import logging
import logging.config
from pathlib import Path

LOGGING_CONFIG = {
    "version": 1,
    "disable_existing_loggers": False,
    "formatters": {
        "default": {
            "format": "%(asctime)s - %(name)s - %(levelname)s - %(message)s",
        },
        "detailed": {
            "format": "%(asctime)s - %(name)s - %(levelname)s - %(module)s - %(funcName)s - %(message)s",
        },
        "json": {
            "()": "pythonjsonlogger.jsonlogger.JsonFormatter",
            "format": "%(asctime)s %(name)s %(levelname)s %(module)s %(funcName)s %(message)s"
        }
    },
    "handlers": {
        "console": {
            "class": "logging.StreamHandler",
            "level": "INFO",
            "formatter": "default",
            "stream": "ext://sys.stdout"
        },
        "file": {
            "class": "logging.handlers.RotatingFileHandler",
            "level": "DEBUG",
            "formatter": "detailed",
            "filename": "logs/app.log",
            "maxBytes": 10485760,  # 10MB
            "backupCount": 5,
            "encoding": "utf8"
        },
        "error_file": {
            "class": "logging.handlers.RotatingFileHandler",
            "level": "ERROR",
            "formatter": "detailed",
            "filename": "logs/error.log",
            "maxBytes": 10485760,  # 10MB
            "backupCount": 5,
            "encoding": "utf8"
        },
        "audit_file": {
            "class": "logging.handlers.RotatingFileHandler",
            "level": "INFO",
            "formatter": "json",
            "filename": "logs/audit.log",
            "maxBytes": 10485760,  # 10MB
            "backupCount": 30,
            "encoding": "utf8"
        }
    },
    "loggers": {
        "": {  # root logger
            "level": "INFO",
            "handlers": ["console", "file", "error_file"]
        },
        "audit": {
            "level": "INFO",
            "handlers": ["audit_file"],
            "propagate": False
        },
        "uvicorn": {
            "level": "INFO",
            "handlers": ["console"],
            "propagate": False
        },
        "sqlalchemy.engine": {
            "level": "WARNING",
            "handlers": ["file"],
            "propagate": False
        }
    }
}

def setup_logging():
    """è®¾ç½®æ—¥å¿—é…ç½®"""
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    Path("logs").mkdir(exist_ok=True)

    # åº”ç”¨é…ç½®
    logging.config.dictConfig(LOGGING_CONFIG)
```

---

## 9. æµ‹è¯•ä¸è´¨é‡ä¿è¯

### 9.1 æµ‹è¯•ç­–ç•¥

#### æµ‹è¯•é‡‘å­—å¡”

```
    /\
   /  \     E2E Tests (10%)
  /____\
 /      \   Integration Tests (20%)
/__________\ Unit Tests (70%)
```

#### å•å…ƒæµ‹è¯•

```python
# tests/test_projects_service.py
import pytest
from unittest.mock import Mock, patch
from datetime import datetime
from backend.services.project_service import ProjectService
from backend.models.projects import Project

class TestProjectService:

    @pytest.fixture
    def project_service(self):
        """åˆ›å»ºé¡¹ç›®æœåŠ¡å®ä¾‹"""
        mock_db = Mock()
        return ProjectService(mock_db)

    @pytest.fixture
    def sample_project(self):
        """ç¤ºä¾‹é¡¹ç›®æ•°æ®"""
        return Project(
            id="test-project-id",
            name="æµ‹è¯•é¡¹ç›®",
            client_name="æµ‹è¯•å®¢æˆ·",
            pricing_model="per_lead",
            lead_price=10.0,
            setup_fee=1000.0,
            status="planning"
        )

    def test_create_project_success(self, project_service, sample_project):
        """æµ‹è¯•åˆ›å»ºé¡¹ç›®æˆåŠŸ"""
        # æ¨¡æ‹Ÿæ•°æ®åº“æ“ä½œ
        project_service.db.add.return_value = None
        project_service.db.commit.return_value = None
        project_service.db.refresh.return_value = None

        # æ‰§è¡Œæµ‹è¯•
        result = project_service.create_project({
            "name": "æµ‹è¯•é¡¹ç›®",
            "client_name": "æµ‹è¯•å®¢æˆ·",
            "pricing_model": "per_lead",
            "lead_price": 10.0,
            "setup_fee": 1000.0
        }, user_id="test-user-id")

        # éªŒè¯ç»“æœ
        assert result is not None
        assert result.name == "æµ‹è¯•é¡¹ç›®"
        assert result.client_name == "æµ‹è¯•å®¢æˆ·"
        project_service.db.add.assert_called_once()
        project_service.db.commit.assert_called_once()

    def test_create_project_invalid_pricing_model(self, project_service):
        """æµ‹è¯•åˆ›å»ºé¡¹ç›®å¤±è´¥ - æ— æ•ˆæ”¶è´¹æ¨¡å¼"""
        with pytest.raises(ValueError, match="æ— æ•ˆçš„æ”¶è´¹æ¨¡å¼"):
            project_service.create_project({
                "name": "æµ‹è¯•é¡¹ç›®",
                "client_name": "æµ‹è¯•å®¢æˆ·",
                "pricing_model": "invalid_model",
                "lead_price": 10.0
            }, user_id="test-user-id")

    def test_update_project_status_success(self, project_service, sample_project):
        """æµ‹è¯•æ›´æ–°é¡¹ç›®çŠ¶æ€æˆåŠŸ"""
        # æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
        project_service.db.query.return_value.filter.return_value.first.return_value = sample_project

        # æ‰§è¡Œæµ‹è¯•
        result = project_service.update_project_status(
            "test-project-id",
            "active",
            user_id="test-user-id"
        )

        # éªŒè¯ç»“æœ
        assert result.status == "active"
        project_service.db.commit.assert_called_once()

    def test_calculate_project_roi(self, project_service):
        """æµ‹è¯•é¡¹ç›®ROIè®¡ç®—"""
        # æ¨¡æ‹Ÿæ•°æ®
        project_service.db.query.return_value.filter.return_value.scalar.side_effect = [
            1000.0,  # æ€»æ”¶å…¥ (100ä¸ªç²‰ * $10)
            600.0    # æ€»æˆæœ¬ (å¹¿å‘Šè´¹ $500 + æ‰‹ç»­è´¹ $100)
        ]

        # æ‰§è¡Œæµ‹è¯•
        roi = project_service.calculate_project_roi("test-project-id")

        # éªŒè¯ç»“æœ
        expected_roi = ((1000.0 - 600.0) / 600.0) * 100  # 66.67%
        assert abs(roi - expected_roi) < 0.01
```

#### é›†æˆæµ‹è¯•

```python
# tests/test_api_integration.py
import pytest
from fastapi.testclient import TestClient
from backend.main import app
from backend.core.db import get_db_session
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# æµ‹è¯•æ•°æ®åº“
SQLALCHEMY_DATABASE_URL = "sqlite:///./test.db"
engine = create_engine(SQLALCHEMY_DATABASE_URL, connect_args={"check_same_thread": False})
TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def override_get_db():
    try:
        db = TestingSessionLocal()
        yield db
    finally:
        db.close()

app.dependency_overrides[get_db_session] = override_get_db

client = TestClient(app)

class TestProjectAPI:

    def test_create_project_api(self):
        """æµ‹è¯•åˆ›å»ºé¡¹ç›®API"""
        # å…ˆç™»å½•è·å–token
        login_response = client.post("/api/auth/login", json={
            "email": "test@example.com",
            "password": "testpassword"
        })
        token = login_response.json()["access_token"]

        headers = {"Authorization": f"Bearer {token}"}

        # åˆ›å»ºé¡¹ç›®
        project_data = {
            "name": "APIæµ‹è¯•é¡¹ç›®",
            "client_name": "APIæµ‹è¯•å®¢æˆ·",
            "pricing_model": "per_lead",
            "lead_price": 15.0,
            "setup_fee": 2000.0,
            "monthly_budget": 10000.0
        }

        response = client.post("/api/projects", json=project_data, headers=headers)

        assert response.status_code == 200
        data = response.json()
        assert data["name"] == "APIæµ‹è¯•é¡¹ç›®"
        assert data["client_name"] == "APIæµ‹è¯•å®¢æˆ·"
        assert "id" in data

    def test_get_projects_api(self):
        """æµ‹è¯•è·å–é¡¹ç›®åˆ—è¡¨API"""
        # ç™»å½•
        login_response = client.post("/api/auth/login", json={
            "email": "test@example.com",
            "password": "testpassword"
        })
        token = login_response.json()["access_token"]
        headers = {"Authorization": f"Bearer {token}"}

        # è·å–é¡¹ç›®åˆ—è¡¨
        response = client.get("/api/projects", headers=headers)

        assert response.status_code == 200
        data = response.json()
        assert "items" in data
        assert "pagination" in data
        assert isinstance(data["items"], list)

    def test_unauthorized_access(self):
        """æµ‹è¯•æœªæˆæƒè®¿é—®"""
        response = client.get("/api/projects")
        assert response.status_code == 401

        response = client.post("/api/projects", json={
            "name": "æœªæˆæƒé¡¹ç›®"
        })
        assert response.status_code == 401
```

#### E2Eæµ‹è¯•

```python
# tests/test_e2e_workflows.py
import pytest
from playwright.sync_api import Page, expect

class TestE2EWorkflows:

    def test_complete_topup_workflow(self, page: Page):
        """æµ‹è¯•å®Œæ•´çš„å……å€¼æµç¨‹"""

        # 1. ç™»å½•
        page.goto("http://localhost:3000/login")
        page.fill("input[name='email']", "media_buyer@test.com")
        page.fill("input[name='password']", "testpassword")
        page.click("button[type='submit']")

        # éªŒè¯ç™»å½•æˆåŠŸ
        expect(page).to_have_url("http://localhost:3000/dashboard")

        # 2. å¯¼èˆªåˆ°è´¢åŠ¡ç®¡ç†
        page.click("text=è´¢åŠ¡ç®¡ç†")
        page.click("text=å……å€¼ç”³è¯·")

        # 3. åˆ›å»ºå……å€¼ç”³è¯·
        page.click("text=æ–°å»ºç”³è¯·")
        page.select_option("select[name='ad_account_id']", "æµ‹è¯•è´¦æˆ·1")
        page.fill("input[name='amount']", "1000")
        page.fill("textarea[name='purpose']", "ç”¨äºFacebookå¹¿å‘ŠæŠ•æ”¾")
        page.click("button[type='submit']")

        # 4. éªŒè¯ç”³è¯·åˆ›å»ºæˆåŠŸ
        expect(page.locator("text=ç”³è¯·æäº¤æˆåŠŸ")).to_be_visible()

        # 5. åˆ‡æ¢åˆ°æ•°æ®å‘˜è´¦å·
        page.click("text=é€€å‡ºç™»å½•")
        page.fill("input[name='email']", "data_clerk@test.com")
        page.fill("input[name='password']", "testpassword")
        page.click("button[type='submit']")

        # 6. å®¡æ‰¹å……å€¼ç”³è¯·
        page.goto("http://localhost:3000/finance/topups")
        page.click("text=å¾…å®¡æ‰¹")
        page.click("text=å®¡æ‰¹")
        page.fill("textarea[name='notes']", "é¢„ç®—å……è¶³ï¼Œå»ºè®®æ‰¹å‡†")
        page.click("button:has-text('æ‰¹å‡†')")

        # 7. éªŒè¯å®¡æ‰¹æˆåŠŸ
        expect(page.locator("text=å®¡æ‰¹æˆåŠŸ")).to_be_visible()

        # 8. åˆ‡æ¢åˆ°è´¢åŠ¡è´¦å·
        page.click("text=é€€å‡ºç™»å½•")
        page.fill("input[name='email']", "finance@test.com")
        page.fill("input[name='password']", "testpassword")
        page.click("button[type='submit']")

        # 9. è´¢åŠ¡æœ€ç»ˆå®¡æ‰¹
        page.goto("http://localhost:3000/finance/topups")
        page.click("text=å¾…å®¡æ‰¹")
        page.click("text=å®¡æ‰¹")
        page.select_option("select[name='payment_method']", "é“¶è¡Œè½¬è´¦")
        page.fill("input[name='transaction_id']", "TXN123456")
        page.click("button:has-text('æ‰¹å‡†å¹¶æ‰§è¡Œ')")

        # 10. éªŒè¯å®Œæˆ
        expect(page.locator("text=å……å€¼å®Œæˆ")).to_be_visible()
```

### 9.2 æ€§èƒ½æµ‹è¯•

#### è´Ÿè½½æµ‹è¯•

```python
# tests/test_performance.py
import asyncio
import aiohttp
import time
from concurrent.futures import ThreadPoolExecutor
import statistics

class PerformanceTest:

    def __init__(self, base_url: str):
        self.base_url = base_url
        self.results = []

    async def single_request(self, session: aiohttp.ClientSession, endpoint: str):
        """å•ä¸ªè¯·æ±‚æµ‹è¯•"""
        start_time = time.time()
        try:
            async with session.get(f"{self.base_url}{endpoint}") as response:
                await response.text()
                end_time = time.time()
                return {
                    "status_code": response.status,
                    "response_time": end_time - start_time,
                    "success": response.status == 200
                }
        except Exception as e:
            end_time = time.time()
            return {
                "status_code": 0,
                "response_time": end_time - start_time,
                "success": False,
                "error": str(e)
            }

    async def load_test(self, endpoint: str, concurrent_users: int = 10, requests_per_user: int = 5):
        """è´Ÿè½½æµ‹è¯•"""
        print(f"å¼€å§‹è´Ÿè½½æµ‹è¯•: {concurrent_users}ä¸ªå¹¶å‘ç”¨æˆ·, æ¯ç”¨æˆ·{requests_per_user}ä¸ªè¯·æ±‚")

        async with aiohttp.ClientSession() as session:
            tasks = []
            for user in range(concurrent_users):
                for request in range(requests_per_user):
                    task = self.single_request(session, endpoint)
                    tasks.append(task)

            results = await asyncio.gather(*tasks)
            self.results.extend(results)

        # åˆ†æç»“æœ
        successful_requests = [r for r in results if r["success"]]
        failed_requests = [r for r in results if not r["success"]]

        response_times = [r["response_time"] for r in successful_requests]

        stats = {
            "total_requests": len(results),
            "successful_requests": len(successful_requests),
            "failed_requests": len(failed_requests),
            "success_rate": len(successful_requests) / len(results) * 100,
            "avg_response_time": statistics.mean(response_times) if response_times else 0,
            "min_response_time": min(response_times) if response_times else 0,
            "max_response_time": max(response_times) if response_times else 0,
            "median_response_time": statistics.median(response_times) if response_times else 0,
            "p95_response_time": statistics.quantiles(response_times, n=20)[18] if len(response_times) > 20 else 0,
            "requests_per_second": len(results) / (max(response_times) - min(response_times)) if response_times else 0
        }

        return stats

    def print_results(self, stats: dict):
        """æ‰“å°æµ‹è¯•ç»“æœ"""
        print("\n=== æ€§èƒ½æµ‹è¯•ç»“æœ ===")
        print(f"æ€»è¯·æ±‚æ•°: {stats['total_requests']}")
        print(f"æˆåŠŸè¯·æ±‚æ•°: {stats['successful_requests']}")
        print(f"å¤±è´¥è¯·æ±‚æ•°: {stats['failed_requests']}")
        print(f"æˆåŠŸç‡: {stats['success_rate']:.2f}%")
        print(f"å¹³å‡å“åº”æ—¶é—´: {stats['avg_response_time']:.3f}s")
        print(f"æœ€å°å“åº”æ—¶é—´: {stats['min_response_time']:.3f}s")
        print(f"æœ€å¤§å“åº”æ—¶é—´: {stats['max_response_time']:.3f}s")
        print(f"ä¸­ä½æ•°å“åº”æ—¶é—´: {stats['median_response_time']:.3f}s")
        print(f"95%å“åº”æ—¶é—´: {stats['p95_response_time']:.3f}s")
        print(f"æ¯ç§’è¯·æ±‚æ•°: {stats['requests_per_second']:.2f}")

# ä½¿ç”¨ç¤ºä¾‹
async def run_performance_tests():
    tester = PerformanceTest("http://localhost:8000")

    # æµ‹è¯•é¡¹ç›®åˆ—è¡¨API
    print("æµ‹è¯•é¡¹ç›®åˆ—è¡¨API...")
    stats = await tester.load_test("/api/projects", concurrent_users=20, requests_per_user=10)
    tester.print_results(stats)

    # æµ‹è¯•è´¦æˆ·åˆ—è¡¨API
    print("\næµ‹è¯•è´¦æˆ·åˆ—è¡¨API...")
    stats = await tester.load_test("/api/accounts", concurrent_users=15, requests_per_user=8)
    tester.print_results(stats)

if __name__ == "__main__":
    asyncio.run(run_performance_tests())
```

### 9.3 è´¨é‡é—¨ç¦

#### CI/CDè´¨é‡æ£€æŸ¥

```yaml
# .github/workflows/quality-check.yml
name: Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio black flake8 mypy

    - name: Code formatting check
      run: |
        black --check backend/
        flake8 backend/
        mypy backend/

    - name: Run unit tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        TESTING: true
      run: |
        pytest tests/unit/ -v --cov=backend --cov-report=xml --cov-fail-under=80

    - name: Run integration tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        TESTING: true
      run: |
        pytest tests/integration/ -v

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  frontend-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: app/package-lock.json

    - name: Install dependencies
      working-directory: ./app
      run: npm ci

    - name: Run ESLint
      working-directory: ./app
      run: npm run lint

    - name: Run type check
      working-directory: ./app
      run: npm run type-check

    - name: Run unit tests
      working-directory: ./app
      run: npm run test:unit -- --coverage --watchAll=false

    - name: Build application
      working-directory: ./app
      run: npm run build

  e2e-test:
    runs-on: ubuntu-latest
    needs: [test, frontend-test]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        cd app && npm ci

    - name: Start application
      run: |
        cd backend && python main.py &
        cd ../app && npm run dev &
        sleep 30  # ç­‰å¾…åº”ç”¨å¯åŠ¨

    - name: Install Playwright
      run: |
        npx playwright install --with-deps

    - name: Run E2E tests
      run: |
        npx playwright test

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
```

---

## 10. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 10.1 å¼€å‘ç¯å¢ƒé—®é¢˜

#### Q: æ•°æ®åº“è¿æ¥å¤±è´¥
**A: æ£€æŸ¥ä»¥ä¸‹é…ç½®**
```bash
# 1. æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $DATABASE_URL

# 2. æµ‹è¯•æ•°æ®åº“è¿æ¥
psql $DATABASE_URL -c "SELECT 1"

# 3. æ£€æŸ¥æ•°æ®åº“æ˜¯å¦è¿è¡Œ
docker ps | grep postgres

# 4. æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker logs postgres-container
```

#### Q: å‰ç«¯æ„å»ºå¤±è´¥
**A: å¸¸è§è§£å†³æ–¹æ¡ˆ**
```bash
# 1. æ¸…é™¤ç¼“å­˜
rm -rf .next node_modules
npm install

# 2. æ£€æŸ¥TypeScripté”™è¯¯
npm run type-check

# 3. æ£€æŸ¥ç¯å¢ƒå˜é‡
cat .env.local

# 4. æ£€æŸ¥ä¾èµ–å†²çª
npm ls
```

#### Q: APIè¯·æ±‚403æƒé™é”™è¯¯
**A: æƒé™æ£€æŸ¥æµç¨‹**
```python
# 1. æ£€æŸ¥ç”¨æˆ·è§’è‰²
SELECT role FROM users WHERE email = 'your-email@example.com';

# 2. æ£€æŸ¥æƒé™çŸ©é˜µ
SELECT * FROM permission_matrix WHERE role = 'your-role';

# 3. æ£€æŸ¥RLSç­–ç•¥
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE tablename IN ('projects', 'ad_accounts');
```

### 10.2 ä¸šåŠ¡é€»è¾‘é—®é¢˜

#### Q: å……å€¼æµç¨‹å¡åœ¨æ•°æ®å‘˜å®¡æ‰¹
**A: æ£€æŸ¥ç‚¹å’Œè§£å†³æ–¹æ¡ˆ**
```sql
-- 1. æ£€æŸ¥å……å€¼ç”³è¯·çŠ¶æ€
SELECT id, status, clerk_approval, finance_approval
FROM topups
WHERE status = 'pending';

-- 2. æ£€æŸ¥æ•°æ®å‘˜æƒé™
SELECT id, email, role FROM users WHERE role = 'data_clerk';

-- 3. æ£€æŸ¥å®¡æ‰¹å†å²
SELECT * FROM audit_logs
WHERE table_name = 'topups'
AND action = 'update'
ORDER BY created_at DESC;
```

```python
# 4. é‡æ–°å‘é€å®¡æ‰¹é€šçŸ¥
async def resend_approval_notification(topup_id: str):
    topup = db.query(Topup).filter(Topup.id == topup_id).first()
    if topup and topup.status == "pending":
        await notify_data_clerk_for_approval(topup)
        return True
    return False
```

#### Q: å¯¹è´¦å·®å¼‚è¿‡å¤§
**A: å·®å¼‚åˆ†æå’Œå¤„ç†**
```python
# 1. è¯¦ç»†å·®å¼‚åˆ†æ
async def detailed_variance_analysis(project_id: str, start_date: datetime, end_date: datetime):

    # æ£€æŸ¥æ—¶é—´å·®å¼‚
    time_diff_topups = db.query(Topup).filter(
        Topup.project_id == project_id,
        Topup.completed_at.between(start_date, end_date + timedelta(days=7))
    ).all()

    # æ£€æŸ¥æ‰‹ç»­è´¹å·®å¼‚
    fee_analysis = db.query(
        func.sum(Topup.fee_amount),
        func.avg(Topup.fee_rate)
    ).filter(
        Topup.project_id == project_id,
        Topup.completed_at.between(start_date, end_date)
    ).first()

    # æ£€æŸ¥å¼‚å¸¸äº¤æ˜“
    suspicious_transactions = db.query(Topup).filter(
        Topup.project_id == project_id,
        Topup.completed_at.between(start_date, end_date),
        Topup.amount > 10000  # å¤§é¢äº¤æ˜“
    ).all()

    return {
        "time_delay_topups": len(time_diff_topups),
        "total_fees": float(fee_analysis[0] or 0),
        "avg_fee_rate": float(fee_analysis[1] or 0),
        "suspicious_transactions": len(suspicious_transactions)
    }
```

### 10.3 æ€§èƒ½ä¼˜åŒ–é—®é¢˜

#### Q: APIå“åº”ç¼“æ…¢
**A: æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥**
```sql
-- 1. æ£€æŸ¥æ…¢æŸ¥è¯¢
SELECT query, mean_time, calls, total_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;

-- 2. æ£€æŸ¥ç¼ºå¤±çš„ç´¢å¼•
SELECT schemaname, tablename, attname, n_distinct, correlation
FROM pg_stats
WHERE schemaname = 'public'
AND tablename IN ('projects', 'ad_accounts', 'ad_spend_daily');

-- 3. æ£€æŸ¥æ•°æ®åº“è¿æ¥
SELECT state, count(*)
FROM pg_stat_activity
GROUP BY state;
```

```python
# 4. APIå“åº”æ—¶é—´ä¼˜åŒ–
from functools import lru_cache
import asyncio

class OptimizedProjectService:

    @lru_cache(maxsize=128)
    def get_project_cached(self, project_id: str):
        """ç¼“å­˜é¡¹ç›®ä¿¡æ¯"""
        return db.query(Project).filter(Project.id == project_id).first()

    async def get_projects_batch(self, project_ids: List[str]):
        """æ‰¹é‡è·å–é¡¹ç›®ä¿¡æ¯"""
        projects = db.query(Project).filter(Project.id.in_(project_ids)).all()
        return {p.id: p for p in projects}

    async def get_project_stats_async(self, project_id: str):
        """å¼‚æ­¥è·å–é¡¹ç›®ç»Ÿè®¡"""
        tasks = [
            asyncio.create_task(self.get_total_spend(project_id)),
            asyncio.create_task(self.get_total_leads(project_id)),
            asyncio.create_task(self.get_account_count(project_id))
        ]

        spend, leads, account_count = await asyncio.gather(*tasks)
        return {
            "total_spend": spend,
            "total_leads": leads,
            "account_count": account_count
        }
```

### 10.4 å®‰å…¨é—®é¢˜

#### Q: å‘ç°å®‰å…¨æ¼æ´
**A: å®‰å…¨åº”æ€¥å“åº”**
```python
# 1. ç«‹å³ç¦ç”¨å—å½±å“è´¦æˆ·
async def emergency_disable_account(user_id: str):
    """ç´§æ€¥ç¦ç”¨ç”¨æˆ·è´¦æˆ·"""
    user = db.query(User).filter(User.id == user_id).first()
    if user:
        user.is_active = False
        # å°†æ‰€æœ‰JWT tokenåŠ å…¥é»‘åå•
        await jwt_manager.blacklist_all_user_tokens(user_id)

        # è®°å½•å®‰å…¨äº‹ä»¶
        security_logger.log_security_event(
            event_type="account_disabled_emergency",
            severity="critical",
            user_id=user_id,
            details={"reason": "security_vulnerability"}
        )

        db.commit()

# 2. æ£€æŸ¥å¼‚å¸¸æ´»åŠ¨
async def check_suspicious_activity(user_id: str):
    """æ£€æŸ¥å¯ç–‘æ´»åŠ¨"""
    recent_logs = db.query(AuditLog).filter(
        AuditLog.user_id == user_id,
        AuditLog.created_at >= datetime.utcnow() - timedelta(hours=24)
    ).all()

    # æ£€æŸ¥å¼‚å¸¸æ¨¡å¼
    suspicious_patterns = []
    for log in recent_logs:
        if log.action in ["delete", "export"]:
            suspicious_patterns.append({
                "action": log.action,
                "timestamp": log.created_at,
                "ip_address": log.ip_address
            })

    return suspicious_patterns
```

#### Q: æ•°æ®æ³„éœ²åº”æ€¥å¤„ç†
**A: æ•°æ®ä¿æŠ¤æªæ–½**
```bash
# 1. ç«‹å³æ›´æ”¹æ•°æ®åº“å¯†ç 
ALTER USER postgres PASSWORD 'new_strong_password';

# 2. æ£€æŸ¥æ•°æ®è®¿é—®æ—¥å¿—
SELECT user_id, action, table_name, created_at
FROM audit_logs
WHERE created_at >= NOW() - INTERVAL '24 hours'
AND table_name IN ('projects', 'ad_accounts', 'users')
ORDER BY created_at DESC;

# 3. å¤‡ä»½å…³é”®æ•°æ®
pg_dump -h localhost -U postgres -d ad_spend \
    --format=custom \
    --file=emergency_backup_$(date +%Y%m%d_%H%M%S).dump

# 4. å¯ç”¨é¢å¤–å®¡è®¡
ALTER SYSTEM SET log_statement = 'all';
ALTER SYSTEM SET log_min_duration_statement = 0;
SELECT pg_reload_conf();
```

### 10.5 è¿ç»´é—®é¢˜

#### Q: æœåŠ¡å™¨å®•æœºæ¢å¤
**A: ç¾éš¾æ¢å¤æµç¨‹**
```bash
#!/bin/bash
# disaster_recovery.sh

echo "å¼€å§‹ç¾éš¾æ¢å¤æµç¨‹..."

# 1. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
systemctl status nginx
systemctl status postgresql
systemctl status redis

# 2. ä»å¤‡ä»½æ¢å¤æ•°æ®åº“
if [ -f "/backups/latest_backup.dump" ]; then
    echo "æ¢å¤æ•°æ®åº“..."
    pg_restore -h localhost -U postgres -d ad_spend \
        --clean --if-exists --verbose /backups/latest_backup.dump
else
    echo "æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶!"
    exit 1
fi

# 3. æ¢å¤æ–‡ä»¶
echo "æ¢å¤æ–‡ä»¶..."
tar -xzf /backups/files_backup_latest.tar.gz -C /

# 4. é‡å¯æœåŠ¡
echo "é‡å¯æœåŠ¡..."
systemctl restart postgresql
systemctl restart redis
systemctl restart nginx

# 5. éªŒè¯æœåŠ¡
curl -f http://localhost:8000/health || exit 1
curl -f http://localhost:3000 || exit 1

echo "ç¾éš¾æ¢å¤å®Œæˆ!"
```

#### Q: æ•°æ®åº“æ€§èƒ½ä¸‹é™
**A: æ€§èƒ½è¯Šæ–­å’Œä¼˜åŒ–**
```sql
-- 1. æ£€æŸ¥æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
SELECT schemaname, tablename, n_tup_ins, n_tup_upd, n_tup_del, n_live_tup, n_dead_tup
FROM pg_stat_user_tables
ORDER BY n_dead_tup DESC;

-- 2. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE;

-- 3. é‡å»ºç´¢å¼•
REINDEX DATABASE ad_spend;

-- 4. æ¸…ç†æ­»å…ƒç»„
VACUUM (VERBOSE, ANALYZE) ad_accounts;
VACUUM (VERBOSE, ANALYZE) ad_spend_daily;

-- 5. æ£€æŸ¥é”ç­‰å¾…
SELECT blocked_locks.pid AS blocked_pid,
       blocked_activity.usename AS blocked_user,
       blocking_locks.pid AS blocking_pid,
       blocking_activity.usename AS blocking_user,
       blocked_activity.query AS blocked_statement,
       blocking_activity.query AS current_statement_in_blocking_process
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¼€å‘å›¢é˜Ÿè”ç³»æ–¹å¼
- **æŠ€æœ¯è´Ÿè´£äºº**: [å¾…å¡«å†™]
- **æ¶æ„å¸ˆ**: [å¾…å¡«å†™]
- **å‰ç«¯è´Ÿè´£äºº**: [å¾…å¡«å†™]
- **åç«¯è´Ÿè´£äºº**: [å¾…å¡«å†™]
- **è¿ç»´è´Ÿè´£äºº**: [å¾…å¡«å†™]

### ç´§æ€¥è”ç³»
- **ç³»ç»Ÿæ•…éšœ**: ç«‹å³è”ç³»æŠ€æœ¯è´Ÿè´£äºº
- **å®‰å…¨äº‹ä»¶**: ç«‹å³è”ç³»å®‰å…¨å›¢é˜Ÿ
- **æ•°æ®é—®é¢˜**: è”ç³»DBAå›¢é˜Ÿ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-10
**ä¸‹æ¬¡å®¡æŸ¥**: åŠŸèƒ½å˜æ›´æ—¶