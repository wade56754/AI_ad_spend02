# 数据库脚本 v2.3 优化清单

版本：v2.4 规划  
范围：`04_database_schema_v2_3.sql`  
目标：让脚本能一次性在标准 PostgreSQL / Supabase 环境中执行、结构一致、可重复、可维护。

---

## 1. 语法与执行顺序问题（P0）

1. **把所有裸 `RAISE NOTICE` 收进 DO 块或删除**
   - 问题：当前脚本在建表、建视图、建索引后直接写 `RAISE NOTICE`，在普通 migration 引擎中会报错。
   - 优化：
     ```sql
     DO $$
     BEGIN
       RAISE NOTICE 'schema created';
     END $$;
     ```

2. **移除或拆分 `CREATE INDEX CONCURRENTLY`**
   - 问题：CONCURRENTLY 不能在事务内执行，当前脚本一口气创建多个，会导致迁移失败。
   - 优化：主脚本用普通 `CREATE INDEX`，新建 `05_indexes.sql` 专门放 CONCURRENTLY 索引。

3. **`SET session_replication_role = replica` 包装保护**
   - 问题：一旦中途报错，触发器可能一直处于禁用状态。
   - 优化：放入 DO 块并在最后恢复；或只在需要的表前后局部设置。

---

## 2. 业务逻辑错误修复（P0）

1. **项目统计函数引用错误字段**
   - 问题：`update_project_statistics()` 中直接从 `daily_reports` 查 `project_id`，但日报表没有该字段。
   - 优化：改为通过账户关联：
     ```sql
     SELECT SUM(dr.spend_amount)
     FROM daily_reports dr
     JOIN ad_accounts a ON dr.ad_account_id = a.id
     WHERE a.project_id = NEW.id;
     ```

2. **视图字段引用错误**
   - 问题：`user_workbench` 视图里取了 `u.department, u.position`，但实际在 `user_profiles`。
   - 优化：改成 `up.department, up.position`。

3. **ad_accounts 外键约束互相打架**
   - 问题：列是 `NOT NULL`，外键却是 `ON DELETE SET NULL`。
   - 优化：要么允许 NULL，要么改成 `ON DELETE RESTRICT`。

4. **财务表级联过度**
   - 问题：topups / reconciliations 对 project/channel/account 全是 CASCADE，删主数据会把财务记录全删掉。
   - 优化：仅对 project CASCADE，其它改为 `SET NULL` 或 `RESTRICT`。

---

## 3. RLS 与会话安全（P0/P1）

1. **统一 current_setting 读取方式**
   - 问题：函数有的地方用了 `current_setting('app.current_user_id', true)` 做了兜底，有的地方没有。
   - 优化：写一个统一函数：
     ```sql
     CREATE OR REPLACE FUNCTION get_app_setting(key text)
     RETURNS text AS $$
     BEGIN
       RETURN current_setting(key, true);
     EXCEPTION WHEN others THEN
       RETURN NULL;
     END;
     $$ LANGUAGE plpgsql;
     ```

2. **users 表的 RLS 不要暴露 is_superuser=true 的行**
   - 问题：当前策略允许普通用户看到所有管理员行。
   - 优化：改为“只有当前会话角色=admin 才能看到其他用户”。

3. **插入初始数据在开启 RLS 之前执行**
   - 否则插入管理员会被策略挡掉。

---

## 4. 索引与性能（P1）

1. **拆分业务索引与分析索引**
   - 主脚本保留：外键列、日期+账户列（daily_reports）、项目列。
   - 分析型、条件索引放增量脚本，避免初始化时间过长。

2. **为高频查询建联合索引**
   - `daily_reports (ad_account_id, report_date)`
   - `topups (project_id, ad_account_id, status)`
   - `ad_accounts (project_id, status)`

3. **为大表预留分区位点**
   - 保留 `daily_reports` 原表
   - 另建 `daily_reports_y2025m11` 这种按月分区的表结构作为未来迁移目标

---

## 5. 一致性与命名（P1）

1. **统一主键生成方式**
   - 现在有的表用 `gen_random_uuid()`, 有的写 `uuid_generate_v4()`
   - 建议全用 `gen_random_u
