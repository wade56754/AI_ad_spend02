# AI广告代投系统 - 项目结构优化清单

> **版本**: v2.0
> **更新日期**: 2025-11-11
> **适用范围**: 项目结构优化和文档规范化

---

## 📋 项目现状分析

### 当前技术栈
- **前端**: Next.js 15 + TypeScript + Tailwind CSS + shadcn/ui + Supabase SSR
- **后端**: FastAPI + SQLAlchemy + Supabase (PostgreSQL)
- **UI组件**: Radix UI + Lucide React + Recharts
- **开发工具**: ESLint + Prettier + TypeScript
- **部署**: Docker + 宝塔 + Nginx

### 当前项目结构
```
AI_ad_spend02/
├── app/                     # Next.js App Router
├── components/              # React组件
├── lib/                     # 工具库
├── backend/                 # FastAPI后端
├── tests/                   # 测试文件
├── docs/                    # 文档（待优化）
└── 配置文件
```

---

## 🎯 优化目标

### 1. 文档体系规范化
- [ ] 创建统一的文档导航中心
- [ ] 标准化技术文档格式
- [ ] 建立文档维护流程

### 2. 代码结构优化
- [ ] 规范化组件目录结构
- [ ] 优化API路由组织
- [ ] 完善类型定义体系

### 3. 开发流程标准化
- [ ] 建立代码规范和提交规范
- [ ] 完善测试覆盖
- [ ] 优化CI/CD流程

---

## 📂 文档结构优化

### 1.1 核心文档拆分
- **[SYSTEM_OVERVIEW.md](./SYSTEM_OVERVIEW.md)** - 系统概述、业务主链：项目→渠道→账户→投手→日报→充值→对账
- **[BACKEND_API_GUIDE.md](./BACKEND_API_GUIDE.md)** - 接口、请求体、响应体、错误码、统一返回结构
- **[DATA_SCHEMA.md](./DATA_SCHEMA.md)** - 所有表结构+字段说明+外键约束+RLS策略
- **[STATE_MACHINE.md](./STATE_MACHINE.md)** - 充值、日报、账户生命周期状态机
- **[DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md)** - Docker、Nginx、环境变量
- **[FRONTEND_GUIDE.md](./FRONTEND_GUIDE.md)** - Next.js 路由结构、角色菜单、API 调用规范

### 1.2 统一返回结构
把统一返回结构提到 API 章节最前面，后面接口不再重复：

**成功响应**:
```json
{
  "success": true,
  "data": {...},
  "message": "操作成功",
  "code": "SUCCESS",
  "request_id": "uuid",
  "timestamp": "2025-11-11T10:30:00Z"
}
```

**失败响应**:
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "参数验证失败"
  },
  "request_id": "uuid",
  "timestamp": "2025-11-11T10:30:00Z"
}
```

### 1.3 优先级标记
- **P0**: 必须上线功能（核心业务流程）
- **P1**: 提高效率功能（报表和自动化）
- **P2**: AI与分析功能（智能预测和异常检测）

---

## 🔧 模块与业务规则优化

### 2.1 状态机标准化
将状态机规则写死成文档：

**充值流程**: `draft → pending → approved → paid → posted → archived`
- 谁能改：投手提交、数据员初审、财务终审
- 不能跳级：必须按顺序流转
- 异常分支：被拒绝→允许修改后重提

**日报流程**: `draft → pending → approved/rejected`
- 谁能改：投手提交、数据员审核
- 必填字段：甲方确认值与差异原因

**账户生命周期**: `new → testing → active → suspended → dead → archived`
- 自动流转：基于消耗和状态
- 人工干预：户管可手动调整

### 2.2 数据完整性约束
- **外键约束**: 所有"钱和消耗"的表必须带外键
  - 必带：`project_id`、`ad_account_id`、`user_id`
  - 校验：写入时必须校验账户是否属于该项目
- **字段规范**:
  - 金额：`NUMERIC(15,2)`
  - 状态：`VARCHAR(20)`
  - 时间戳：所有表加 `created_at`、`updated_at`

### 2.3 权限与安全
- **RLS策略**: 在FastAPI中间件中每次请求都执行
  ```sql
  SELECT set_config('app.current_user_id', '<uuid>', true);
  SELECT set_config('app.current_role', '<role>', true);
  ```
- **权限矩阵**:
  - `media_buyer`（投手）：只看自己被分配的项目/账户/充值/日报
  - `data_clerk`（数据员）：全量读，日报&充值初审
  - `finance`（财务）：充值终审、对账
  - `admin`：全部权限

---

## 📋 开发实施计划

### Phase 1: 核心文档创建 (第1周)
- [ ] 创建SYSTEM_OVERVIEW.md系统概述文档
- [ ] 编写BACKEND_API_GUIDE.md API接口文档
- [ ] 完善DATA_SCHEMA.md数据库设计文档
- [ ] 制定STATE_MACHINE.md状态机规范
- [ ] 编写DEPLOYMENT_GUIDE.md部署指南
- [ ] 创建FRONTEND_GUIDE.md前端开发指南

### Phase 2: 代码结构优化 (第2周)
- [ ] 重组前端目录结构，实现路由分组
- [ ] 规范化组件库和API调用
- [ ] 完善后端分层架构和服务抽象
- [ ] 实现统一的错误处理和日志记录
- [ ] 完成权限控制和RLS策略

### Phase 3: 开发工具配置 (第3周)
- [ ] 配置完整的ESLint和Prettier规则
- [ ] 实现自动化测试框架
- [ ] 建立CI/CD工作流
- [ ] 配置代码质量检查工具
- [ ] 完善开发环境配置

### Phase 4: 监控和优化 (第4周)
- [ ] 集成应用监控和错误追踪
- [ ] 实现性能监控和告警
- [ ] 优化数据库查询和缓存策略
- [ ] 完善日志系统和分析
- [ ] 建立运维手册和故障处理流程

---

## 🎯 功能优先级规划

### P0 - 核心业务功能（必须优先）
- [x] 用户认证和权限系统
- [x] 项目管理和渠道管理
- [x] 广告账户管理
- [x] 日报提交流程
- [x] 充值申请流程
- [ ] 财务对账系统
- [ ] 基础报表功能

### P1 - 效率提升功能
- [ ] 数据导入工具
- [ ] 高级报表和图表
- [ ] 自动化通知系统
- [ ] 渠道质量评分
- [ ] 批量操作功能

### P2 - AI和分析功能
- [ ] AI异常检测
- [ ] 账户寿命预测
- [ ] 智能充值建议
- [ ] 消耗趋势分析
- [ ] ROI优化建议

---

## 📊 技术栈推荐

### 前端技术栈
- **框架**: Next.js 15 + TypeScript + App Router
- **UI库**: shadcn/ui (已集成) + Radix UI + Tailwind CSS
- **图表**: Recharts (已集成)
- **状态管理**: 轻量级用 SWR / React Query
- **表单**: React Hook Form + Zod验证

### 后端技术栈
- **框架**: FastAPI + Python 3.11
- **ORM**: SQLAlchemy (同步版)
- **数据验证**: Pydantic v2
- **认证**: Supabase Auth + JWT
- **任务队列**: RQ + Redis

### 数据库和存储
- **主数据库**: PostgreSQL (Supabase托管)
- **缓存**: Redis
- **文件存储**: Supabase Storage
- **备份**: 自动化备份策略

### 部署和运维
- **容器化**: Docker + Docker Compose
- **反向代理**: Nginx
- **CI/CD**: GitHub Actions
- **监控**: 自建监控面板
- **日志**: 结构化日志收集

---

## ✅ 验收标准

### 开发质量标准
- [ ] 所有核心功能端到端可跑通
- [ ] API响应格式完全统一
- [ ] 前后端类型定义完全匹配
- [ ] 所有操作都有权限验证和审计日志
- [ ] 测试覆盖率达到80%以上

### 文档完整性标准
- [ ] 每个API都有完整的接口文档
- [ ] 数据库表结构有详细说明
- [ ] 部署和运维流程文档化
- [ ] 开发规范和最佳实践文档化
- [ ] 故障处理和应急响应预案

### 性能和安全标准
- [ ] 关键接口响应时间<500ms
- [ ] 前端首屏加载时间<3s
- [ ] 所有用户输入都经过验证和过滤
- [ ] 敏感数据都有加密和权限控制
- [ ] 系统具备基本的防攻击能力

---

**文档版本**: v2.0
**创建日期**: 2025-11-11
**最后更新**: 2025-11-11
**下次审查**: 功能重大变更时
**维护责任人**: 项目架构团队

1. **状态机写死成表**  
   - 充值：draft → pending → approved → paid → posted → archived  
   - 日报：draft → pending → approved/rejected  
   - 账户：new → testing → active → suspended → dead → archived  
   写明：谁能改、能改到哪步、不能跳级。
2. **所有“钱和消耗”的表必须带外键**  
   - 必带：project_id、ad_account_id、user_id  
   - 写入时必须校验账户是否属于该项目。
3. **充值审批增加异常分支**：被拒绝→允许修改后重提；审批超时→提示财务。
4. **日报增加“甲方确认值”与“差异原因”必填规则**，否则对账会断档。
5. **导入任务(import_jobs)与操作日志(logs)单独成节**，避免之后排查无记录。

---

## 3. 数据库与安全优化

1. **字段统一**  
   - 金额：NUMERIC(15,2)  
   - 状态：VARCHAR(20)  
   - 所有表加：created_at、updated_at
2. **外键删除策略**  
   - 明细表（ad_spend_daily、topups、reconciliations）：ON DELETE CASCADE  
   - 基础主体（users、channels）：ON DELETE SET NULL
3. **RLS 落地**  
   - 文档里明确：在 FastAPI 中间件中每次请求都执行  
     ```sql
     SELECT set_config('app.current_user_id', '<uuid>', true);
     SELECT set_config('app.current_role', '<role>', true);
     ```
   - 然后策略才生效。
4. **加分区建议**  
   - ad_spend_daily 按月或按项目分区，避免后期变成大表。

---

## 4. 权限与角色优化

1. **权限矩阵前置**：先说“谁能看谁的”，再给接口。  
   - media_buyer（投手）：只看自己被分配的项目/账户/充值/日报  
   - data_clerk（数据员）：全量读，日报&充值初审  
   - finance（财务）：充值终审、对账  
   - admin：全部
2. **接口层自动注入过滤**：对投手自动加 `assigned_user_id = current_user`，避免前端漏传。
3. **写清楚前端菜单展示规则**：角色→菜单→页面，需要对上权限矩阵。

---

## 5. 后端实现优化

1. **统一同步风格**  
   - FastAPI 可写 async，但数据库建议本期用同步 SQLAlchemy，文档里写清楚“本项目后端采用同步 SQLAlchemy，不混用 async engine”。
2. **事务包装**  
   - 所有“审批+记账+更新账户余额”要放进一个事务装饰器里。  
   - 出错要写日志：模块、操作人、请求id。
3. **统一异常结构**  
   - 成功：
     ```json
     { "success": true, "data": {...}, "message": "ok", "request_id": "..." }
     ```
   - 失败：
     ```json
     { "success": false, "error": { "code": "VALIDATION_ERROR", "message": "xxx" }, "request_id": "..." }
     ```
4. **对账服务抽象成 service**，不要写在路由里，方便后面接AI。

---

## 6. 前端实现优化

1. **API 客户端不要直接在类里用 hook**  
   - `ApiClient` 接收 token，而不是在里面调用 `useAuth()`。
2. **表单字段与后端以服务端为准**  
   - 充值手续费只展示接口返回的，不在前端写死 10%。
3. **角色路由守卫**  
   - 未授权跳 403  
   - 根据角色渲染菜单

---

## 7. 日志与运维优化

1. 每个写操作写一条操作日志：谁、改了哪条记录、从什么到什么。
2. 导入任务写明：来源文件、成功行数、失败行数、失败原因，可重试。
3. 加健康检查与 metrics，方便你后面放监控。

---

## 8. AI/规则引擎优化

1. 第一版用规则：  
   - 日消耗波动 > 前3日均值 × 1.5 → 标红  
   - 账户 3 日无消耗 → 风险  
   - 充值频率异常高 → 标记
2. 第二版再接 sklearn / 小模型，文档里把这句话写死，防止大家以为一开始就要训练模型。

---

## 9. 推荐技术栈

### 9.1 前端
- **Next.js 14 + TypeScript + App Router**
- UI：shadcn/ui 或 Ant Design（二选一，别混）
- 图表：Recharts
- 状态：轻量用 SWR / React Query

### 9.2 后端
- **FastAPI (Python 3.11)**  
- Pydantic v2 做数据校验  
- SQLAlchemy (同步版)  
- Uvicorn/Gunicorn 负责部署

### 9.3 数据库 & 鉴权
- PostgreSQL（Supabase 托管）
- Supabase Auth 做用户表 + 行级安全（RLS）

### 9.4 缓存与任务
- Redis（做导入任务、审批通知、预警）
- 可选 Celery / RQ 做异步

### 9.5 部署
- Docker Compose：web + api + db + redis
- Nginx 反代
- CI/CD 用 GitHub Actions 简单跑 lint + pytest

**为什么这套最合适？**
- 你的文档、接口示例、表结构已经是按 FastAPI + PG 写的，不用重写；
- Python 做财务、对账、AI 都顺手；
- Supabase 能直接给你 auth + storage + RLS，少写一堆权限代码；
- Next.js 能很快做出多角色后台。

---

## 10. 优先级一览

**P0（必须优先做）**
- 项目/渠道/账户 CRUD
- 日报提交流程
- 充值审批流程（含状态机）
- 对账基础统计
- 权限矩阵 + RLS 注入
- 日志表

**P1**
- 报表与看板
- 导入任务
- 渠道质量评分
- 通知/预警

**P2**
- AI 异常检测
- 账户寿命预测
- 多币种试算

---
